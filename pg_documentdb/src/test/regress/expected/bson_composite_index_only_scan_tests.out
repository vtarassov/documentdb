SET search_path TO documentdb_api,documentdb_core,documentdb_api_catalog;
SET documentdb.next_collection_id TO 300;
SET documentdb.next_collection_index_id TO 300;
SELECT COUNT(documentdb_api.insert_one('iosdb', 'iosc', bson_build_document('_id'::text, i, 'a'::text, i))) FROM generate_series(1, 20) i;
NOTICE:  creating collection
 count 
-------
    20
(1 row)

VACUUM (ANALYZE ON, FREEZE ON) documentdb_data.documents_301;
set documentdb.enableIndexOnlyScan to on;
set seq_page_cost to 1000;
set documentdb.forceIndexOnlyScanIfAvailable to on;
SELECT documentdb_test_helpers.run_explain_and_trim($$ EXPLAIN (ANALYZE ON, COSTS OFF, BUFFERS OFF, VERBOSE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_pipeline('iosdb', '{ "aggregate" : "iosc", "pipeline" : [{ "$match" : {"_id": {"$gt": 5 }} }, { "$count": "count" }]}') $$);
                                                                                                  run_explain_and_trim                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate (actual rows=1 loops=1)
   Output: bson_repath_and_build('count'::text, documentdb_api_internal.bsoncount(1))
   ->  Index Only Scan using _id_ on documentdb_data.documents_301 collection (actual rows=15 loops=1)
         Output: collection.shard_key_value, collection.object_id
         Index Cond: ((collection.shard_key_value = '301'::bigint) AND (collection.object_id > '{ "" : { "$numberInt" : "5" } }'::bson) AND (collection.object_id <= '{ "" : { "$numberDouble" : "Infinity" } }'::bson))
         Heap Fetches: 0
(6 rows)

SELECT documentdb_test_helpers.run_explain_and_trim($$ EXPLAIN (ANALYZE ON, COSTS OFF, BUFFERS OFF, VERBOSE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_pipeline('iosdb', '{ "aggregate" : "iosc", "pipeline" : [{ "$match" : {"_id": {"$gt": 5, "$lt": 8 }} }, { "$count": "count" }]}') $$);
                                                                                                                                                                             run_explain_and_trim                                                                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate (actual rows=1 loops=1)
   Output: bson_repath_and_build('count'::text, documentdb_api_internal.bsoncount(1))
   ->  Index Only Scan using _id_ on documentdb_data.documents_301 collection (actual rows=2 loops=1)
         Output: collection.shard_key_value, collection.object_id
         Index Cond: ((collection.shard_key_value = '301'::bigint) AND (collection.object_id > '{ "" : { "$numberInt" : "5" } }'::bson) AND (collection.object_id <= '{ "" : { "$numberDouble" : "Infinity" } }'::bson) AND (collection.object_id < '{ "" : { "$numberInt" : "8" } }'::bson) AND (collection.object_id >= '{ "" : { "$numberDouble" : "-Infinity" } }'::bson))
         Heap Fetches: 0
(6 rows)

SELECT documentdb_test_helpers.run_explain_and_trim($$ EXPLAIN (ANALYZE ON, COSTS OFF, BUFFERS OFF, VERBOSE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_pipeline('iosdb', '{ "aggregate" : "iosc", "pipeline" : [{ "$match" : {"_id": 5 } }, { "$count": "count" }]}') $$);
                                                          run_explain_and_trim                                                           
-----------------------------------------------------------------------------------------------------------------------------------------
 Aggregate (actual rows=1 loops=1)
   Output: bson_repath_and_build('count'::text, documentdb_api_internal.bsoncount(1))
   ->  Index Only Scan using _id_ on documentdb_data.documents_301 collection (actual rows=1 loops=1)
         Output: collection.shard_key_value, collection.object_id
         Index Cond: ((collection.shard_key_value = '301'::bigint) AND (collection.object_id = '{ "" : { "$numberInt" : "5" } }'::bson))
         Heap Fetches: 0
(6 rows)

-- does not work with other filters.
SELECT documentdb_test_helpers.run_explain_and_trim($$ EXPLAIN (ANALYZE ON, COSTS OFF, BUFFERS OFF, VERBOSE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_pipeline('iosdb', '{ "aggregate" : "iosc", "pipeline" : [{ "$match" : {"_id": {"$gt": 5, "$lt": 8 }, "a": { "$lt": { "$maxKey": 1 }}} }, { "$count": "count" }]}') $$);
                                                                                                                                                                             run_explain_and_trim                                                                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate (actual rows=1 loops=1)
   Output: bson_repath_and_build('count'::text, documentdb_api_internal.bsoncount(1))
   ->  Index Scan using _id_ on documentdb_data.documents_301 collection (actual rows=2 loops=1)
         Output: collection.shard_key_value, collection.object_id, collection.document
         Index Cond: ((collection.shard_key_value = '301'::bigint) AND (collection.object_id > '{ "" : { "$numberInt" : "5" } }'::bson) AND (collection.object_id <= '{ "" : { "$numberDouble" : "Infinity" } }'::bson) AND (collection.object_id < '{ "" : { "$numberInt" : "8" } }'::bson) AND (collection.object_id >= '{ "" : { "$numberDouble" : "-Infinity" } }'::bson))
         Filter: (collection.document @< '{ "a" : { "$maxKey" : 1 } }'::bson)
(6 rows)

SELECT documentdb_test_helpers.run_explain_and_trim($$ EXPLAIN (ANALYZE ON, COSTS OFF, BUFFERS OFF, VERBOSE ON, TIMING OFF, SUMMARY OFF) SELECT document FROM bson_aggregation_pipeline('iosdb', '{ "aggregate" : "iosc", "pipeline" : [{ "$match" : {"_id": {"$gt": 5, "$lt": 8 }, "_id": { "$size": 5 }} }, { "$count": "count" }]}') $$);
                                                                                                                                                                             run_explain_and_trim                                                                                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Aggregate (actual rows=1 loops=1)
   Output: bson_repath_and_build('count'::text, documentdb_api_internal.bsoncount(1))
   ->  Index Scan using _id_ on documentdb_data.documents_301 collection (actual rows=0 loops=1)
         Output: collection.shard_key_value, collection.object_id, collection.document
         Index Cond: ((collection.shard_key_value = '301'::bigint) AND (collection.object_id > '{ "" : { "$numberInt" : "5" } }'::bson) AND (collection.object_id <= '{ "" : { "$numberDouble" : "Infinity" } }'::bson) AND (collection.object_id < '{ "" : { "$numberInt" : "8" } }'::bson) AND (collection.object_id >= '{ "" : { "$numberDouble" : "-Infinity" } }'::bson))
         Filter: (collection.document @@# '{ "_id" : { "$numberInt" : "5" } }'::bson)
         Rows Removed by Filter: 2
(7 rows)

