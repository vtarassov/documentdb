SET search_path TO documentdb_core,documentdb_api,documentdb_api_catalog,documentdb_api_internal;
SET citus.next_shard_id TO 5800000;
SET documentdb.next_collection_id TO 5800;
SET documentdb.next_collection_index_id TO 5800;
-- $ifNull: should return first not null
SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": ["not null", null]}}');
    bson_dollar_project    
---------------------------------------------------------------------
 { "result" : "not null" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": [null, "not null", null]}}');
    bson_dollar_project    
---------------------------------------------------------------------
 { "result" : "not null" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": [null, null, "not null"]}}');
    bson_dollar_project    
---------------------------------------------------------------------
 { "result" : "not null" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": [{"$arrayElemAt": [[1], 2]}, "not null", null]}}');
    bson_dollar_project    
---------------------------------------------------------------------
 { "result" : "not null" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": [null, "$a", "not null", null]}}');
    bson_dollar_project    
---------------------------------------------------------------------
 { "result" : "not null" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": [null, "$a", {"$add":[1,2]}, null]}}');
          bson_dollar_project          
---------------------------------------------------------------------
 { "result" : { "$numberInt" : "3" } }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": [null, "$a", [1, 2, {"$add":[1,2]}], null]}}');
                                    bson_dollar_project                                    
---------------------------------------------------------------------
 { "result" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" } ] }
(1 row)

SELECT * FROM bson_dollar_project('{"b": 2}', '{"result": {"$ifNull": [null, "$a", "$b", null]}}');
          bson_dollar_project          
---------------------------------------------------------------------
 { "result" : { "$numberInt" : "2" } }
(1 row)

-- $ifNull: should not return result if last expression is undefined field or an expression with no result
SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": [null, "$a", "$b"]}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": [null, null, {"$arrayElemAt": [[1], 2]}]}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { }
(1 row)

-- $ifNull: should have at least 2 arguments
SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": {}}}');
ERROR:  Expression $ifNull requires at least two provided arguments, but received only 1.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": "string"}}');
ERROR:  Expression $ifNull requires at least two provided arguments, but received only 1.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": false}}');
ERROR:  Expression $ifNull requires at least two provided arguments, but received only 1.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": []}}');
ERROR:  Expression $ifNull requires at least two provided arguments, but received only 0.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": [null]}}');
ERROR:  Expression $ifNull requires at least two provided arguments, but received only 1.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": [{"$divide": [1, 0]}]}}');
ERROR:  Expression $ifNull requires at least two provided arguments, but received only 1.
-- $ifNull: should honor nested expression errors, even if a not null expression is found
SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": [null, "not null", {"$divide": [1, 0]}]}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{}', '{"result": {"$ifNull": [null, "not null", {"$ifNull": [1]}]}}');
ERROR:  Expression $ifNull requires at least two provided arguments, but received only 1.
-- $cond: returns then when condition is true
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": [true, "then", "else"]}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": [{"$gt": [3, 2]}, "then", "else"]}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": [{"$lt": [2, 3]}, "then", "else"]}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{"b": true}', '{"result": {"$cond": ["$b", "then", "else"]}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": true, "then": "then", "else": "else"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": true, "else": "else", "then": "then" }}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"then": "then", "if": true, "else": "else"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"else": "else", "if": true, "then": "then"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": {"$gt": [3, 2]}, "then": "then", "else": "else"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": {"$lt": [2, 3]}, "then": "then", "else": "else"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{"b": true}', '{"result": {"$cond": {"if": "$b", "then": "then", "else": "else"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

-- $cond: returns else when condition is false
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": [false, "then", "else"]}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": [{"$gt": [3, 3]}, "then", "else"]}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": [{"$lt": [3, 3]}, "then", "else"]}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

SELECT * FROM bson_dollar_project('{"b": false}', '{"result": {"$cond": ["$b", "then", "else"]}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

SELECT * FROM bson_dollar_project('{"b": false}', '{"result": {"$cond": ["$b", "then", {"$add": [1, 2]}]}}');
          bson_dollar_project          
---------------------------------------------------------------------
 { "result" : { "$numberInt" : "3" } }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": false, "then": "then", "else": "else"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": {"$gt": [3, 3]}, "then": "then", "else": "else"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": {"$lt": [3, 3]}, "then": "then", "else": "else"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

SELECT * FROM bson_dollar_project('{"b": false}', '{"result": {"$cond": {"if": "$b", "then": "then", "else": "else"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

SELECT * FROM bson_dollar_project('{"b": false}', '{"result": {"$cond": {"if": "$b", "then": "then", "else": [1, 2, {"$add": [1, 2]}]}}}');
                                    bson_dollar_project                                    
---------------------------------------------------------------------
 { "result" : [ { "$numberInt" : "1" }, { "$numberInt" : "2" }, { "$numberInt" : "3" } ] }
(1 row)

-- $cond: null/undefined conditions should evaluate to false and return else
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": [null, "then", "else"]}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": ["$a", "then", "else"]}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": null, "then": "then", "else": "else"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": "$a", "then": "then", "else": "else"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

-- $cond: returns no result when the returned expression is an undefined field or an expression with no result
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": false, "then": "then", "else": "$a"}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": {"$gt": [3, 3]}, "then": "then", "else": {"$ifNull": [null, null, {"$arrayElemAt": [[1], 2]}]}}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { }
(1 row)

-- $cond: if is required
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"then": "then", "else": "$a"}}}');
ERROR:  'if' parameter is missing in the $cond operator
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"else": "else", "then": "$a"}}}');
ERROR:  'if' parameter is missing in the $cond operator
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"else": "else"}}}');
ERROR:  'if' parameter is missing in the $cond operator
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {}}}');
ERROR:  'if' parameter is missing in the $cond operator
-- $cond: then is required
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": "if", "else": "$a"}}}');
ERROR:  'then' parameter is missing in the $cond operator
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"else": "else", "if": "$a"}}}');
ERROR:  'then' parameter is missing in the $cond operator
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": "$a"}}}');
ERROR:  'then' parameter is missing in the $cond operator
-- $cond: else is required
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": "if", "then": "$a"}}}');
ERROR:  'else' parameter is missing in the $cond operator
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"then": "then", "if": "$a"}}}');
ERROR:  'else' parameter is missing in the $cond operator
-- $cond: unknown argument
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": false, "then": "then", "else": "$a", "foo": "blah"}}}');
ERROR:  Unrecognized argument provided to operators $cond: foo
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"foo": "blah"}}}');
ERROR:  Unrecognized argument provided to operators $cond: foo
-- $cond: requires 3 arguments error
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": [false, "else"]}}');
ERROR:  The expression $cond requires exactly 3 arguments, but 2 arguments were actually provided.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": []}}');
ERROR:  The expression $cond requires exactly 3 arguments, but 0 arguments were actually provided.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": [true, true, true, true, true]}}');
ERROR:  The expression $cond requires exactly 3 arguments, but 5 arguments were actually provided.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": "str"}}');
ERROR:  The expression $cond requires exactly 3 arguments, but 1 arguments were actually provided.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": true}}');
ERROR:  The expression $cond requires exactly 3 arguments, but 1 arguments were actually provided.
-- $cond: nested expression errors honored even if result is not affected by it
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": [false, {"$divide": [1, 0]}, "else"]}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": [true, "then", {"$divide": [1, 0]}]}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": false, "then": {"$divide": [1, 0]}, "else": "else"}}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$divide": [1, 0]}}}}');
ERROR:  $divide by zero is not allowed
-- $switch: returns expected branch
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": true, "then": "first branch is true"}]}}}');
          bson_dollar_project          
---------------------------------------------------------------------
 { "result" : "first branch is true" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": "first branch is true"}, {"case": true, "then": "second branch is true"}]}}}');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : "second branch is true" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 1, "b": 2}', '{"result": {"$switch": {"branches": [{"case": {"$gt": ["$a", "$b"]}, "then": "a > b"}, {"case": {"$lt": ["$a", "$b"]}, "then": "a < b"}]}}}');
  bson_dollar_project   
---------------------------------------------------------------------
 { "result" : "a < b" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 3, "b": 2}', '{"result": {"$switch": {"branches": [{"case": {"$gt": ["$a", "$b"]}, "then": "a > b"}, {"case": {"$lt": ["$a", "$b"]}, "then": "a < b"}], "default": "a = b"}}}');
  bson_dollar_project   
---------------------------------------------------------------------
 { "result" : "a > b" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 2, "b": 2}', '{"result": {"$switch": {"branches": [{"case": {"$gt": ["$a", "$b"]}, "then": "a > b"}, {"case": {"$not": {"$eq": ["$a", "$b"]}}, "then": "a != b"}], "default": "a = b"}}}');
  bson_dollar_project   
---------------------------------------------------------------------
 { "result" : "a = b" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 0, "b": 2}', '{"result": {"$switch": {"branches": [{"case": {"$gt": ["$a", "$b"]}, "then": "a > b"}, {"case": {"$not": {"$eq": ["$a", "$b"]}}, "then": "a != b"}], "default": "a = b"}}}');
   bson_dollar_project   
---------------------------------------------------------------------
 { "result" : "a != b" }
(1 row)

-- $switch: null/undefined should evaluate to false
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": null, "then": "first branch is true"}], "default": "it was false"}}}');
      bson_dollar_project      
---------------------------------------------------------------------
 { "result" : "it was false" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": "$a", "then": "first branch is true"}], "default": "it was false"}}}');
      bson_dollar_project      
---------------------------------------------------------------------
 { "result" : "it was false" }
(1 row)

-- $switch: shouldn't return result if resulting expression is undefined field or expression with undef result
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": true, "then": "$b"}]}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": true, "then": {"$arrayElemAt": [[1], 2]}}]}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": ""}], "default": {"$arrayElemAt": [[1], 2]}}}}');
 bson_dollar_project 
---------------------------------------------------------------------
 { }
(1 row)

-- $switch: requires object argument
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": []}}');
ERROR:  The $switch expression requires an object as its argument, but instead received: array
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": true}}');
ERROR:  The $switch expression requires an object as its argument, but instead received: bool
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": "Str"}}');
ERROR:  The $switch expression requires an object as its argument, but instead received: string
-- $switch: branches must be an array
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": {}}}}');
ERROR:  $switch requires an array for 'branches', but received: object
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": "true"}}}');
ERROR:  $switch requires an array for 'branches', but received: string
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": false}}}');
ERROR:  $switch requires an array for 'branches', but received: bool
-- $switch: found an unknown argument
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [], "foo": "blah"}}}');
ERROR:  Unknown argument: foo
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"foo": "blah", "branches": {}}}}');
ERROR:  Unknown argument: foo
-- $switch: requires at least one branch
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": []}}}');
ERROR:  $switch must contain at least one branch.
-- $switch: default is required only when there is no matching branch
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": "$b"}]}}}');
ERROR:  The $switch operator failed to locate a matching branch for the provided input, and no default branch was defined.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": "$b"}, {"case": null, "then": "it is null"}]}}}');
ERROR:  The $switch operator failed to locate a matching branch for the provided input, and no default branch was defined.
-- $switch: found unknown argument to a branch
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": "$b"}, {"foo": "blah"}]}}}');
ERROR:  $switch encountered an unrecognized argument for a branch: foo
-- $switch: branch requires a case expression
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": "$b"}, {"then": "blah"}]}}}');
ERROR:  The $switch requires that every branch must contain a valid 'case' expression.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": "$b"}, {}]}}}');
ERROR:  The $switch requires that every branch must contain a valid 'case' expression.
-- $switch: branch requires a then expression
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": "$b"}, {"case": "blah"}]}}}');
ERROR:  The $switch requires that every branch must contain a valid 'then' expression.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false}]}}}');
ERROR:  The $switch requires that every branch must contain a valid 'then' expression.
-- Fails for constant error expressions
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": true, "then": "first branch is true"}, {"case": false, "then": {"$ifNull": []}}]}}}');
ERROR:  Expression $ifNull requires at least two provided arguments, but received only 0.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": true, "then": "first branch is true"}, {"case": false, "then": "false"}], "default": {"$ifNull": []}}}}');
ERROR:  Expression $ifNull requires at least two provided arguments, but received only 0.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": "first branch is true"}, {"case": false, "then": "false"}], "default": {"$ifNull": []}}}}');
ERROR:  Expression $ifNull requires at least two provided arguments, but received only 0.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": true, "then": "first branch is true"}, {"case": {"$divide": [1, 0]}, "then": "false"}], "default": {"$ifNull": []}}}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": "first branch is true"}, {"case": {"$divide": [1, 0]}, "then": "false"}], "default": {"$ifNull": []}}}}');
ERROR:  $divide by zero is not allowed
-- Fail for non-constant error branch expressions (eg: paths) if that branch is matched
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$switch": {"branches": [{"case": false, "then": "first branch is true"}, {"case": true, "then": {"$divide": [1, "$a"]}}]}}}');
ERROR:  $divide by zero is not allowed
-- Does not fail for non-constant error expressions (eg: paths) if a valid branch is found 
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$switch": {"branches": [{"case": true, "then": "first branch is true"}, {"case": false, "then": {"$divide": [1, "$a"]}}]}}}');
          bson_dollar_project          
---------------------------------------------------------------------
 { "result" : "first branch is true" }
(1 row)

-- Does not fail for non-constant branch error expressions (eg: paths) if the default expression is matched.
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$switch": {"branches": [{"case": false, "then": "first branch is true"}, {"case": false, "then": {"$divide": [1, "$a"]}}], "default": "I am the default"}}}');
        bson_dollar_project        
---------------------------------------------------------------------
 { "result" : "I am the default" }
(1 row)

-- short-circuit for non-constant expressions
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": true, "then": "then", "else": "$a"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$divide": [1, "$a"]}}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$divide": ["$a", 0]}}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": {"$subtract": [1, "$a"]}, "else": {"$divide": [1, "$a"]}}}}');
          bson_dollar_project          
---------------------------------------------------------------------
 { "result" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$range": [0, { "$arrayElemAt": [[], 0] } ]}   }}}');
ERROR:  $range expression needs a numeric ending value, but a value of type missing was provided
SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$range": [0, { "$arrayElemAt": ["$b", 0] } ]}   }}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": false, "then": "$a", "else": "else"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

-- short-circuit test with all cases constant false and default (constant and non-constant)
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": "first"}, {"case": false, "then": "second"}], "default": "default value"}}}');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "default value" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 5}', '{"result": {"$switch": {"branches": [{"case": false, "then": "first"}, {"case": false, "then": "second"}], "default": {"$add": ["$a", 10]}}}}');
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : { "$numberInt" : "15" } }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": {"$divide": [1, 0]}}, {"case": false, "then": "second"}], "default": "default value"}}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$switch": {"branches": [{"case": false, "then": {"$divide": [1, "$a"]}}, {"case": false, "then": "second"}], "default": "default value"}}}');
      bson_dollar_project       
---------------------------------------------------------------------
 { "result" : "default value" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": "first"}, {"case": true, "then": "second"}], "default": {"$divide": [1, 1]}}}}');
   bson_dollar_project   
---------------------------------------------------------------------
 { "result" : "second" }
(1 row)

-- enforce case order: only select a branch if branches above are all false irrespective of constant or not
SELECT * FROM bson_dollar_project('{"a": true}', '{"result": {"$switch": {"branches": [{"case": "$a", "then": "first"}, {"case": false, "then": "second"}, {"case": true, "then": "third"}]}}}');
  bson_dollar_project   
---------------------------------------------------------------------
 { "result" : "first" }
(1 row)

-- error: in constant evaluation
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$divide": [1, 0]}}}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": false, "then": {"$divide": [1, 0]}, "else": "else" }}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": {"$divide": [1, 0]}, "else": {"$divide": [1, 0]} }}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$cond": {"if": false, "then": "then", "else": {"$range": [0, { "$arrayElemAt": [[], 0] } ]}   }}}');
ERROR:  $range expression needs a numeric ending value, but a value of type missing was provided
SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$cond": {"if": false, "then": "then", "else": {"$range": [{ "$arrayElemAt": [[], 0] }, 10 ]}   }}}');
ERROR:  $range expression requires a numeric start value but encountered a value of type: missing
SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$cond": {"if": false, "then": "then", "else": {"$range": [0, 2, { "$arrayElemAt": [[], 0] }]}   }}}');
ERROR:  Expression $range needs a numeric step value, but received a value of type: missing
-- no error: short-circuit
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$divide": [1, "$a"]}}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": false, "then": {"$divide": [1, "$a"]}, "else": "else" }}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": {"$divide": [1, 1]}, "else": {"$divide": [1, "$a"]} }}}');
            bson_dollar_project             
---------------------------------------------------------------------
 { "result" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM bson_dollar_project('{"a": []}', '{"result": {"$cond": {"if": false, "then": {"$arrayElemAt": ["$a", 0]}, "else": {"$divide": [1, 1]} }}}');
            bson_dollar_project             
---------------------------------------------------------------------
 { "result" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": {"$subtract": [1, "$a"]}, "else": {"$divide": [1, "$a"]}}}}');
          bson_dollar_project          
---------------------------------------------------------------------
 { "result" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$range": [0, { "$arrayElemAt": ["$b", 0] } ]}   }}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

-- TODO: must fail for undefined variables
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$divide": [1, "$$a"]}}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$range": [0, { "$arrayElemAt": ["$$b", 0] } ]}   }}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

-- $switch
-- error: short-circuit for constant expressions
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": true, "then": "first branch is true"}, {"case": {"$divide": [1, 0]}, "then": "false"}]}}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": "first branch is true"}, {"case": {"$divide": [1, 0]}, "then": "false"}], "default": "I am the default"}}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": false, "then": "first branch is true"}, {"case": false, "then": "false"}], "default": {"$divide": [1, 0]}}}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": true, "then": "first branch is true"}, {"case": true, "then": {"$ifNull": []}}]}}}');
ERROR:  Expression $ifNull requires at least two provided arguments, but received only 0.
SELECT * FROM bson_dollar_project('{}', '{"result": {"$switch": {"branches": [{"case": true, "then": "first branch is true"}, {"case": true, "then": {"$range": {"$arrayElemAt": [[], 0]}}}], "default": "I am the default"}}}');
ERROR:  The expression $range requires no fewer than 2 arguments and no more than 3 arguments, but 1 arguments were actually provided.
-- no error: short-circuit (constant evaluation after parse time)
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$switch": {"branches": [{"case": true, "then": "first branch is true"}, {"case": false, "then": "false"}], "default": {"$divide": [1, "$a"]}}}}');
          bson_dollar_project          
---------------------------------------------------------------------
 { "result" : "first branch is true" }
(1 row)

SELECT * FROM bson_dollar_project(
  '{"a": 0}',
  '{"result": {
      "$switch": {
        "branches": [
          { "case": false, "then": { "$range": [{ "$arrayElemAt": ["$a", 0] }, 10] } },
          { "case": true,  "then": "second branch is true" }
        ],
        "default": "I am the default"
      }
    }}'
);
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : "second branch is true" }
(1 row)

SELECT * FROM bson_dollar_project(
  '{"a": 0}',
  '{"result": {
      "$switch": {
        "branches": [
          { "case": false, "then": { "$divide": [1, "$a"] } },
          { "case": true,  "then": "second branch is true" }
        ],
        "default": "I am the default"
      }
    }}'
);
          bson_dollar_project           
---------------------------------------------------------------------
 { "result" : "second branch is true" }
(1 row)

SELECT * FROM bson_dollar_project(
  '{"a": []}',
  '{"result": {
      "$switch": {
        "branches": [
          {
            "case": { "$and": [ { "$gt": [5, 0] }, { "$lt": [5, 10] } ] },
            "then": "first branch is true"
          },
          {
            "case": true,
            "then": { "$range": [{ "$arrayElemAt": ["$a", 0] }, 10] }
          }
        ],
        "default": "I am the default"
      }
    }}'
);
          bson_dollar_project          
---------------------------------------------------------------------
 { "result" : "first branch is true" }
(1 row)

-- $cond
-- short-circuit for non-constant expressions
SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": true, "then": "then", "else": "$a"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$divide": [1, "$a"]}}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$divide": ["$a", 0]}}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": {"$subtract": [1, "$a"]}, "else": {"$divide": [1, "$a"]}}}}');
          bson_dollar_project          
---------------------------------------------------------------------
 { "result" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$range": [0, { "$arrayElemAt": [[], 0] } ]}   }}}');
ERROR:  $range expression needs a numeric ending value, but a value of type missing was provided
SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$range": [0, { "$arrayElemAt": ["$b", 0] } ]}   }}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{}', '{"result": {"$cond": {"if": false, "then": "$a", "else": "else"}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

-- error: in constant evaluation
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$divide": [1, 0]}}}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": false, "then": {"$divide": [1, 0]}, "else": "else" }}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": {"$divide": [1, 0]}, "else": {"$divide": [1, 0]} }}}');
ERROR:  $divide by zero is not allowed
SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$cond": {"if": false, "then": "then", "else": {"$range": [0, { "$arrayElemAt": [[], 0] } ]}   }}}');
ERROR:  $range expression needs a numeric ending value, but a value of type missing was provided
SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$cond": {"if": false, "then": "then", "else": {"$range": [{ "$arrayElemAt": [[], 0] }, 10 ]}   }}}');
ERROR:  $range expression requires a numeric start value but encountered a value of type: missing
SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$cond": {"if": false, "then": "then", "else": {"$range": [0, 2, { "$arrayElemAt": [[], 0] }]}   }}}');
ERROR:  Expression $range needs a numeric step value, but received a value of type: missing
-- no error: short-circuit
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$divide": [1, "$a"]}}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": false, "then": {"$divide": [1, "$a"]}, "else": "else" }}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "else" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": {"$divide": [1, 1]}, "else": {"$divide": [1, "$a"]} }}}');
            bson_dollar_project             
---------------------------------------------------------------------
 { "result" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM bson_dollar_project('{"a": []}', '{"result": {"$cond": {"if": false, "then": {"$arrayElemAt": ["$a", 0]}, "else": {"$divide": [1, 1]} }}}');
            bson_dollar_project             
---------------------------------------------------------------------
 { "result" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": {"$subtract": [1, "$a"]}, "else": {"$divide": [1, "$a"]}}}}');
          bson_dollar_project          
---------------------------------------------------------------------
 { "result" : { "$numberInt" : "1" } }
(1 row)

SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$range": [0, { "$arrayElemAt": ["$b", 0] } ]}   }}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

-- TODO: must fail for undefined variables
SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$divide": [1, "$$a"]}}}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$cond": {"if": true, "then": "then", "else": {"$range": [0, { "$arrayElemAt": ["$$b", 0] } ]}   }}}');
  bson_dollar_project  
---------------------------------------------------------------------
 { "result" : "then" }
(1 row)

SELECT * FROM bson_dollar_project('{"a": 0}', '{"result": {"$switch": {"branches": [{"case": true, "then": "first branch is true"}, {"case": false, "then": {"$divide": [1, "$$a"]}}]}}}');
          bson_dollar_project          
---------------------------------------------------------------------
 { "result" : "first branch is true" }
(1 row)

SELECT * FROM bson_dollar_project('{"b": []}', '{"result": {"$switch": {"branches": [{"case": false, "then": "first branch is true"}, {"case": false, "then": {"$range": [0, { "$arrayElemAt": ["$$b", 0] } ]}   }], "default": "I am the default"}}}');
        bson_dollar_project        
---------------------------------------------------------------------
 { "result" : "I am the default" }
(1 row)

