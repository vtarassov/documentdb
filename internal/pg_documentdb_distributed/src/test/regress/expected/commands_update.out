SET search_path TO documentdb_core,documentdb_api,documentdb_api_catalog,documentdb_api_internal;
SET citus.next_shard_id TO 649000;
SET documentdb.next_collection_id TO 6490;
SET documentdb.next_collection_index_id TO 6490;
SET documentdb.EnableVariablesSupportForWriteCommands TO on;
select 1 from documentdb_api.insert_one('db', 'updateme', '{"a":1,"_id":1,"b":1}');
NOTICE:  creating collection
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

select 1 from documentdb_api.insert_one('db', 'updateme', '{"a":2,"_id":2,"b":2}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

select 1 from documentdb_api.insert_one('db', 'updateme', '{"a":3,"_id":3,"b":3}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

select 1 from documentdb_api.insert_one('db', 'updateme', '{"a":4,"_id":4,"b":4}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

select 1 from documentdb_api.insert_one('db', 'updateme', '{"a":5,"_id":5,"b":5}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

select 1 from documentdb_api.insert_one('db', 'updateme', '{"a":6,"_id":6,"b":6}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

select 1 from documentdb_api.insert_one('db', 'updateme', '{"a":7,"_id":7,"b":7}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

select 1 from documentdb_api.insert_one('db', 'updateme', '{"a":8,"_id":8,"b":8}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

select 1 from documentdb_api.insert_one('db', 'updateme', '{"a":9,"_id":9,"b":9}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

select 1 from documentdb_api.insert_one('db', 'updateme', '{"a":10,"_id":10,"b":10}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

-- exercise invalid update syntax errors
select documentdb_api.update('db', NULL);
ERROR:  update document cannot be NULL
select documentdb_api.update(NULL, '{"update":"updateme", "updates":[{"q":{},"u":{"$set":{"b":0}},"multi":true}]}');
ERROR:  database name cannot be NULL
select documentdb_api.update('db', '{"updates":[{"q":{},"u":{"$set":{"b":0}},"multi":true}]}');
ERROR:  Required field 'update.update' is missing
select documentdb_api.update('db', '{"update":"updateme"}');
ERROR:  BSON field 'update.updates' is missing but is a required field
select documentdb_api.update('db', '{"update":["updateme"], "updates":[{"q":{},"u":{"$set":{"b":0}},"multi":true}]}');
ERROR:  collection name has invalid type array
select documentdb_api.update('db', '{"update":"updateme", "updates":{"q":{},"u":{"$set":{"b":0}},"multi":true}}');
ERROR:  The BSON field 'update.updates' has an incorrect type 'object'; it should be of type 'array'.
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{},"u":{"$set":{"b":0}},"multi":true}], "extra":1}');
ERROR:  The BSON field 'update.extra' is not recognized as a valid field
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{}}]}');
ERROR:  The required field 'update.updates.u' is missing
CONTEXT:  SQL statement " SELECT documentdb_api_internal.update_worker($1, $2, $3, $4::documentdb_core.bson, $5::documentdb_core.bsonsequence, $6) FROM documentdb_data.documents_6490 WHERE shard_key_value = 6490"
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{},"multi":true}]}');
ERROR:  The required field 'update.updates.u' is missing
CONTEXT:  SQL statement " SELECT documentdb_api_internal.update_worker($1, $2, $3, $4::documentdb_core.bson, $5::documentdb_core.bsonsequence, $6) FROM documentdb_data.documents_6490 WHERE shard_key_value = 6490"
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"multi":true}]}');
ERROR:  The required field 'update.updates.q' is missing
CONTEXT:  SQL statement " SELECT documentdb_api_internal.update_worker($1, $2, $3, $4::documentdb_core.bson, $5::documentdb_core.bsonsequence, $6) FROM documentdb_data.documents_6490 WHERE shard_key_value = 6490"
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"u":{"$set":{"b":0}}}]}');
ERROR:  The required field 'update.updates.q' is missing
CONTEXT:  SQL statement " SELECT documentdb_api_internal.update_worker($1, $2, $3, $4::documentdb_core.bson, $5::documentdb_core.bsonsequence, $6) FROM documentdb_data.documents_6490 WHERE shard_key_value = 6490"
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{},"u":"text"}]}');
ERROR:  BSON field 'update.updates.u' is the wrong type 'string', expected type 'object' or 'array'
CONTEXT:  SQL statement " SELECT documentdb_api_internal.update_worker($1, $2, $3, $4::documentdb_core.bson, $5::documentdb_core.bsonsequence, $6) FROM documentdb_data.documents_6490 WHERE shard_key_value = 6490"
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":[],"u":{"$set":{"b":0}},"multi":true}]}');
ERROR:  The BSON field 'update.updates.q' has an incorrect type 'array'; it should be of type 'object'.
CONTEXT:  SQL statement " SELECT documentdb_api_internal.update_worker($1, $2, $3, $4::documentdb_core.bson, $5::documentdb_core.bsonsequence, $6) FROM documentdb_data.documents_6490 WHERE shard_key_value = 6490"
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{},"u":{"$set":{"b":0}},"multi":1}]}');
ERROR:  The BSON field 'update.updates.multi' has an incorrect type 'int'; it should be of type 'bool'.
CONTEXT:  SQL statement " SELECT documentdb_api_internal.update_worker($1, $2, $3, $4::documentdb_core.bson, $5::documentdb_core.bsonsequence, $6) FROM documentdb_data.documents_6490 WHERE shard_key_value = 6490"
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{},"u":{"$set":{"b":0}},"multi":true,"extra":1}]}');
ERROR:  The field 'update.updates.extra' specified is not recognized as a valid field
CONTEXT:  SQL statement " SELECT documentdb_api_internal.update_worker($1, $2, $3, $4::documentdb_core.bson, $5::documentdb_core.bsonsequence, $6) FROM documentdb_data.documents_6490 WHERE shard_key_value = 6490"
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{},"u":{"$set":{"b":0}},"multi":true}],"ordered":1}');
ERROR:  The BSON field 'update.ordered' has an incorrect type 'int'; it should be of type 'bool'.
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{},"u":{"$bork":{"b":0}},"multi":true}]}');
                                                                                                                                                                                     update                                                                                                                                                                                      
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50331677"" }, ""errmsg"" : ""Unknown modifier: $bork. Please use a valid update modifier or pipeline-style update specified as an array"" } ] }",f)
(1 row)

select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{},"u":{"$set":{"b":0}},"upsert":[]}]}');
ERROR:  The BSON field 'update.updates.upsert' has an incorrect type 'array'; it should be of type 'bool'.
CONTEXT:  SQL statement " SELECT documentdb_api_internal.update_worker($1, $2, $3, $4::documentdb_core.bson, $5::documentdb_core.bsonsequence, $6) FROM documentdb_data.documents_6490 WHERE shard_key_value = 6490"
-- Disallow writes to system.views
select documentdb_api.update('db', '{"update":"system.views", "updates":[{"q":{},"u":{"$set":{"b":0}}}]}');
ERROR:  Unable to write data to specified location db.system.views
-- update all
begin;
SET LOCAL search_path TO '';
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{},"u":{"$set":{"b":0}},"multi":true}]}');
                                                                update                                                                
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""10"" }, ""n"" : { ""$numberInt"" : ""10"" } }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document OPERATOR(documentdb_api_catalog.@@) '{"b":0}';
 count 
---------------------------------------------------------------------
    10
(1 row)

rollback;
-- update some
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":{"$lte":3}},"u":{"$set":{"b":0}},"multi":true}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""3"" }, ""n"" : { ""$numberInt"" : ""3"" } }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"b":0}';
 count 
---------------------------------------------------------------------
     3
(1 row)

rollback;
-- update multi with a replace is not supported
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":{"$lte":3}},"u":{"b":0},"multi":true}]}');
                                                                                                                                                                    update                                                                                                                                                                     
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50331677"" }, ""errmsg"" : ""multi=true and replace-style updates cannot be used together."" } ] }",f)
(1 row)

rollback;
-- update multi with an aggregation pipeline is supported
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":{"$lte":3}},"u":[{"$unset":["b"]}],"multi":true}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""3"" }, ""n"" : { ""$numberInt"" : ""3"" } }",t)
(1 row)

rollback;
-- update all from non-existent collection
select documentdb_api.update('db', '{"update":"notexists", "updates":[{"q":{},"u":{"$set":{"b":0}}}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

-- query syntax errors are added the response
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":{"$ltr":5}},"u":{"$set":{"b":0}},"multi":true}]}');
                                                                                                                                           update                                                                                                                                            
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""16777245"" }, ""errmsg"" : ""unknown operator: $ltr"" } ] }",f)
(1 row)

-- when ordered, expect only first update to be executed
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":1},"u":{"$set":{"b":0}}},{"q":{"$a":2},"u":{"$set":{"b":0}}},{"q":{"a":3},"u":{"$set":{"b":0}}}]}');
                                                                                                                                                                                               update                                                                                                                                                                                                
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""1"" }, ""code"" : { ""$numberInt"" : ""16777245"" }, ""errmsg"" : ""unknown top level operator: $a. If you have a field name that starts with a '$' symbol, consider using $getField or $setField."" } ] }",f)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"b":0}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":1},"u":{"$set":{"b":0}}},{"q":{"$a":2},"u":{"$set":{"b":0}}},{"q":{"a":3},"u":{"$set":{"b":0}}}],"ordered":true}');
                                                                                                                                                                                               update                                                                                                                                                                                                
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""1"" }, ""code"" : { ""$numberInt"" : ""16777245"" }, ""errmsg"" : ""unknown top level operator: $a. If you have a field name that starts with a '$' symbol, consider using $getField or $setField."" } ] }",f)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"b":0}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- when not ordered, expect first and last update to be executed
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":1},"u":{"$set":{"b":0}}},{"q":{"$a":2},"u":{"$set":{"b":0}}},{"q":{"a":3},"u":{"$set":{"b":0}}}],"ordered":false}');
                                                                                                                                                                                               update                                                                                                                                                                                                
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""2"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""1"" }, ""code"" : { ""$numberInt"" : ""16777245"" }, ""errmsg"" : ""unknown top level operator: $a. If you have a field name that starts with a '$' symbol, consider using $getField or $setField."" } ] }",f)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme');
 count 
---------------------------------------------------------------------
    10
(1 row)

rollback;
-- update 1 without filters is supported for unsharded collections
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{},"u":{"$set":{"b":0}},"multi":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"b":0}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- update 1 with a replace that preserves the _id
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":3},"u":{"b":0},"multi":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select document from documentdb_api.collection('db', 'updateme') where document @@ '{"b":0}';
                             document                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "0" } }
(1 row)

rollback;
-- update 1 with a replace that tries to change the _id
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":3},"u":{"_id":0,"b":0},"multi":false}]}');
                                                                                                                                                          update                                                                                                                                                          
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""486539293"" }, ""errmsg"" : ""Cannot modify '_id' field as part of the operation"" } ] }",f)
(1 row)

rollback;
-- update 1 is retryable on unsharded collection (second call is a noop)
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":1},"u":{"$inc":{"b":1}},"multi":false}]}', NULL, 'xact-1');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":1},"u":{"$inc":{"b":1}},"multi":false}]}', NULL, 'xact-1');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select document from documentdb_api.collection('db', 'updateme') where document @@ '{"a":1}';
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "2" } }
(1 row)

-- third call is considered a new try
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":1},"u":{"$inc":{"b":1}},"multi":false}]}', NULL, 'xact-1');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select document from documentdb_api.collection('db', 'updateme') where document @@ '{"a":1}';
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "3" } }
(1 row)

rollback;
-- update 1 is supported in the _id case
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":6},"u":{"$set":{"b":0}},"multi":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select document from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":6}';
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "$numberInt" : "6" }, "b" : { "$numberInt" : "0" } }
(1 row)

rollback;
-- update 1 is supported in the multiple identical _id case
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"$and":[{"_id":6},{"_id":6}]},"u":{"$set":{"b":0}},"multi":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select document from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":6}';
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "$numberInt" : "6" }, "b" : { "$numberInt" : "0" } }
(1 row)

rollback;
-- update 1 is supported in the multiple distinct _id case
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"$and":[{"_id":6},{"_id":5}]},"u":{"$set":{"b":0}},"multi":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

select document from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":6}';
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "$numberInt" : "6" }, "b" : { "$numberInt" : "6" } }
(1 row)

rollback;
-- update some with range filter that excludes all rows
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":{"$lt":0}},"u":{"$set":{"b":0,"_id":11}},"multi":true,"upsert":true}]}');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""11"" } } ] }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"b":0}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- upsert 1 with range filter is supported for unsharded collections
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"b":{"$lt":0}},"u":{"$set":{"b":0,"_id":11}},"multi":false,"upsert":true}]}');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""11"" } } ] }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"b":0}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- upsert 1 with a replace that preserves the _id
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":11},"u":{"b":0},"multi":false,"upsert":true}]}');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""11"" } } ] }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"b":0}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- upsert 1 with a replace that set the _id
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":33},"u":{"_id":0,"b":0},"multi":false,"upsert":true}]}');
                                                                                                                 update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""0"" } } ] }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":0}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- upsert 1 is retryable on unsharded collection (second call is a noop)
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":33,"_id":11},"u":{"$inc":{"c":33}},"multi":false,"upsert":true}]}', NULL, 'xact-ups');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""11"" } } ] }",t)
(1 row)

select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":33,"_id":11},"u":{"$inc":{"c":33}},"multi":false,"upsert":true}]}', NULL, 'xact-ups');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""11"" } } ] }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"c":33}';
 count 
---------------------------------------------------------------------
     1
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"c":66}';
 count 
---------------------------------------------------------------------
     0
(1 row)

-- third call is considered a new try
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":33,"_id":11},"u":{"$inc":{"c":33}},"multi":false,"upsert":true}]}', NULL, 'xact-ups');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"c":33}';
 count 
---------------------------------------------------------------------
     0
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"c":66}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- upsert 1 is supported in the _id case
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":33},"u":{"$set":{"b":0}},"multi":false,"upsert":true}]}');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""33"" } } ] }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":33}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- test _id extraction from update
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":33},"u":{"$set":{"b":3}},"multi":false,"upsert":true}]}');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""33"" } } ] }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":33, "b":3}';
 count 
---------------------------------------------------------------------
     1
(1 row)

set local citus.log_remote_commands to on;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":33},"u":{"$set":{"b":4}},"multi":false,"upsert":true}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6490_649000 documents_6490 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6490)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

reset citus.log_remote_commands;
select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":33, "b":4}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":33},"u":{"$set":{"b":0}},"multi":false,"upsert":true}]}');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""33"" } } ] }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":33, "b":0}';
 count 
---------------------------------------------------------------------
     1
(1 row)

set local citus.log_remote_commands to on;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":33},"u":{"$set":{"b":1}},"multi":true,"upsert":true}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6490_649000 documents_6490 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6490)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

reset citus.log_remote_commands;
select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":33, "b":1}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- shard the collection
select documentdb_api.shard_collection('db', 'updateme', '{"a":"hashed"}', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- make sure we get the expected results after sharding a collection
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":{"$lte":5}},"u":{"$set":{"b":0}},"multi":true}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""5"" }, ""n"" : { ""$numberInt"" : ""5"" } }",t)
(1 row)

select document from documentdb_api.collection('db', 'updateme') where document @@ '{"a":1}';
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "0" } }
(1 row)

select document from documentdb_api.collection('db', 'updateme') where document @@ '{"a":10}';
                                             document                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : { "$numberInt" : "10" }, "b" : { "$numberInt" : "10" } }
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"b":0}';
 count 
---------------------------------------------------------------------
     5
(1 row)

rollback;
-- test pruning logic in update
begin;
set local citus.log_remote_commands to on;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":{"$eq":5}},"u":{"$set":{"b":0}},"multi":true}]}');
NOTICE:  executing the command locally: WITH u AS (UPDATE documentdb_data.documents_6490_649022 documents_6490 SET document = (SELECT COALESCE(bson_update_document.newdocument, documents_6490.document) AS "coalesce" FROM documentdb_api_internal.bson_update_document(documents_6490.document, ($1)::documentdb_core.bson, $2::documentdb_core.bson, ($3)::documentdb_core.bson, false, $4::documentdb_core.bson) bson_update_document(newdocument, updatedesc) WHERE true) WHERE ((documents_6490.document OPERATOR(documentdb_api_catalog.#=) '{ "a" : { "$numberInt" : "5" } }'::documentdb_core.bsonquery) AND (documents_6490.shard_key_value OPERATOR(pg_catalog.=) $6)) RETURNING documentdb_api_internal.bson_update_returned_value(documents_6490.shard_key_value) AS updated) SELECT count(*) AS count, sum(updated) AS sum FROM u WHERE true
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

reset citus.log_remote_commands;
select document from documentdb_api.collection('db', 'updateme') where document @@ '{"a":5}';
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "a" : { "$numberInt" : "5" }, "b" : { "$numberInt" : "0" } }
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"b":0}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
begin;
set local citus.log_remote_commands to on;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"$and":[{"a":5},{"a":{"$gt":0}}]},"u":{"$set":{"b":0}},"multi":true}]}');
NOTICE:  executing the command locally: WITH u AS (UPDATE documentdb_data.documents_6490_649022 documents_6490 SET document = (SELECT COALESCE(bson_update_document.newdocument, documents_6490.document) AS "coalesce" FROM documentdb_api_internal.bson_update_document(documents_6490.document, ($1)::documentdb_core.bson, $2::documentdb_core.bson, ($3)::documentdb_core.bson, false, $4::documentdb_core.bson) bson_update_document(newdocument, updatedesc) WHERE true) WHERE (((documents_6490.document OPERATOR(documentdb_api_catalog.#=) '{ "a" : { "$numberInt" : "5" } }'::documentdb_core.bsonquery) AND (documents_6490.document OPERATOR(documentdb_api_catalog.#>) '{ "a" : { "$numberInt" : "0" } }'::documentdb_core.bsonquery)) AND (documents_6490.shard_key_value OPERATOR(pg_catalog.=) $6)) RETURNING documentdb_api_internal.bson_update_returned_value(documents_6490.shard_key_value) AS updated) SELECT count(*) AS count, sum(updated) AS sum FROM u WHERE true
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

reset citus.log_remote_commands;
select document from documentdb_api.collection('db', 'updateme') where document @@ '{"a":5}';
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "a" : { "$numberInt" : "5" }, "b" : { "$numberInt" : "0" } }
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"b":0}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- update 1 without filters is unsupported for sharded collections
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{},"u":{"$set":{"b":0}},"multi":false}]}');
                                                                                                                                                                                     update                                                                                                                                                                                      
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50856066"" }, ""errmsg"" : ""A {multi:false} update on a sharded collection must contain an exact match on _id or target a single shard"" } ] }",f)
(1 row)

-- update 1 with shard key filters is supported for sharded collections
begin;
set local citus.log_remote_commands to on;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":{"$eq":5}},"u":{"$set":{"b":0}},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6490_649022 documents_6490 WHERE (shard_key_value OPERATOR(pg_catalog.=) '1786987034919379147'::bigint)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

reset citus.log_remote_commands;
select document from documentdb_api.collection('db', 'updateme') where document @@ '{"a":5}';
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "a" : { "$numberInt" : "5" }, "b" : { "$numberInt" : "0" } }
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"b":0}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- update 1 with shard key filters is retryable
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":{"$eq":10}},"u":{"$inc":{"b":1}},"multi":false}]}', NULL, 'xact-2');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":{"$eq":10}},"u":{"$inc":{"b":1}},"multi":false}]}', NULL, 'xact-2');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select document from documentdb_api.collection('db', 'updateme') where document @@ '{"a":10}';
                                             document                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : { "$numberInt" : "10" }, "b" : { "$numberInt" : "11" } }
(1 row)

rollback;
-- upsert 1 with shard key filters is retryable
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":33,"_id":11},"u":{"$inc":{"c":33}},"multi":false,"upsert":true}]}', NULL, 'xact-ups');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""11"" } } ] }",t)
(1 row)

select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":33,"_id":11},"u":{"$inc":{"c":33}},"multi":false,"upsert":true}]}', NULL, 'xact-ups');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""11"" } } ] }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"c":33}';
 count 
---------------------------------------------------------------------
     1
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"c":66}';
 count 
---------------------------------------------------------------------
     0
(1 row)

-- third call is considered a new try
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":33,"_id":11},"u":{"$inc":{"c":33}},"multi":false,"upsert":true}]}', NULL, 'xact-ups');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"c":33}';
 count 
---------------------------------------------------------------------
     0
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"c":66}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- update 1 that does not match any rows is still retryable
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":{"$eq":15}},"u":{"$inc":{"b":1}},"multi":false}]}', NULL, 'xact-3');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

select 1 from documentdb_api.insert_one('db', 'updateme', '{"a":15,"_id":15}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":{"$eq":15}},"u":{"$inc":{"b":1}},"multi":false}]}', NULL, 'xact-3');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

rollback;
-- update 1 is supported in the _id case even on sharded collections
begin;
-- add an additional _id 10
select 1 from documentdb_api.insert_one('db', 'updateme', '{"a":11,"_id":10}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

-- update first row where _id = 10
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":10,"b":{"$ne":0}},"u":{"$set":{"b":0}},"multi":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":10}';
 count 
---------------------------------------------------------------------
     2
(1 row)

-- update second row where _id = 10
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":10,"b":{"$ne":0}},"u":{"$set":{"b":0}},"multi":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"b":0}';
 count 
---------------------------------------------------------------------
     2
(1 row)

-- no more row where _id = 10 and b != 0
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":10,"b":{"$ne":0}},"u":{"$set":{"b":0}},"multi":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

rollback;
-- update 1 with with _id filter on a sharded collection is retryable
begin;
-- add an additional _id 10
select 1 from documentdb_api.insert_one('db', 'updateme', '{"a":11,"_id":10}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

-- update first row where _id = 10
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":10},"u":{"$inc":{"b":1}},"multi":false}]}', NULL, 'xact-4');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

-- second time is a noop
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":10},"u":{"$inc":{"b":1}},"multi":false}]}', NULL, 'xact-4');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select document from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":10}' ORDER BY object_id;
                                             document                                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : { "$numberInt" : "11" }, "b" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "10" }, "a" : { "$numberInt" : "10" }, "b" : { "$numberInt" : "10" } }
(2 rows)

rollback;
-- upsert on sharded collection with multi:true
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"b":33},"u":{"$set":{"b":33,"_id":11}},"multi":true,"upsert":true}]}');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""11"" } } ] }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"b":33}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- updating shard key is disallowed when using multi:true
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"b":1},"u":{"$inc":{"a":1}},"multi":true}]}');
                                                                                                                                                                             update                                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""319029277"" }, ""errmsg"" : ""Invalid write detected. Please validate the collection and/or shard key being written to"" } ] }",f)
(1 row)

rollback;
-- updating shard key is disallowed when using multi:true, even with a shard key filter
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":1},"u":{"$inc":{"a":1}},"multi":true}]}');
                                                                                                                                                                             update                                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""319029277"" }, ""errmsg"" : ""Invalid write detected. Please validate the collection and/or shard key being written to"" } ] }",f)
(1 row)

rollback;
-- updating shard key is disallowed without a shard key filter
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"b":1},"u":{"$inc":{"a":1}},"multi":false}]}');
                                                                                                                                                                                     update                                                                                                                                                                                      
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50856066"" }, ""errmsg"" : ""A {multi:false} update on a sharded collection must contain an exact match on _id or target a single shard"" } ] }",f)
(1 row)

rollback;
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":1},"u":{"$inc":{"a":1}},"multi":false}]}');
                                                                                                                                                                                  update                                                                                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""1088"" }, ""errmsg"" : ""shard key value update is only supported when filtering by the full shard key and specifying multi:false"" } ] }",f)
(1 row)

rollback;
-- updating shard key is allowed when multi:false and shard key filter is specified
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":1},"u":{"$inc":{"a":1}},"multi":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"a":2}';
 count 
---------------------------------------------------------------------
     2
(1 row)

rollback;
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":10},"u":{"$set":{"a":20}},"multi":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"a":20}';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- empty shard key value is allowed (hash becomes 0)
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"a":1},"u":{"$unset":{"a":1}},"multi":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select document from documentdb_api.collection('db', 'updateme') where document @@ '{"b":1}';
                             document                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }
(1 row)

rollback;
-- update 1 is supported in the multiple identical _id case
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"$and":[{"_id":6},{"_id":6}]},"u":{"$set":{"b":0}},"multi":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select document from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":6}';
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "$numberInt" : "6" }, "b" : { "$numberInt" : "0" } }
(1 row)

rollback;
-- update 1 is unsupported in the multiple distinct _id case
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"$and":[{"_id":6},{"_id":5}]},"u":{"$set":{"b":0}},"multi":false}]}');
                                                                                                                                                                                     update                                                                                                                                                                                      
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50856066"" }, ""errmsg"" : ""A {multi:false} update on a sharded collection must contain an exact match on _id or target a single shard"" } ] }",f)
(1 row)

select document from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":6}';
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : { "$numberInt" : "6" }, "b" : { "$numberInt" : "6" } }
(1 row)

rollback;
-- test _id extraction from update
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":33, "a": 10 },"u":{"$set":{"b":3}},"multi":false,"upsert":true}]}');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""33"" } } ] }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":33, "b":3 }';
 count 
---------------------------------------------------------------------
     1
(1 row)

set local citus.log_remote_commands to on;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":33, "a": 10 },"u":{"$set":{"b":4}},"multi":false,"upsert":true}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6490_649023 documents_6490 WHERE (shard_key_value OPERATOR(pg_catalog.=) '5243071450131145979'::bigint)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

reset citus.log_remote_commands;
select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":33, "b":4 }';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":33, "a": 10 },"u":{"$set":{"b":1}},"multi":false,"upsert":true}]}');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""33"" } } ] }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":33, "b":1 }';
 count 
---------------------------------------------------------------------
     1
(1 row)

set local citus.log_remote_commands to on;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{"_id":33, "a": 10 },"u":{"$set":{"b":2}},"multi":true,"upsert":true}]}');
NOTICE:  executing the command locally: WITH u AS (UPDATE documentdb_data.documents_6490_649023 documents_6490 SET document = (SELECT COALESCE(bson_update_document.newdocument, documents_6490.document) AS "coalesce" FROM documentdb_api_internal.bson_update_document(documents_6490.document, ($1)::documentdb_core.bson, $2::documentdb_core.bson, ($3)::documentdb_core.bson, false, $4::documentdb_core.bson) bson_update_document(newdocument, updatedesc) WHERE true) WHERE (((documents_6490.document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : { "$numberInt" : "33" } }'::documentdb_core.bsonquery) AND (documents_6490.document OPERATOR(documentdb_api_catalog.#=) '{ "a" : { "$numberInt" : "10" } }'::documentdb_core.bsonquery)) AND (documents_6490.shard_key_value OPERATOR(pg_catalog.=) $6) AND (documents_6490.object_id OPERATOR(documentdb_core.=) ($7)::documentdb_core.bson)) RETURNING documentdb_api_internal.bson_update_returned_value(documents_6490.shard_key_value) AS updated) SELECT count(*) AS count, sum(updated) AS sum FROM u WHERE true
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

reset citus.log_remote_commands;
select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{"_id":33, "b":2 }';
 count 
---------------------------------------------------------------------
     1
(1 row)

rollback;
-- update with docs specified on special section
begin;
select documentdb_api.update('db', '{"update":"updateme"}', '{ "":[{"q":{"_id":36, "a": 10 },"u":{"$set":{"bz":1}},"multi":false,"upsert":true}] }');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""36"" } } ] }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{ "bz":1 }';
 count 
---------------------------------------------------------------------
     1
(1 row)

select documentdb_api.update('db', '{"update":"updateme"}', '{ "":[{"q":{"_id":37, "a": 10 },"u":{"$set":{"bz":1}},"multi":false,"upsert":true}] }');
                                                                                                                  update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""37"" } } ] }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{ "bz":1 }';
 count 
---------------------------------------------------------------------
     2
(1 row)

select documentdb_api.update('db', '{"update":"updateme"}', '{ "":[{"q":{"_id":36, "a": 10 },"u":{"$set":{"bz":2}},"multi":false }, {"q":{"_id":37, "a": 10 },"u":{"$set":{"bz":2}},"multi":false}] }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""2"" } }",t)
(1 row)

select count(*) from documentdb_api.collection('db', 'updateme') where document @@ '{ "bz":2 }';
 count 
---------------------------------------------------------------------
     2
(1 row)

rollback;
-- update with docs specified on both
begin;
select documentdb_api.update('db', '{"update":"updateme",  "updates":[{"q":{"_id":33, "a": 10 },"u":{"$set":{"b":2}},"multi":true,"upsert":true}]}', '{ "":[{"q":{"_id":33, "a": 10 },"u":{"$set":{"b":1}},"multi":false,"upsert":true}] }');
ERROR:  Unexpected further updates required
rollback;
-- update with index hint specified by name and by key object
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{ "createIndexes": "updateme", "indexes": [ { "key" : { "a": 1 }, "name": "validIndex"}] }', true);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

begin;
select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{},"u":{"$set":{"b":0}},"multi":true,"hint": "validIndex"}]}');
                                                                update                                                                
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""10"" }, ""n"" : { ""$numberInt"" : ""10"" } }",t)
(1 row)

select documentdb_api.update('db', '{"update":"updateme", "updates":[{"q":{},"u":{"$set":{"b":0}},"multi":true,"hint": { "a": 1 }}]}');
                                                               update                                                                
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""10"" } }",t)
(1 row)

rollback;
select documentdb_api.drop_collection('db','updateme');
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

SELECT 1 FROM documentdb_api.insert_one('update', 'test_sort_returning', '{"_id":1,"a":3,"b":7}');
NOTICE:  creating collection
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

SELECT 1 FROM documentdb_api.insert_one('update', 'test_sort_returning', '{"_id":2,"a":2,"b":5}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

SELECT 1 FROM documentdb_api.insert_one('update', 'test_sort_returning', '{"_id":3,"a":1,"b":6}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

-- sort in ascending order and project & return old document
SELECT collection_id AS test_sort_returning FROM documentdb_api_catalog.collections WHERE database_name = 'update' AND collection_name = 'test_sort_returning' \gset
SELECT documentdb_api_internal.update_worker(
    p_collection_id=>:test_sort_returning,
    p_shard_key_value=>:test_sort_returning,
    p_shard_oid => 0,
    p_update_internal_spec => '{ "updateOne": { "query": { "a": {"$gte": 1} }, "update": { "": { "c": 3 } }, "isUpsert": false, "sort": { "b": 1 }, "returnDocument": 1, "returnFields": { "_id": 0, "b": 1 } } }'::bson,
    p_update_internal_docs=>null::bsonsequence,
    p_transaction_id=>null::text
) FROM documentdb_api.collection('update', 'test_sort_returning');
                                                       update_worker                                                        
---------------------------------------------------------------------
 { "isRowUpdated" : true, "updateSkipped" : false, "isRetry" : false, "resultDocument" : { "b" : { "$numberInt" : "5" } } }
(1 row)

-- sort by multiple fields (i) and project & return new document
BEGIN;
    SELECT documentdb_api_internal.update_worker(
        p_collection_id=>:test_sort_returning,
        p_shard_key_value=>:test_sort_returning,
        p_shard_oid => 0,
        p_update_internal_spec => '{ "updateOne": { "query": { "a": {"$gte": 1} }, "update": { "": { "c": 4 } }, "isUpsert": false, "sort": { "b": -1, "a": 1 }, "returnDocument": 2 } }'::bson,
        p_update_internal_docs=>null::bsonsequence,
        p_transaction_id=>null::text
    ) FROM documentdb_api.collection('update', 'test_sort_returning');
                                                                       update_worker                                                                        
---------------------------------------------------------------------
 { "isRowUpdated" : true, "updateSkipped" : false, "isRetry" : false, "resultDocument" : { "_id" : { "$numberInt" : "1" }, "c" : { "$numberInt" : "4" } } }
(1 row)

    SELECT document FROM documentdb_api.collection('update', 'test_sort_returning') ORDER BY 1;
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "c" : { "$numberInt" : "4" } }
 { "_id" : { "$numberInt" : "2" }, "c" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "6" } }
(3 rows)

ROLLBACK;
SELECT documentdb_api_internal.update_worker(
    p_collection_id=>:test_sort_returning,
    p_shard_key_value=>:test_sort_returning,
    p_shard_oid => 0,
    p_update_internal_spec => '{ "updateOne": { "query": { "a": {"$gte": 1} }, "update": { "": { "c": 4 } }, "isUpsert": false, "sort": { "a": 1, "b": -1 }, "returnDocument": 2 } }'::bson,
    p_update_internal_docs=>null::bsonsequence,
    p_transaction_id=>null::text
    ) FROM documentdb_api.collection('update', 'test_sort_returning');
                                                                       update_worker                                                                        
---------------------------------------------------------------------
 { "isRowUpdated" : true, "updateSkipped" : false, "isRetry" : false, "resultDocument" : { "_id" : { "$numberInt" : "3" }, "c" : { "$numberInt" : "4" } } }
(1 row)

SELECT document FROM documentdb_api.collection('update', 'test_sort_returning') ORDER BY 1;
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "7" } }
 { "_id" : { "$numberInt" : "2" }, "c" : { "$numberInt" : "3" } }
 { "_id" : { "$numberInt" : "3" }, "c" : { "$numberInt" : "4" } }
(3 rows)

-- show that we validate "update" document even if collection doesn't exist
-- i) ordered=true
SELECT documentdb_api.update(
    'update',
    '{
        "update": "dne",
        "updates": [
            {"q": {"a": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"b": 1}, "u": { "$set": { "p": 1 }, "$unset": {"p": 1 } } },
            {"q": {"c": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"d": 1}, "u": { "$set": { "p": 1 }, "$unset": {"p": 1 } } },
            {"q": {"e": 1}, "u": { "$set": { "p": 1 } } }
        ],
        "ordered": true
     }'
);
                                                                                                                                                                 update                                                                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""1"" }, ""code"" : { ""$numberInt"" : ""335544349"" }, ""errmsg"" : ""Modifying the path 'p' will result in a conflict occurring at 'p'"" } ] }",f)
(1 row)

-- ii) ordered=false
SELECT documentdb_api.update(
    'update',
    '{
        "update": "dne",
        "updates": [
            {"q": {"a": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"b": 1}, "u": { "$set": { "p": 1 }, "$unset": {"p": 1 } } },
            {"q": {"c": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"d": 1}, "u": { "$set": { "p": 1 }, "$unset": {"p": 1 } } },
            {"q": {"e": 1}, "u": { "$set": { "p": 1 } } }
        ],
        "ordered": false
     }'
);
                                                                                                                                                                                                                                                         update                                                                                                                                                                                                                                                         
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""1"" }, ""code"" : { ""$numberInt"" : ""335544349"" }, ""errmsg"" : ""Modifying the path 'p' will result in a conflict occurring at 'p'"" }, { ""index"" : { ""$numberInt"" : ""3"" }, ""code"" : { ""$numberInt"" : ""335544349"" }, ""errmsg"" : ""Modifying the path 'p' will result in a conflict occurring at 'p'"" } ] }",f)
(1 row)

-- show that we validate "query" document even if collection doesn't exist
-- i) ordered=true
SELECT documentdb_api.update(
    'update',
    '{
        "update": "dne",
        "updates": [
            {"q": {"a": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"$b": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"c": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"$d": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"e": 1}, "u": { "$set": { "p": 1 } } }
        ],
        "ordered": true
     }'
);
                                                                                                                                                                                               update                                                                                                                                                                                                
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""1"" }, ""code"" : { ""$numberInt"" : ""16777245"" }, ""errmsg"" : ""unknown top level operator: $b. If you have a field name that starts with a '$' symbol, consider using $getField or $setField."" } ] }",f)
(1 row)

-- ii) ordered=false
SELECT documentdb_api.update(
    'update',
    '{
        "update": "dne",
        "updates": [
            {"q": {"a": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"$b": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"c": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"$d": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"e": 1}, "u": { "$set": { "p": 1 } } }
        ],
        "ordered": false
     }'
);
                                                                                                                                                                                                                                                                                                                     update                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""1"" }, ""code"" : { ""$numberInt"" : ""16777245"" }, ""errmsg"" : ""unknown top level operator: $b. If you have a field name that starts with a '$' symbol, consider using $getField or $setField."" }, { ""index"" : { ""$numberInt"" : ""3"" }, ""code"" : { ""$numberInt"" : ""16777245"" }, ""errmsg"" : ""unknown top level operator: $d. If you have a field name that starts with a '$' symbol, consider using $getField or $setField."" } ] }",f)
(1 row)

SELECT documentdb_api.create_collection('update', 'no_match');
NOTICE:  creating collection
 create_collection 
---------------------------------------------------------------------
 t
(1 row)

-- show that we validate "update" document even if we can't match any documents
-- i) ordered=true
SELECT documentdb_api.update(
    'update',
    '{
        "update": "no_match",
        "updates": [
            {"q": {"a": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"b": 1}, "u": { "$set": { "p": 1 }, "$unset": {"p": 1 } } },
            {"q": {"c": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"d": 1}, "u": { "$set": { "p": 1 }, "$unset": {"p": 1 } } },
            {"q": {"e": 1}, "u": { "$set": { "p": 1 } } }
        ],
        "ordered": true
     }'
);
                                                                                                                                                                 update                                                                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""1"" }, ""code"" : { ""$numberInt"" : ""335544349"" }, ""errmsg"" : ""Modifying the path 'p' will result in a conflict occurring at 'p'"" } ] }",f)
(1 row)

-- ii) ordered=false
SELECT documentdb_api.update(
    'update',
    '{
        "update": "no_match",
        "updates": [
            {"q": {"a": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"b": 1}, "u": { "$set": { "p": 1 }, "$unset": {"p": 1 } } },
            {"q": {"c": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"d": 1}, "u": { "$set": { "p": 1 }, "$unset": {"p": 1 } } },
            {"q": {"e": 1}, "u": { "$set": { "p": 1 } } }
        ],
        "ordered": false
     }'
);
                                                                                                                                                                                                                                                         update                                                                                                                                                                                                                                                         
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""1"" }, ""code"" : { ""$numberInt"" : ""335544349"" }, ""errmsg"" : ""Modifying the path 'p' will result in a conflict occurring at 'p'"" }, { ""index"" : { ""$numberInt"" : ""3"" }, ""code"" : { ""$numberInt"" : ""335544349"" }, ""errmsg"" : ""Modifying the path 'p' will result in a conflict occurring at 'p'"" } ] }",f)
(1 row)

-- show that we validate "query" document even if we can't match any documents
-- i) ordered=true
SELECT documentdb_api.update(
    'update',
    '{
        "update": "no_match",
        "updates": [
            {"q": {"a": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"$b": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"c": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"$d": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"e": 1}, "u": { "$set": { "p": 1 } } }
        ],
        "ordered": true
     }'
);
                                                                                                                                                                                               update                                                                                                                                                                                                
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""1"" }, ""code"" : { ""$numberInt"" : ""16777245"" }, ""errmsg"" : ""unknown top level operator: $b. If you have a field name that starts with a '$' symbol, consider using $getField or $setField."" } ] }",f)
(1 row)

-- ii) ordered=false
SELECT documentdb_api.update(
    'update',
    '{
        "update": "no_match",
        "updates": [
            {"q": {"a": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"$b": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"c": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"$d": 1}, "u": { "$set": { "p": 1 } } },
            {"q": {"e": 1}, "u": { "$set": { "p": 1 } } }
        ],
        "ordered": false
     }'
);
                                                                                                                                                                                                                                                                                                                     update                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""1"" }, ""code"" : { ""$numberInt"" : ""16777245"" }, ""errmsg"" : ""unknown top level operator: $b. If you have a field name that starts with a '$' symbol, consider using $getField or $setField."" }, { ""index"" : { ""$numberInt"" : ""3"" }, ""code"" : { ""$numberInt"" : ""16777245"" }, ""errmsg"" : ""unknown top level operator: $d. If you have a field name that starts with a '$' symbol, consider using $getField or $setField."" } ] }",f)
(1 row)

-- Validate multi and single updates with no-op return matched and updated as expected
SELECT 1 FROM documentdb_api.insert_one('update', 'multi', '{"_id":1,"a":1,"b":1}');
NOTICE:  creating collection
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

SELECT 1 FROM documentdb_api.insert_one('update', 'multi', '{"_id":2,"a":2,"b":1}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

SELECT 1 FROM documentdb_api.insert_one('update', 'multi', '{"_id":3,"a":3,"b":1}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

SELECT 1 FROM documentdb_api.insert_one('update', 'multi', '{"_id":4,"a":100,"b":1}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

SELECT 1 FROM documentdb_api.insert_one('update', 'multi', '{"_id":5,"a":200,"b":1}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

SELECT 1 FROM documentdb_api.insert_one('update', 'multi', '{"_id":6,"a":6,"b":1}');
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

select documentdb_api.update('update', '{"update":"multi", "updates":[{"q":{"b": 1 },"u":{"$max":{"a":3}},"multi":true,"upsert":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""6"" } }",t)
(1 row)

select documentdb_api.update('update', '{"update":"multi", "updates":[{"q":{"b": 1 },"u":{"$max":{"a":7}},"multi":true,"upsert":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""4"" }, ""n"" : { ""$numberInt"" : ""6"" } }",t)
(1 row)

select documentdb_api.update('update', '{"update":"multi", "updates":[{"q":{"b": 1 },"u":{"$min":{"a":150}},"multi":true,"upsert":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""6"" } }",t)
(1 row)

select documentdb_api.update('update', '{"update":"multi", "updates":[{"q":{"b": 1 },"u":{"$min":{"a":99}},"multi":true,"upsert":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""6"" } }",t)
(1 row)

-- no match
select documentdb_api.update('update', '{"update":"multi", "updates":[{"q":{"b": 50 },"u":{"$min":{"a":99}},"multi":true,"upsert":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

-- all updated
select documentdb_api.update('update', '{"update":"multi", "updates":[{"q":{"b": 1 },"u":{"$max":{"a":500}},"multi":true,"upsert":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""6"" }, ""n"" : { ""$numberInt"" : ""6"" } }",t)
(1 row)

-- all match, no-op update
select documentdb_api.update('update', '{"update":"multi", "updates":[{"q":{"b": 1 },"u":{"$max":{"a":100}},"multi":true,"upsert":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""6"" } }",t)
(1 row)

-- single update
SELECT 1 FROM documentdb_api.insert_one('update', 'single', '{"_id":1,"a":1,"b":1}');
NOTICE:  creating collection
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"b": 1 },"u":{"$max":{"a":100}},"multi":false,"upsert":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"b": 1 },"u":{"$min":{"a":50}},"multi":false,"upsert":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

-- no-op update single
select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"b": 1 },"u":{"$min":{"a":50}},"multi":false,"upsert":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"b": 1 },"u":{"$max":{"a":50}},"multi":false,"upsert":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

-- no match
select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"b": 50 },"u":{"$max":{"a":50}},"multi":false,"upsert":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

--upsert with same field in querySpec 
select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"_id":1234, "$and" : [{"x" : {"$eq": 1}}, {"x": 2}]},"u":{},"upsert":true}]}');
                                                                                                                   update                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""1234"" } } ] }",t)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"_id":2345, "x": 1, "x.x": 1},"u":{},"upsert":true}]}');
                                                                                                                   update                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""2345"" } } ] }",t)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"_id":3456, "x": {}, "x.x": 1},"u":{},"upsert":true}]}');
                                                                                                                   update                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""3456"" } } ] }",t)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"_id":4567, "x": {"x": 1}, "x.x": 1},"u":{},"upsert":true}]}');
                                                                                                                   update                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""4567"" } } ] }",t)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"_id":5678, "x": {"x": 1}, "x.y": 1},"u":{},"upsert":true}]}');
                                                                                                                   update                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""5678"" } } ] }",t)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"_id":6789, "x": [1, {"x": 1}], "x.x": 1},"u":{},"upsert":true}]}');
                                                                                                                   update                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""6789"" } } ] }",t)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"_id": 1, "_id": 2},"u":{},"upsert":true}]}');
                                                                                                                                                                            update                                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""419430429"" }, ""errmsg"" : ""Unable to determine which query fields to set, as the path '_id' has been matched twice"" } ] }",f)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"x": 1, "x": 5},"u":{"$set" : {"x":10}},"upsert":true}]}');
                                                                                                                                                                           update                                                                                                                                                                            
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""419430429"" }, ""errmsg"" : ""Unable to determine which query fields to set, as the path 'x' has been matched twice"" } ] }",f)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"_id": 1, "_id.b": 2},"u":{"_id":3, "a":4},"upsert":true}]}');
                                                                                                                                                                           update                                                                                                                                                                            
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""603979805"" }, ""errmsg"" : ""Invalid path '_id.b'. Please specify the full '_id' field value instead of a sub-path"" } ] }",f)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"_idab.b": 2},"u":{"_id":3, "a":4},"upsert":true}]}');
                                                                                                                 update                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""3"" } } ] }",t)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"_id.c": 2},"u":{"_id":3, "a":4},"upsert":true}]}');
                                                                                                                                                                           update                                                                                                                                                                            
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""603979805"" }, ""errmsg"" : ""Invalid path '_id.c'. Please specify the full '_id' field value instead of a sub-path"" } ] }",f)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"_id": 1, "_id": 2},"u":{"_id":3},"upsert":true}]}');
                                                                                                                                                                            update                                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""419430429"" }, ""errmsg"" : ""Unable to determine which query fields to set, as the path '_id' has been matched twice"" } ] }",f)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"_id": 1, "_id": 2},"u":{"$set" : {"_id":3} },"upsert":true}]}');
                                                                                                                                                                            update                                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""419430429"" }, ""errmsg"" : ""Unable to determine which query fields to set, as the path '_id' has been matched twice"" } ] }",f)
(1 row)

-- array filters sent to final update command.
BEGIN;
select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"_id": 134111, "b": [ 5, 2, 4 ] },"u":{"$set" : {"b.$[a]":3} },"upsert":true, "arrayFilters": [ { "a": 2 } ]}]}');
                                                                                                                    update                                                                                                                    
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""134111"" } } ] }",t)
(1 row)

SELECT documentdb_api.insert_one('update', 'multi', '{ "_id": 134112, "blah": [ 5, 1, 4 ] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('update', 'multi', '{ "_id": 134113, "blah": [ 6, 3, 1 ] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

select documentdb_api.update('update', '{"update":"multi", "updates":[{"q":{"blah": 1 },"u":{"$max":{"blah.$[a]":99}},"multi":true,"upsert":false, "arrayFilters": [ { "a": 1 } ]}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""2"" } }",t)
(1 row)

-- no match here.
select documentdb_api.update('update', '{"update":"multi", "updates":[{"q":{"blah": 1 },"u":{"$max":{"blah.$[a]":99}},"multi":false,"upsert":false, "arrayFilters": [ { "a": 1 } ]}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

-- updates one of the two.
select documentdb_api.update('update', '{"update":"multi", "updates":[{"q":{"blah": 99 },"u":{"$max":{"blah.$[a]":109}},"multi":false,"upsert":false, "arrayFilters": [ { "a": 99 } ]}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

ROLLBACK;
-- test replace with upsert
select documentdb_api.update('test@', '{ "update" : "shell_wc_a", "ordered" : true, "updates" : [ { "q" : { "_id" : 1.0 }, "u" : { "_id" : 1.0 }, "multi" : false, "upsert" : true } ] }');
NOTICE:  creating collection
                                                                                                                    update                                                                                                                    
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberDouble"" : ""1.0"" } } ] }",t)
(1 row)

--upsert with $expr
select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"$and" : [{"$expr" : {"$eq": ["$a",1]}}]},"u":{},"upsert":true}]}');
                                                                                                                                                             update                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50593821"" }, ""errmsg"" : ""$expr is not allowed in the query predicate for an upsert"" } ] }",f)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"$or" : [{"$expr" : {"$gt": ["$b",1]}}, {"x": 2}]},"u":{"$set" : {"a": 10}},"upsert":true}]}');
                                                                                                                                                             update                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50593821"" }, ""errmsg"" : ""$expr is not allowed in the query predicate for an upsert"" } ] }",f)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"$or" : [{"$expr" : {"$gte": ["$c", 100]}}]},"u":{"$set": {"a" :10}},"upsert":true}]}');
                                                                                                                                                             update                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50593821"" }, ""errmsg"" : ""$expr is not allowed in the query predicate for an upsert"" } ] }",f)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"$or" : [{"$or" : [{"$expr" : {"$gte": ["$c", 100]}}]}]},"u":{"$set": {"a" :10}},"upsert":true}]}');
                                                                                                                                                             update                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50593821"" }, ""errmsg"" : ""$expr is not allowed in the query predicate for an upsert"" } ] }",f)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"$and" : [{"$or" : [{"x": 10},{"$expr" : {"$gte": ["$c", 100]}}, {"y": 10}]}]},"u":{"$set": {"a" :10}},"upsert":true}]}');
                                                                                                                                                             update                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50593821"" }, ""errmsg"" : ""$expr is not allowed in the query predicate for an upsert"" } ] }",f)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"$expr": {"$gt" : ["$x",10]}},"u":{},"upsert":true}]}');
                                                                                                                                                             update                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50593821"" }, ""errmsg"" : ""$expr is not allowed in the query predicate for an upsert"" } ] }",f)
(1 row)

select documentdb_api.update('update', '{"update":"single", "updates":[{"q":{"$and" : [{"a": 10}, {"$or" : [{"x": 10},{"$expr" : {"$gte": ["$c", 100]}}, {"y": 10}]}, {"b":11} ]},"u":{"$set": {"a" :10}},"upsert":true}]}');
                                                                                                                                                             update                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50593821"" }, ""errmsg"" : ""$expr is not allowed in the query predicate for an upsert"" } ] }",f)
(1 row)

-- below query will be updating document although we don't have @@ in query match but for below query only object id filter is sufficient.
BEGIN;
SELECT documentdb_api.insert_one('update','NonID',' { "_id" :  1, "b" : 1 }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

set local citus.log_remote_commands to on;
SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"a":{"$eq":1}},"u":{"$set":{"b":0 }},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"a":{"$eq":1}, "_id" : 1},"u":{"$set":{"b":0 }},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"_id":{"$eq":1}, "a" : 1},"u":{"$set":{"b":0 }},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"_id":{"$gt":1}},"u":{"$set":{"b":0 }},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"_id":{"$lt":1}},"u":{"$set":{"b":0 }},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"_id":{"$in": []}},"u":{"$set":{"b":0 }},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"_id":{"$in": [2]}},"u":{"$set":{"b":0 }},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"_id":{"$in": [2,3,4]}},"u":{"$set":{"b":0 }},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"_id":{"$all": [1,2]}},"u":{"$set":{"b":0 }},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"$expr":{"$gt": ["$_id",1]}},"u":{"$set":{"b":0 }},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"$and":[{"_id":1},{"_id":2}]},"u":{"$set":{"b":0}},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"$or":[{"_id":2}, {"a" : 1}]},"u":{"$set":{"b":0}},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"$or":[{"b":2}]},"u":{"$set":{"b":0}},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT document from documentdb_api.collection('update', 'NonID');
NOTICE:  executing the command locally: SELECT document FROM documentdb_data.documents_6498_649038 collection WHERE (shard_key_value OPERATOR(pg_catalog.=) '6498'::bigint)
                             document                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "1" } }
(1 row)

-- below query will be updating document although we don't have @@ in query match but for below query only object id filter is sufficient.
SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"_id":{"$eq":1}},"u":{"$inc":{"b": 1 }},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"$and":[{"_id":1}]},"u":{"$inc":{"b":1}},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"$or":[{"_id":1}, {"b" : 1}]},"u":{"$inc":{"b":1}},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"$or":[{"_id":1}]},"u":{"$inc":{"b":1}},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"_id":{"$all": [1]}},"u":{"$inc":{"b":1 }},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"NonID", "updates":[{"q":{"_id":{"$all": [1,1]}},"u":{"$inc":{"b":1 }},"multi":false}]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.update_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS update_worker FROM documentdb_data.documents_6498_649038 documents_6498 WHERE (shard_key_value OPERATOR(pg_catalog.=) 6498)
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document from documentdb_api.collection('update', 'NonID');
NOTICE:  executing the command locally: SELECT document FROM documentdb_data.documents_6498_649038 collection WHERE (shard_key_value OPERATOR(pg_catalog.=) '6498'::bigint)
                             document                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : { "$numberInt" : "7" } }
(1 row)

ROLLBACK;
-- regex operator and update
SELECT documentdb_api.insert_one('db', 'regexColl', '{ "_id" : 1, "Login": "robert.bean@networkrail.co.uk", "RefreshTokens": [ ] }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'regexColl', '{ "_id" : 2, "Login": "peter.ramesh@networkrail.co.uk", "RefreshTokens": [ ] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'regexColl', '{ "_id" : 3, "Login": "picop1@test.co.uk", "RefreshTokens": [ ] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'regexColl', '{ "_id" : 4, "Login": "peter.claxton@networkrail.co.uk", "RefreshTokens": [ ] }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.update('db', '{"update":"regexColl", "updates":[{ "q" : { "Login" : { "$regularExpression" : { "pattern" : "^picop1@test\\.co\\.uk$", "options" : "i" } } },"u":{"$addToSet": { "RefreshTokens": { "RefreshToken": "eyJhbGciOiJSUzI1NiIsImtpZCI6ImYxNDNhY2ZmMzNjODQ" } }}}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document from documentdb_api.collection('db', 'regexColl');
                                                                            document                                                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "Login" : "robert.bean@networkrail.co.uk", "RefreshTokens" : [  ] }
 { "_id" : { "$numberInt" : "2" }, "Login" : "peter.ramesh@networkrail.co.uk", "RefreshTokens" : [  ] }
 { "_id" : { "$numberInt" : "3" }, "Login" : "picop1@test.co.uk", "RefreshTokens" : [ { "RefreshToken" : "eyJhbGciOiJSUzI1NiIsImtpZCI6ImYxNDNhY2ZmMzNjODQ" } ] }
 { "_id" : { "$numberInt" : "4" }, "Login" : "peter.claxton@networkrail.co.uk", "RefreshTokens" : [  ] }
(4 rows)

-- test update with upsert
BEGIN;
set documentdb.useLocalExecutionShardQueries to off;
SELECT documentdb_api.update('update', '{ "update": "single", "updates": [ { "q": { "_id":8010 }, "u": { "value": "1" }, "upsert": true }] }');
                                                                                                                   update                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""8010"" } } ] }",t)
(1 row)

SELECT documentdb_api.shard_collection('update', 'single', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT documentdb_api.update('update', '{ "update": "single", "updates": [ { "q": { "_id":8011 }, "u": { "value": "1" }, "upsert": true }] }');
                                                                                                                   update                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""8011"" } } ] }",t)
(1 row)

ROLLBACK;
-- test update for upsert error cases
BEGIN;
-- this inserts the document
SELECT documentdb_api.update('update', '{ "update": "single", "updates": [ { "q": { "_id":8010 }, "u": { "value": "1" }, "upsert": true }] }');
                                                                                                                   update                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""8010"" } } ] }",t)
(1 row)

-- this will collide and produce a unique conflict.
SELECT documentdb_api.update('update', '{ "update": "single", "updates": [ { "q": { "value": "1123" }, "u": { "_id": 8010 }, "upsert": true }] }');
                                                                                                                                                                 update                                                                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""319029277"" }, ""errmsg"" : ""Duplicate key violation on the requested collection: Index '_id_'"" } ] }",f)
(1 row)

ROLLBACK;
-- test update for upsert error cases
BEGIN;
-- this inserts the document
SELECT documentdb_api.update('update', '{ "update": "single", "updates": [ { "q": { "_id":8010 }, "u": { "value": "1" }, "upsert": true }] }');
                                                                                                                   update                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""8010"" } } ] }",t)
(1 row)

-- this will collide and produce a unique conflict.
SELECT documentdb_api.update('update', '{ "update": "single", "updates": [ { "q": { "value": "21020" }, "u": { "$set": { "_id": 8010 } }, "upsert": true, "multi": true }] }');
                                                                                                                                                                 update                                                                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""319029277"" }, ""errmsg"" : ""Duplicate key violation on the requested collection: Index '_id_'"" } ] }",f)
(1 row)

ROLLBACK;
-- test update for upsert error cases
BEGIN;
-- this inserts the document
SELECT documentdb_api.update('update', '{ "update": "single", "updates": [ { "q": { "_id":8010 }, "u": { "value": "1" }, "upsert": true }] }');
                                                                                                                   update                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""upserted"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""_id"" : { ""$numberInt"" : ""8010"" } } ] }",t)
(1 row)

-- this will collide and produce a unique conflict.
SELECT documentdb_api.update('update', '{ "update": "single", "updates": [ { "q": { "_id": 8010, "a": 5 }, "u": { "$set": { "c": 8010 } }, "upsert": true, "multi": true }] }');
                                                                                                                                                                 update                                                                                                                                                                  
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""319029277"" }, ""errmsg"" : ""Duplicate key violation on the requested collection: Index '_id_'"" } ] }",f)
(1 row)

ROLLBACK;
-- test updateOne with sort
select documentdb_api.create_collection('update', 'test_update_one_sort');
NOTICE:  creating collection
 create_collection 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.insert_one('update', 'test_update_one_sort', '{"_id":1,"a":3,"b":7}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('update', 'test_update_one_sort', '{"_id":2,"a":3,"b":5}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM documentdb_api.collection('update', 'test_update_one_sort');
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "7" } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "5" } }
(2 rows)

SELECT documentdb_api.update('update', '{"update":"test_update_one_sort", "updates":[{"q":{"a":3},"u":{"$set":{"b":0}},"multi":false,"upsert":false, "sort": {"b": 1}}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('update', 'test_update_one_sort');
                                            document                                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "7" } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "0" } }
(2 rows)

SELECT documentdb_api.update('update', '{"update":"test_update_one_sort", "updates":[{"q":{"a":3},"u":{"$set":{"b":10}},"multi":false,"upsert":false, "sort": {"_id": 1}}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('update', 'test_update_one_sort');
                                            document                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "10" } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "0" } }
(2 rows)

SELECT documentdb_api.insert_one('update', 'test_update_one_sort', '{"_id":3,"a":3,"b":3}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.update('update', '{"update":"test_update_one_sort", "updates":[{"q":{"a":3},"u":{"$set":{"b":-1}},"multi":false,"upsert":false, "sort": {"_id": -1}}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('update', 'test_update_one_sort');
                                            document                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "10" } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "0" } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "-1" } }
(3 rows)

SELECT documentdb_api.update('update', '{"update":"test_update_one_sort", "updates":[{"q":{"a":3},"u":{"$set":{"b":-1}},"multi":false,"upsert":false, "sort": {"_id": -1}}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('update', 'test_update_one_sort');
                                            document                                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "10" } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "0" } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "-1" } }
(3 rows)

SELECT documentdb_api.update('update', '{"update":"test_update_one_sort", "updates":[{"q":{"b":{"$lt":5}},"u":{"$set":{"text":"smaller than 5"}},"multi":false,"upsert":false, "sort": {"b": -1}}, {"q":{"b":{"$gte":5}},"u":{"$set":{"text":"large"}},"multi":false,"upsert":false, "sort": {"b": 1}}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""2"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('update', 'test_update_one_sort');
                                                         document                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "10" }, "text" : "large" }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "0" }, "text" : "smaller than 5" }
 { "_id" : { "$numberInt" : "3" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "-1" } }
(3 rows)

-- negative test case
SELECT documentdb_api.update('update', '{"update":"test_update_one_sort", "updates":[{"q":{"b":{"$lt":5}},"u":{"$set":{"text":"tt"}},"multi":true,"sort": {"b": -1}}]}');
                                                                                                                                                     update                                                                                                                                                      
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50331677"" }, ""errmsg"" : ""sort option can not be set when multi=true"" } ] }",f)
(1 row)

SELECT document FROM documentdb_api.collection('update', 'test_update_one_sort');
                                                         document                                                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "10" }, "text" : "large" }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "0" }, "text" : "smaller than 5" }
 { "_id" : { "$numberInt" : "3" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "-1" } }
(3 rows)

SELECT documentdb_api.insert('update', '{"insert":"test_update_one_sort_ex", "documents":[{"_id":-1,"a":1,"b":"string"}, {"_id":-2,"a":0,"b":1.2}, {"_id":-3,"a":1,"b":[1,2,3]}]}');
NOTICE:  creating collection
                                         insert                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""3"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

select documentdb_api.update('update', '{"update":"test_update_one_sort_ex", "updates":[{"q":{"a":{"$gte":0}},"u":{"$set":{"b":"exception"}},"multi":false,"sort": {"b": -1}},{"q":{"a":{"$gte":0}},"u":{"$set":{"b":[4,5]}},"multi":false,"sort": {"b": 1}}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""2"" } }",t)
(1 row)

SELECT cursorPage FROM documentdb_api.find_cursor_first_page('update', '{ "find" : "test_update_one_sort_ex", "filter" : {"b":"exception"}, "limit" : 10, "singleBatch" : true, "batchSize" : 10, "$db" : "update", "projection":{"_id":0} }');
                                                                                               cursorpage                                                                                               
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "update.test_update_one_sort_ex", "firstBatch" : [ { "a" : { "$numberInt" : "1" }, "b" : "exception" } ] }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT cursorPage FROM documentdb_api.find_cursor_first_page('update', '{ "find" : "test_update_one_sort_ex", "filter" : {"b":[4,5]}, "limit" : 10, "singleBatch" : true, "batchSize" : 10, "$db" : "update", "projection":{"_id":0} }');
                                                                                                                  cursorpage                                                                                                                   
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "update.test_update_one_sort_ex", "firstBatch" : [ { "a" : { "$numberInt" : "1" }, "b" : [ { "$numberInt" : "4" }, { "$numberInt" : "5" } ] } ] }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

WITH generated_data AS (
    SELECT
        row_number() OVER () AS _id, 
        1 AS a,
        CASE (random()*6)::int
            WHEN 0 THEN (random()*1000)::int::text
            WHEN 1 THEN to_char(random()*1000, 'FM999.9999')
            WHEN 2 THEN 'str_' || floor(random()*10000)::int
            WHEN 3 THEN (ARRAY['true','false'])[floor(random()*2)+1]
            WHEN 4 THEN to_char(
                         now() - (floor(random()*3650)||' days')::interval,
                         'YYYY-MM-DD'
                     )
            WHEN 5 THEN gen_random_uuid()::text
            ELSE NULL::text
        END AS b
    FROM generate_series(1, 1000)
)
SELECT documentdb_api.insert(
    'update'::text,
    ('{"insert":"test_update_one_sort_ex", "documents":[' ||
    (SELECT string_agg(row_to_json(g)::text, ',') FROM generated_data g) ||
    ']}')::bson  
);
                                          insert                                           
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1000"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

select documentdb_api.update('update', '{"update":"test_update_one_sort_ex", "updates":[{"q":{"a":{"$gte":0}},"u":{"$set":{"b":"exception"}},"multi":false,"sort": {"b": -1}},{"q":{"a":{"$gte":0}},"u":{"$set":{"b":[4,5]}},"multi":false,"sort": {"b": 1}}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""2"" } }",t)
(1 row)

SELECT cursorPage FROM documentdb_api.find_cursor_first_page('update', '{ "find" : "test_update_one_sort_ex", "filter" : {"b":"exception"}, "limit" : 10, "singleBatch" : true, "batchSize" : 10, "$db" : "update", "projection":{"_id":0} }');
                                                                                                                         cursorpage                                                                                                                          
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "update.test_update_one_sort_ex", "firstBatch" : [ { "a" : { "$numberInt" : "1" }, "b" : "exception" }, { "a" : { "$numberInt" : "1" }, "b" : "exception" } ] }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT cursorPage FROM documentdb_api.find_cursor_first_page('update', '{ "find" : "test_update_one_sort_ex", "filter" : {"b":[4,5]}, "limit" : 10, "singleBatch" : true, "batchSize" : 10, "$db" : "update", "projection":{"_id":0} }');
                                                                                                                                                                cursorpage                                                                                                                                                                 
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "update.test_update_one_sort_ex", "firstBatch" : [ { "a" : { "$numberInt" : "1" }, "b" : [ { "$numberInt" : "4" }, { "$numberInt" : "5" } ] }, { "a" : { "$numberInt" : "1" }, "b" : [ { "$numberInt" : "4" }, { "$numberInt" : "5" } ] } ] }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- sharded collection
select documentdb_api.shard_collection('update', 'test_update_one_sort', '{"_id": "hashed"}', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- expect to fail as updateOne without id filter is not supported on sharded collection
SELECT documentdb_api.update('update', '{"update":"test_update_one_sort", "updates":[{"q":{"a":3},"u":{"$set":{"b":0}},"multi":false,"upsert":false, "sort": {"b": 1}}]}');
                                                                                                                                                                                     update                                                                                                                                                                                      
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50856066"" }, ""errmsg"" : ""A {multi:false} update on a sharded collection must contain an exact match on _id or target a single shard"" } ] }",f)
(1 row)

SELECT documentdb_api.update('update', '{"update":"test_update_one_sort", "updates":[{"q":{"a":3},"u":{"$set":{"b":-10}},"multi":false,"upsert":false, "sort": {"_id": -1}}]}');
                                                                                                                                                                                     update                                                                                                                                                                                      
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50856066"" }, ""errmsg"" : ""A {multi:false} update on a sharded collection must contain an exact match on _id or target a single shard"" } ] }",f)
(1 row)

-- expect to succeed as updateOne with id filter is supported on sharded collection
SELECT documentdb_api.update('update', '{"update":"test_update_one_sort", "updates":[{"q":{"_id":1, "a":3},"u":{"$set":{"b":0}},"multi":false,"upsert":false, "sort": {"b": 1}}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT documentdb_api.update('update', '{"update":"test_update_one_sort", "updates":[{"q":{"_id":2, "a":3},"u":{"$set":{"b":-10}},"multi":false,"upsert":false, "sort": {"_id": -1}}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

-- negative test case
SELECT documentdb_api.update('update', '{"update":"test_update_one_sort", "updates":[{"q":{"_id":3, "a":3},"u":{"$set":{"b":-1}},"multi":true,"upsert":false, "sort": {"_id": -1}}]}');
                                                                                                                                                     update                                                                                                                                                      
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""50331677"" }, ""errmsg"" : ""sort option can not be set when multi=true"" } ] }",f)
(1 row)

SELECT document FROM documentdb_api.collection('update', 'test_update_one_sort');
                                                          document                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "-1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "-10" }, "text" : "smaller than 5" }
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "0" }, "text" : "large" }
(3 rows)

-- expect to throw error but the first one should succeed
SELECT documentdb_api.update('update', '{"update":"test_update_one_sort", "updates":[{"q":{"_id":3, "a":3},"u":{"$set":{"b":-10}},"multi":true,"upsert":false},{"q":{"_id":3, "a":3},"u":{"$set":{"b":-2}},"multi":true,"upsert":false, "sort": {"_id": -1}}]}');
                                                                                                                                                     update                                                                                                                                                      
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""1"" }, ""code"" : { ""$numberInt"" : ""50331677"" }, ""errmsg"" : ""sort option can not be set when multi=true"" } ] }",f)
(1 row)

SELECT document FROM documentdb_api.collection('update', 'test_update_one_sort');
                                                          document                                                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "-10" }, "text" : "smaller than 5" }
 { "_id" : { "$numberInt" : "3" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "-10" } }
 { "_id" : { "$numberInt" : "1" }, "a" : { "$numberInt" : "3" }, "b" : { "$numberInt" : "0" }, "text" : "large" }
(3 rows)

-- let support
SELECT documentdb_api.insert_one('db', 'coll_update', '{"_id": 1, "a":"kofi"}');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_update', '{"_id": 2, "a":"ama"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_update', '{"_id": 3, "a":"$$varRef"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- EnableVariablesSupportForWriteCommands GUC off: ignore variableSpec
SET documentdb.EnableVariablesSupportForWriteCommands TO off;
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$eq": ["$a", "$$varRef"] } }, "u": {"$set": {"b": "zebra"}}, "multi": true}], "let": {"varRef": "ama"} }');
ERROR:  update.let is not yet supported
-- EnableVariablesSupportForWriteCommands GUC on: user variableSpec
SET documentdb.EnableVariablesSupportForWriteCommands TO on;
-- variables accessed outside $expr will not evaluate to let variable value in 'q'
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"_id": "$$varRef" }, "u": {"$set": {"b": "zebra"}}, "multi": false}], "let": {"varRef": 2}} ');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"_id": "$$varRef" }, "u": {"$set": {"b": "zebra"}}, "multi": true}], "let": {"varRef": 2}} ');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

BEGIN;
-- updateMany
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$eq": ["$_id", "$$varRef"] } }, "u": {"$set": {"b": "zebra"}}, "multi": true}], "let": {"varRef": 2} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$eq": ["$_id", "$$varRef"] } }, "u": {"$set": {"b": "zebra"}}, "multi": true}], "let": {"varRef": 2} }');
                                                                                                                                     QUERY PLAN                                                                                                                                      
---------------------------------------------------------------------
 Result
   Output: update('db'::text, '{ "update" : "coll_update", "updates" : [ { "q" : { "$expr" : { "$eq" : [ "$_id", "$$varRef" ] } }, "u" : { "$set" : { "b" : "zebra" } }, "multi" : true } ], "let" : { "varRef" : { "$numberInt" : "2" } } }'::bson, NULL::bsonsequence, NULL::text)
(2 rows)

ROLLBACK;
BEGIN;
-- updateOne
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$eq": ["$a", "$$varRef"] } }, "u": {"$set": {"b": "zebra"}}, "multi": false}], "let": {"varRef": "ama"} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$eq": ["$_id", "$$varRef"] } }, "u": {"$set": {"b": "zebra"}}, "multi": false}], "let": {"varRef": 2} }');
                                                                                                                                      QUERY PLAN                                                                                                                                      
---------------------------------------------------------------------
 Result
   Output: update('db'::text, '{ "update" : "coll_update", "updates" : [ { "q" : { "$expr" : { "$eq" : [ "$_id", "$$varRef" ] } }, "u" : { "$set" : { "b" : "zebra" } }, "multi" : false } ], "let" : { "varRef" : { "$numberInt" : "2" } } }'::bson, NULL::bsonsequence, NULL::text)
(2 rows)

ROLLBACK;
BEGIN;
SELECT document FROM documentdb_api.collection('db', 'coll_update');
                       document                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

SELECT documentdb_api.update(
    'db',
    '{
        "update": "coll_update",
        "updates": [
            {"q": {"$expr": {"$eq": ["$a", "$$varRef2"]}}, "u": {"$set": {"b": "kojo"}}, "multi": true},
            {"q": {"_id": 1, "$expr": {"$eq": ["$_id", "$$varRef1"]}}, "u": {"$set": {"b": "kojo"}}, "multi": false}
        ],
        "ordered": true,
        "let": {"varRef1": 1, "varRef2": "ama"}
    }'
);
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""2"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                            document                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi", "b" : "kojo" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "b" : "kojo" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

ROLLBACK;
BEGIN;
SELECT document FROM documentdb_api.collection('db', 'coll_update');
                       document                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

SELECT documentdb_api.update(
    'db',
    '{
        "update": "coll_update",
        "updates": [
            {"q": {"$expr": {"$eq": ["$a", "$$varRef2"]}}, "u": {"$set": {"b": "kojo"}}, "multi": true},
            {"q": {"_id": 1, "$expr": {"$eq": ["$_id", "$$varRef1"]}}, "u": {"$set": {"b": "kojo"}}, "multi": false}
        ],
        "ordered": true,
        "let": {"varRef1": 1, "varRef2": "ama"}
    }'
);
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""2"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                            document                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi", "b" : "kojo" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "b" : "kojo" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

ROLLBACK;
-- let support: variables in 'u'
BEGIN;
-- variables are accessible in aggregation pipeline
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$lte": ["$_id", "$$varRef"] } }, "u": {"$set": {"set": "$$varRef"}}, "multi": true}], "let": {"varRef": 2} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""2"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                               document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi", "set" : "$$varRef" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "set" : "$$varRef" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

ROLLBACK;
BEGIN;
-- updateMany: $set
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$lte": ["$_id", "$$varRef"] } }, "u": [{"$set": {"set": "$$varRef"}}], "multi": true}], "let": {"varRef": 2} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""2"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                                     document                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi", "set" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "set" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

-- updateMany: addFields
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$eq": ["$_id", "$$varRef"] } }, "u": [{"$addFields": {"addFields": "$$varRef"}}], "multi": true}], "let": {"varRef": 2} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                                                       document                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi", "set" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "set" : { "$numberInt" : "2" }, "addFields" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

-- updateMany: $project
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$gte": ["$_id", "$$varRef"] } }, "u": [{"$project": {"project": "$$varRef"}}], "multi": true}], "let": {"varRef": 2} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""2"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                                     document                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi", "set" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "project" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "project" : { "$numberInt" : "2" } }
(3 rows)

-- updateMany: $replaceRoot
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$eq": ["$_id", "$$varRef1"] } }, "u": [{"$replaceRoot": {"newRoot": "$$varRef2"}}], "multi": true}], "let": {"varRef1": 2, "varRef2": {"newRoot": 1 }} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                                     document                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi", "set" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "newRoot" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "project" : { "$numberInt" : "2" } }
(3 rows)

-- updateMany: $replaceWith
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$eq": ["$_id", "$$varRef1"] } }, "u": [{"$replaceWith": "$$varRef2"}], "multi": true}], "let": {"varRef1": 2, "varRef2": {"replaceWith": 1 }} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                                     document                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi", "set" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "replaceWith" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "project" : { "$numberInt" : "2" } }
(3 rows)

ROLLBACK;
BEGIN;
-- updateOne: $set
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$lt": ["$a", "$$varRef"] } }, "u": [{"$set": {"set": "$$varRef"}}], "multi": false}], "let": {"varRef": "ama"} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef", "set" : "ama" }
(3 rows)

-- updateOne: addFields
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$eq": ["$a", "$$varRef"] } }, "u": [{"$addFields": {"addField": "$$varRef"}}], "multi": false}], "let": {"varRef": "ama"} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "addField" : "ama" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef", "set" : "ama" }
(3 rows)

-- updateOne: $project
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$gt": ["$a", "$$varRef"] } }, "u": [{"$project": {"project": "$$varRef"}}], "multi": false}], "let": {"varRef": "ama"} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "project" : "ama" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "addField" : "ama" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef", "set" : "ama" }
(3 rows)

-- updateOne: $replaceRoot
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$eq": ["$_id", "$$varRef1"] } }, "u": [{"$replaceRoot": {"newRoot": "$$varRef2"}}], "multi": false}], "let": {"varRef1": 2, "varRef2": {"newRoot": 1 }} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                                document                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "project" : "ama" }
 { "_id" : { "$numberInt" : "2" }, "newRoot" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef", "set" : "ama" }
(3 rows)

-- updateOne: $replaceWith
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$eq": ["$_id", "$$varRef1"] } }, "u": [{"$replaceWith": "$$varRef2"}], "multi": false}], "let": {"varRef1": 2, "varRef2": {"replaceWith": 1 }} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                                  document                                  
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "project" : "ama" }
 { "_id" : { "$numberInt" : "2" }, "replaceWith" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef", "set" : "ama" }
(3 rows)

ROLLBACK;
-- let support: sharded collection
SELECT documentdb_api.shard_collection('db', 'coll_update', '{ "a": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

BEGIN;
-- updateMany
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"a": 1, "$expr": {"$eq": ["$a", "$$varRef"] } }, "u": {"$set": {"b": "anomaa"}}, "multi": true}], "let": {"varRef": "kofi"} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                       document                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

ROLLBACK;
BEGIN;
-- updateOne
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"a": 2, "$expr": {"$lt": ["$a", "$$varRef"] } }, "u": {"$set": {"b": "ako"}}, "multi": false}], "let": {"varRef": "ama"} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" } }",t)
(1 row)

ROLLBACK;
BEGIN;
SELECT document FROM documentdb_api.collection('db', 'coll_update');
                       document                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

SELECT documentdb_api.update(
    'db',
    '{
        "update": "coll_update",
        "updates": [
            {"q": {"$expr": {"$eq": ["$a", "$$varRef2"]}}, "u": {"$set": {"b": "akua"}}, "multi": true},
            {"q": {"_id": 1, "$expr": {"$eq": ["$_id", "$$varRef1"]}}, "u": {"$set": {"b": "abena"}}, "multi": false}
        ],
        "ordered": true,
        "let": {"varRef1": 1, "varRef2": "ama"}
    }'
);
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""2"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                            document                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi", "b" : "abena" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "b" : "akua" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

ROLLBACK;
BEGIN;
-- updateMany: $set
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$lte": ["$_id", "$$varRef"] } }, "u": [{"$set": {"set": "$$varRef"}}], "multi": true}], "let": {"varRef": 2} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""2"" }, ""n"" : { ""$numberInt"" : ""2"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                                     document                                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi", "set" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "set" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

-- updateMany: addFields
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$eq": ["$_id", "$$varRef"] } }, "u": [{"$addFields": {"addFields": "$$varRef"}}], "multi": true}], "let": {"varRef": 2} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                                                       document                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi", "set" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "set" : { "$numberInt" : "2" }, "addFields" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

-- updateMany: $project
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$gte": ["$_id", "$$varRef"] } }, "u": [{"$project": {"project": "$$varRef"}}], "multi": true}], "let": {"varRef": 2} }');
                                                                                                                                                                             update                                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""319029277"" }, ""errmsg"" : ""Invalid write detected. Please validate the collection and/or shard key being written to"" } ] }",f)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                                                       document                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi", "set" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "set" : { "$numberInt" : "2" }, "addFields" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

-- updateMany: $replaceRoot
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$eq": ["$_id", "$$varRef1"] } }, "u": [{"$replaceRoot": {"newRoot": "$$varRef2"}}], "multi": true}], "let": {"varRef1": 2, "varRef2": {"newRoot": 1 }} }');
                                                                                                                                                                             update                                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""319029277"" }, ""errmsg"" : ""Invalid write detected. Please validate the collection and/or shard key being written to"" } ] }",f)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                                                       document                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi", "set" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "set" : { "$numberInt" : "2" }, "addFields" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

-- updateMany: $replaceWith
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"$expr": {"$eq": ["$_id", "$$varRef1"] } }, "u": [{"$replaceWith": "$$varRef2"}], "multi": true}], "let": {"varRef1": 2, "varRef2": {"replaceWith": 1 }} }');
                                                                                                                                                                             update                                                                                                                                                                             
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""319029277"" }, ""errmsg"" : ""Invalid write detected. Please validate the collection and/or shard key being written to"" } ] }",f)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                                                       document                                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi", "set" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "set" : { "$numberInt" : "2" }, "addFields" : { "$numberInt" : "2" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef" }
(3 rows)

ROLLBACK;
BEGIN;
-- updateOne: $set
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"_id": 3, "$expr": {"$lt": ["$a", "$$varRef"] } }, "u": [{"$set": {"set": "$$varRef"}}], "multi": false}], "let": {"varRef": "ama"} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef", "set" : "ama" }
(3 rows)

-- updateOne: addFields
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"_id": 2, "$expr": {"$eq": ["$a", "$$varRef"] } }, "u": [{"$addFields": {"addField": "$$varRef"}}], "multi": false}], "let": {"varRef": "ama"} }');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""1"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "addField" : "ama" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef", "set" : "ama" }
(3 rows)

-- updateOne: $project
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"_id": 1, "$expr": {"$gt": ["$a", "$$varRef"] } }, "u": [{"$project": {"project": "$$varRef"}}], "multi": false}], "let": {"varRef": "ama"} }');
                                                                                                                                                                                  update                                                                                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""1088"" }, ""errmsg"" : ""shard key value update is only supported when filtering by the full shard key and specifying multi:false"" } ] }",f)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "addField" : "ama" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef", "set" : "ama" }
(3 rows)

-- updateOne: $replaceRoot
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"_id": 2, "$expr": {"$eq": ["$_id", "$$varRef1"] } }, "u": [{"$replaceRoot": {"newRoot": "$$varRef2"}}], "multi": false}], "let": {"varRef1": 2, "varRef2": {"newRoot": 1 }} }');
                                                                                                                                                                                  update                                                                                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""1088"" }, ""errmsg"" : ""shard key value update is only supported when filtering by the full shard key and specifying multi:false"" } ] }",f)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "addField" : "ama" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef", "set" : "ama" }
(3 rows)

-- updateOne: $replaceWith
SELECT documentdb_api.update('db', '{ "update": "coll_update", "updates": [ { "q": {"_id": 2, "$expr": {"$eq": ["$_id", "$$varRef1"] } }, "u": [{"$replaceWith": "$$varRef2"}], "multi": false}], "let": {"varRef1": 2, "varRef2": {"replaceWith": 1 }} }');
                                                                                                                                                                                  update                                                                                                                                                                                   
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""1088"" }, ""errmsg"" : ""shard key value update is only supported when filtering by the full shard key and specifying multi:false"" } ] }",f)
(1 row)

SELECT document FROM documentdb_api.collection('db', 'coll_update');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "kofi" }
 { "_id" : { "$numberInt" : "2" }, "a" : "ama", "addField" : "ama" }
 { "_id" : { "$numberInt" : "3" }, "a" : "$$varRef", "set" : "ama" }
(3 rows)

ROLLBACK;
-- sharded collection shard on some other field and query on object_id
SELECT 1 FROM documentdb_api.insert_one('db', 'upShardTest', '{"_id":1,"b":1}');
NOTICE:  creating collection
 ?column? 
---------------------------------------------------------------------
        1
(1 row)

SELECT documentdb_api.shard_collection('db', 'upShardTest', '{"b": "hashed"}', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

select documentdb_api.update('db', '{"update":"upShardTest", "updates":[{"q":{"_id":1},"u":{"b":1},"multi":false}]}');
                                                               update                                                               
---------------------------------------------------------------------
 ("{ ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""nModified"" : { ""$numberInt"" : ""0"" }, ""n"" : { ""$numberInt"" : ""1"" } }",t)
(1 row)

