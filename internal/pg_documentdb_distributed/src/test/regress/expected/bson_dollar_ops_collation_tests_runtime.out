SET search_path to documentdb_core,documentdb_api,documentdb_api_catalog,pg_catalog;
SET citus.next_shard_id TO 7990000;
SET documentdb.next_collection_id TO 7990;
SET documentdb.next_collection_index_id TO 7990;
-- (1) insert some docs
SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 1, "a": "Cat" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 2, "a": "dog" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 3, "a": "cat" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 4, "a": "Dog" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 5, "a": "caT" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 6, "a": "doG" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 7, "a": "goat" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 8, "a": "Goat" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 9, "b": "Cat" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 10, "b": "dog" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 11, "b": "cat" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 12, "b": "Dog" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 13, "b": "caT", "a" : "raBbIt" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 14, "b": "doG" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 15, "b": "goat" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 16, "b": "Goat" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 17, "a": ["Cat", "CAT", "dog"] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 18, "a": ["dog", "cat", "CAT"] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 19, "a": ["cat", "rabbit", "bAt"] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 20, "a": ["Cat"] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 21, "a": ["dog"] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 22, "a": ["cat"] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 23, "a": ["CAT"] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 24, "a": ["cAt"] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 25, "a": { "b" : "cAt"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search', '{ "_id": 26, "a": [{ "b": "CAT"}] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SET documentdb_core.enableCollation TO off;
-- With collation off and colation string in find and aggregate commands should not throw an error
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                               document                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "18" }, "a" : [ "dog", "cat", "CAT" ] }
 { "_id" : { "$numberInt" : "19" }, "a" : [ "cat", "rabbit", "bAt" ] }
 { "_id" : { "$numberInt" : "22" }, "a" : [ "cat" ] }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "b": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                     document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "b" : "cat" }
(1 row)

SET documentdb_core.enableCollation TO on;
-- (2) Find query unsharded collection
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "5" }, "a" : "caT" }
 { "_id" : { "$numberInt" : "17" }, "a" : [ "Cat", "CAT", "dog" ] }
 { "_id" : { "$numberInt" : "18" }, "a" : [ "dog", "cat", "CAT" ] }
(5 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_7990_7990004 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '7990'::bigint)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Bitmap Heap Scan on documentdb_data.documents_7990_7990004 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Recheck Cond: (collection.shard_key_value = '7990'::bigint)
                           Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection.shard_key_value = '7990'::bigint)
(18 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "b": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                             document                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "9" }, "b" : "Cat" }
 { "_id" : { "$numberInt" : "11" }, "b" : "cat" }
 { "_id" : { "$numberInt" : "13" }, "b" : "caT", "a" : "raBbIt" }
(3 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "b": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_7990_7990004 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '7990'::bigint)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Bitmap Heap Scan on documentdb_data.documents_7990_7990004 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Recheck Cond: (collection.shard_key_value = '7990'::bigint)
                           Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection.shard_key_value = '7990'::bigint)
(18 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "a": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "4" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "5" }, "a" : "caT" }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
                               document                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "5" }, "a" : "caT" }
 { "_id" : { "$numberInt" : "10" }, "b" : "dog" }
 { "_id" : { "$numberInt" : "12" }, "b" : "Dog" }
 { "_id" : { "$numberInt" : "14" }, "b" : "doG" }
 { "_id" : { "$numberInt" : "17" }, "a" : [ "Cat", "CAT", "dog" ] }
 { "_id" : { "$numberInt" : "18" }, "a" : [ "dog", "cat", "CAT" ] }
 { "_id" : { "$numberInt" : "19" }, "a" : [ "cat", "rabbit", "bAt" ] }
 { "_id" : { "$numberInt" : "20" }, "a" : [ "Cat" ] }
(10 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a": { "$all": ["cAt", "DOG"] } }, "skip": 0, "limit":
 5, "collation": { "locale": "en", "strength": 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "17" }, "a" : [ "Cat", "CAT", "dog" ] }
 { "_id" : { "$numberInt" : "18" }, "a" : [ "dog", "cat", "CAT" ] }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a" : {"$in" : ["cat", "DOG" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 100, "collation": { "locale": "en", "strength" : 5} }');
                               document                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "18" }, "a" : [ "dog", "cat", "CAT" ] }
 { "_id" : { "$numberInt" : "19" }, "a" : [ "cat", "rabbit", "bAt" ] }
 { "_id" : { "$numberInt" : "22" }, "a" : [ "cat" ] }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a" : {"$in" : ["cat", "DOG" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 100, "collation": { "locale": "en", "strength" : 1} }');
                               document                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "4" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "5" }, "a" : "caT" }
 { "_id" : { "$numberInt" : "6" }, "a" : "doG" }
 { "_id" : { "$numberInt" : "17" }, "a" : [ "Cat", "CAT", "dog" ] }
 { "_id" : { "$numberInt" : "18" }, "a" : [ "dog", "cat", "CAT" ] }
 { "_id" : { "$numberInt" : "19" }, "a" : [ "cat", "rabbit", "bAt" ] }
 { "_id" : { "$numberInt" : "20" }, "a" : [ "Cat" ] }
 { "_id" : { "$numberInt" : "21" }, "a" : [ "dog" ] }
 { "_id" : { "$numberInt" : "22" }, "a" : [ "cat" ] }
 { "_id" : { "$numberInt" : "23" }, "a" : [ "CAT" ] }
 { "_id" : { "$numberInt" : "24" }, "a" : [ "cAt" ] }
(14 rows)

-- range query without index on path "a"
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a": { "$gt": "CAT" }, "a" : {"$lt" : "RABBIT"} }, "collation": { "locale": "en", "strength" : 1.93 } }');
                               document                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : "doG" }
 { "_id" : { "$numberInt" : "7" }, "a" : "goat" }
 { "_id" : { "$numberInt" : "8" }, "a" : "Goat" }
 { "_id" : { "$numberInt" : "17" }, "a" : [ "Cat", "CAT", "dog" ] }
 { "_id" : { "$numberInt" : "18" }, "a" : [ "dog", "cat", "CAT" ] }
 { "_id" : { "$numberInt" : "19" }, "a" : [ "cat", "rabbit", "bAt" ] }
 { "_id" : { "$numberInt" : "21" }, "a" : [ "dog" ] }
(9 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a": { "$gt": "CAT" }, "a" : {"$lt" : "RABBIT"} }, "collation": { "locale": "en", "strength" : 1.93 } }');
                                                                                                                                                                                                        QUERY PLAN                                                                                                                                                                                                        
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_7990_7990004 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#<) '{ "a" : "RABBIT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '7990'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_7990_7990004 collection
               Output: document
               Recheck Cond: (collection.shard_key_value = '7990'::bigint)
               Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@<) '{ "a" : "RABBIT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '7990'::bigint)
(13 rows)

-- (3) Shard collection
SELECT documentdb_api.shard_collection('db', 'ci_search', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- (4) Find query sharded collection
BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "5" }, "a" : "caT" }
 { "_id" : { "$numberInt" : "17" }, "a" : [ "Cat", "CAT", "dog" ] }
 { "_id" : { "$numberInt" : "18" }, "a" : [ "dog", "cat", "CAT" ] }
(5 rows)

END; 
BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_7990_7990016 collection WHERE (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_7990_7990016 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(20 rows)

END;
BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "b": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                             document                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "9" }, "b" : "Cat" }
 { "_id" : { "$numberInt" : "11" }, "b" : "cat" }
 { "_id" : { "$numberInt" : "13" }, "b" : "caT", "a" : "raBbIt" }
(3 rows)

END;
BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "b": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_7990_7990016 collection WHERE (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_7990_7990016 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(20 rows)

END;
-- elemMatch with collation
BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a": { "$elemMatch": {"$eq": "cAt"} } }, "skip": 0, "limit": 7, "collation": { "locale": "en", "strength" : 1} }');
                               document                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "22" }, "a" : [ "cat" ] }
 { "_id" : { "$numberInt" : "20" }, "a" : [ "Cat" ] }
 { "_id" : { "$numberInt" : "23" }, "a" : [ "CAT" ] }
 { "_id" : { "$numberInt" : "19" }, "a" : [ "cat", "rabbit", "bAt" ] }
 { "_id" : { "$numberInt" : "24" }, "a" : [ "cAt" ] }
 { "_id" : { "$numberInt" : "17" }, "a" : [ "Cat", "CAT", "dog" ] }
 { "_id" : { "$numberInt" : "18" }, "a" : [ "dog", "cat", "CAT" ] }
(7 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a": { "$elemMatch": {"$gt": "cAt"} } }, "skip": 0, "limit": 7, "collation": { "locale": "en", "strength" : 1} }');
                               document                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "21" }, "a" : [ "dog" ] }
 { "_id" : { "$numberInt" : "19" }, "a" : [ "cat", "rabbit", "bAt" ] }
 { "_id" : { "$numberInt" : "17" }, "a" : [ "Cat", "CAT", "dog" ] }
 { "_id" : { "$numberInt" : "18" }, "a" : [ "dog", "cat", "CAT" ] }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a": { "$elemMatch": {"$lt": "cAt"} } }, "skip": 0, "limit": 7, "collation": { "locale": "en", "strength" : 1} }');
                               document                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "19" }, "a" : [ "cat", "rabbit", "bAt" ] }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a": { "$elemMatch": {"$eq": "cAt", "gte" : "BAT"} } }, "skip": 0, "limit": 7, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

END;
-- (5) Aggregation queries sharded collection
BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                               document                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "5" }, "a" : "caT" }
 { "_id" : { "$numberInt" : "17" }, "a" : [ "Cat", "CAT", "dog" ] }
 { "_id" : { "$numberInt" : "18" }, "a" : [ "dog", "cat", "CAT" ] }
 { "_id" : { "$numberInt" : "19" }, "a" : [ "cat", "rabbit", "bAt" ] }
 { "_id" : { "$numberInt" : "20" }, "a" : [ "Cat" ] }
 { "_id" : { "$numberInt" : "22" }, "a" : [ "cat" ] }
 { "_id" : { "$numberInt" : "23" }, "a" : [ "CAT" ] }
 { "_id" : { "$numberInt" : "24" }, "a" : [ "cAt" ] }
(10 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search", "pipeline": [ { "$match": { "a": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                               document                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "8" }, "a" : "Goat" }
 { "_id" : { "$numberInt" : "19" }, "a" : [ "cat", "rabbit", "bAt" ] }
 { "_id" : { "$numberInt" : "7" }, "a" : "goat" }
 { "_id" : { "$numberInt" : "13" }, "b" : "caT", "a" : "raBbIt" }
(4 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search", "pipeline": [ { "$match": { "a": { "$eq": "RABBIT" } } }, { "$project": { "b": 1 } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                     document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "19" } }
 { "_id" : { "$numberInt" : "13" }, "b" : "caT" }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search", "pipeline": [ { "$match": { "_id": { "$gt": 1 } } }, { "$project": { "b": 1, "c": "$a", "_id": 0 } }, { "$match": { "c": { "$eq": "rAbBiT" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
               document               
---------------------------------------------------------------------
 { "c" : [ "cat", "rabbit", "bAt" ] }
 { "b" : "caT", "c" : "raBbIt" }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search", "pipeline": [ { "$unwind": "$a" },  {"$match": { "a": { "$gt": "POP", "$lt": "TOP" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                             document                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "19" }, "a" : "rabbit" }
 { "_id" : { "$numberInt" : "13" }, "b" : "caT", "a" : "raBbIt" }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search", "pipeline": [ { "$match": { "a": { "$gte": "hobbit" } } }, { "$unwind": "$a" } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                             document                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "19" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "19" }, "a" : "rabbit" }
 { "_id" : { "$numberInt" : "19" }, "a" : "bAt" }
 { "_id" : { "$numberInt" : "13" }, "b" : "caT", "a" : "raBbIt" }
(4 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search", "pipeline": [ { "$addFields": { "x": "mANgO" } }, { "$addFields": { "Y": "TANGO" } }, { "$match": { "$and" : [{ "a": { "$gte": "POMELO" }}, { "x": { "$eq": "MANGO" }}]}} ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                              document                                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "19" }, "a" : [ "cat", "rabbit", "bAt" ], "x" : "mANgO", "Y" : "TANGO" }
 { "_id" : { "$numberInt" : "13" }, "b" : "caT", "a" : "raBbIt", "x" : "mANgO", "Y" : "TANGO" }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search", "pipeline": [ { "$addFields": { "e": {  "f": "$a" } } }, { "$replaceRoot": { "newRoot": "$e" } }, { "$match" : { "f": { "$elemMatch": {"$eq": "cAt"} } } } ],
 "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
               document               
---------------------------------------------------------------------
 { "f" : [ "cat" ] }
 { "f" : [ "Cat" ] }
 { "f" : [ "CAT" ] }
 { "f" : [ "cat", "rabbit", "bAt" ] }
 { "f" : [ "cAt" ] }
 { "f" : [ "Cat", "CAT", "dog" ] }
 { "f" : [ "dog", "cat", "CAT" ] }
(7 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a" : {"$in" : ["cat", "DOG" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 100, "collation": { "locale": "en", "strength" : 5} }');
                               document                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "18" }, "a" : [ "dog", "cat", "CAT" ] }
 { "_id" : { "$numberInt" : "19" }, "a" : [ "cat", "rabbit", "bAt" ] }
 { "_id" : { "$numberInt" : "22" }, "a" : [ "cat" ] }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a" : {"$in" : ["cat", "DOG" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 100, "collation": { "locale": "en", "strength" : 1} }');
                               document                                
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "4" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "5" }, "a" : "caT" }
 { "_id" : { "$numberInt" : "6" }, "a" : "doG" }
 { "_id" : { "$numberInt" : "17" }, "a" : [ "Cat", "CAT", "dog" ] }
 { "_id" : { "$numberInt" : "18" }, "a" : [ "dog", "cat", "CAT" ] }
 { "_id" : { "$numberInt" : "19" }, "a" : [ "cat", "rabbit", "bAt" ] }
 { "_id" : { "$numberInt" : "20" }, "a" : [ "Cat" ] }
 { "_id" : { "$numberInt" : "21" }, "a" : [ "dog" ] }
 { "_id" : { "$numberInt" : "22" }, "a" : [ "cat" ] }
 { "_id" : { "$numberInt" : "23" }, "a" : [ "CAT" ] }
 { "_id" : { "$numberInt" : "24" }, "a" : [ "cAt" ] }
(14 rows)

END;
BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
EXPLAIN(VERBOSE ON, COSTS OFF)SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search", "filter": { "a" : {"$in" : [[{ "b" : "caT"}], [{ "c" : "caT"}]] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 100, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_7990_7990016 collection WHERE (documentdb_api_catalog.bson_dollar_in(document, '{ "a" : [ [ { "b" : "caT" } ], [ { "c" : "caT" } ] ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_internal.##=) ANY ('{"{ \"a\" : [ { \"b\" : \"caT\" } ], \"collation\" : \"en-u-ks-level1\" }","{ \"a\" : [ { \"c\" : \"caT\" } ], \"collation\" : \"en-u-ks-level1\" }"}'::documentdb_api_internal.bsonindexbounds[]))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '100'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_7990_7990016 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "a" : [ [ { "b" : "caT" } ], [ { "c" : "caT" } ] ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(20 rows)

END;
-- (6) currently unsupported scenarions:
-- unsupported: $bucket
SELECT document FROM bson_aggregation_pipeline('db', 
'{
    "aggregate": "ci_search",
    "pipeline": [
        {
            "$bucket": {
                "groupBy": "$price",
                "boundaries": [0, 10, 20, 30],
                "default": "Other",
                "output": {
                    "categoryMatch": {
                        "$sum": {
                            "$cond": [
                                { "$eq": ["$a", "PETS"] },
                                1,
                                0
                            ]
                        }
                    }
                }
            }
        }
    ],
    "collation": { "locale": "en", "strength": 1 }
}');
ERROR:  Collation is currently unsupported in the $bucket stage.
-- unsupported: $geoNear
SELECT document FROM bson_aggregation_pipeline('db',
'{ "aggregate": "ci_search",
   "pipeline": [
     {
       "$geoNear": {
         "near": { "type": "Point", "coordinates": [ 0 , 10 ] },
         "distanceField": "dist.calculated",
         "maxDistance": 2,
         "query": { "a": "cAT" }
       }
     }
   ],
   "collation": { "locale": "en", "strength": 1 }
}');
ERROR:  collation is not supported in the $geoNear stage yet.
-- unsupported: $fill
SELECT document FROM bson_aggregation_pipeline('db', 
'{
    "aggregate": "ci_search",
    "pipeline": [
        {
            "$fill": {
                "sortBy": { "timestamp": 1 },
                "partitionBy": "$status",
                "output": {
                     "$cond": {
                        "if": { "$eq": ["$a", "cAt"] },
                        "then": { "type": "feline" },
                        "else": { "type": "other" }
                      }
                }
            }
        }
    ],
    "collation": { "locale": "en", "strength": 1 }
}');
ERROR:  collation is not supported in the $fill stage yet.
-- unsupported: $group
SELECT document FROM bson_aggregation_pipeline('db',
'{ "aggregate": "ci_search",
   "pipeline": [
     { "$group": {
         "_id": "$a",
         "set": { "$addToSet": "$a" }
     }}
   ],
   "collation": { "locale": "en", "strength": 1 }
}');
ERROR:  collation is not supported in $group stage yet.
-- unsupported: $setWindowFields
SELECT document FROM bson_aggregation_pipeline('db',
'{ "aggregate": "ci_search",
   "pipeline": [
     { "$setWindowFields": {
         "sortBy": { "_id": 1 },
         "output": {
             "total": { "$eq": ["$a", "cAt"] }
         }
     }}
   ],
   "collation": { "locale": "en", "strength": 1 }
}');
ERROR:  collation is not supported in the $setWindowFields stage yet.
-- unsupported: $sortByCount
SELECT document FROM bson_aggregation_pipeline('db',
'{ "aggregate": "ci_search",
   "pipeline": [
     { "$sortByCount": {
         "input": "$a",
         "as": "a",
         "by": { "$cond": { 
           "if": { "$eq": [ "$a", "caT" ] }, 
           "then": [{"x": 30}] , 
           "else": [{"x": 30}] }}
     }}
   ],
   "collation": { "locale": "en", "strength": 1 }
}');
ERROR:  collation is not supported in the $sortByCount stage yet.
-- (6.B)
BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search", "pipeline": [ { "$sort": { "_id": 1 } }, { "$addFields": { "e": {  "f": "$a" } } }, { "$replaceRoot": { "newRoot": "$e" } }, { "$match" : { "f": { "$elemMatch": {"$eq": "cAt"} } } }, {"$project": { "items" : { "$filter" : { "input" : "$f", "as" : "animal", "cond" : { "$eq" : ["$$animal", "CAT"] } }} }} ],
 "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
            document            
---------------------------------------------------------------------
 { "items" : [ "Cat", "CAT" ] }
 { "items" : [ "cat", "CAT" ] }
 { "items" : [ "cat" ] }
 { "items" : [ "Cat" ] }
 { "items" : [ "cat" ] }
 { "items" : [ "CAT" ] }
 { "items" : [ "cAt" ] }
(7 rows)

END;
-- (7) Insert More docs
SELECT documentdb_api.insert_one('db', 'ci_search2', '{ "_id": 1, "a": "Cat" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search2', '{ "_id": 2, "a": "dog" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search2', '{ "_id": 3, "a": "cat" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search2', '{ "_id": 4, "a": "CaT" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search2', '{ "_id": 5, "b": "Dog" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search2', '{ "_id": 6, "b": "DoG" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- (8) Query results with different collations
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "4" }, "a" : "CaT" }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "4" }, "a" : "CaT" }
 { "_id" : { "$numberInt" : "5" }, "b" : "Dog" }
 { "_id" : { "$numberInt" : "6" }, "b" : "DoG" }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 3, "caseLevel": true, "caseFirst": "off", "numericOrdering": true } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1.93 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "4" }, "a" : "CaT" }
 { "_id" : { "$numberInt" : "5" }, "b" : "Dog" }
 { "_id" : { "$numberInt" : "6" }, "b" : "DoG" }
(5 rows)

-- (8) a. collation has no effect on $regex
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "a": { "$regex": "^c", "$options": "" } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
(1 row)

-- (9) Error message Tests 
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1, "caseLevel": true, "caseFirst": "upper", "numericOrdering": true, "alternate": "none"} }');
ERROR:  unable to parse collation :: caused by :: Enumeration value 'none' for field 'collation.alternate' is not a valid value.
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en_DB", "strength" : 1, "caseLevel": true, "caseFirst": "upper", "numericOrdering": true, "alternate": "shifted"} }');
ERROR:  unable to parse collation :: caused by :: Field 'locale' is invalid in: { locale: "en_DB", strength: 1 }.
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1, "caseLevel": true, "caseFirst": "bad", "numericOrdering": true} }');
ERROR:  unable to parse collation :: caused by :: Enumeration value 'bad' for field 'collation.caseFirst' is not a valid value.
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 0, "caseLevel": true, "caseFirst": "bad", "numericOrdering": true} }');
ERROR:  unable to parse collation :: caused by :: Enumeration value '0' for field 'collation.strength' is not a valid value
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : -1, "caseLevel": true, "caseFirst": "bad", "numericOrdering": true} }');
ERROR:  unable to parse collation :: caused by :: BSON field 'strength' value must be >= 0, actual value '-1'
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 6, "caseLevel": true, "caseFirst": "bad", "numericOrdering": true} }');
ERROR:  unable to parse collation :: caused by :: BSON field 'strength' value must be <= 5, actual value '6'
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "abcd", "strength" : 1, "caseLevel": true, "caseFirst": "upper", "numericOrdering": true} }');
ERROR:  unable to parse collation :: caused by :: Field 'locale' is invalid in: { locale: "abcd", strength: 1 }.
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "fr_FR", "strength" : 1, "caseLevel": true, "caseFirst": "lower", "numericOrdering": true} }');
ERROR:  unable to parse collation :: caused by :: Field 'locale' is invalid in: { locale: "fr_FR", strength: 1 }.
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1, "caseLevel": true, "caseFirst": "upper", "numericOrdering": true, "alternate": "shifted", "backwards" : "0"} }');
ERROR:  unable to parse collation :: caused by :: BSON field 'collation.backwards' is the wrong type 'string', expected type 'bool'
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1, "caseLevel": true, "caseFirst": "lower", "numericOrdering": true, "alternate": "non-ignorable", "backwards" : true, "normalization" : 1} }');
ERROR:  unable to parse collation :: caused by :: BSON field 'collation.normalization' is the wrong type 'int', expected type 'bool'
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1, "caseLevel": true, "caseFirst": "lower", "numericOrdering": true, "alternate": "non-ignorable", "backwards" : true, "normalization" : true} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 0.9 } }');
ERROR:  unable to parse collation :: caused by :: Enumeration value '0' for field 'collation.strength' is not a valid value
-- (10) collation variations
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 2, "caseLevel": false, "caseFirst": "lower", "numericOrdering": true } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "4" }, "a" : "CaT" }
 { "_id" : { "$numberInt" : "5" }, "b" : "Dog" }
 { "_id" : { "$numberInt" : "6" }, "b" : "DoG" }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1, "caseLevel": true, "caseFirst": "lower", "numericOrdering": true} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "fr", "strength" : 1, "caseLevel": false, "caseFirst": "lower", "numericOrdering": true} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "4" }, "a" : "CaT" }
 { "_id" : { "$numberInt" : "5" }, "b" : "Dog" }
 { "_id" : { "$numberInt" : "6" }, "b" : "DoG" }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "de", "strength" : 1, "caseLevel": false, "caseFirst": "lower", "numericOrdering": true} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "4" }, "a" : "CaT" }
 { "_id" : { "$numberInt" : "5" }, "b" : "Dog" }
 { "_id" : { "$numberInt" : "6" }, "b" : "DoG" }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search2", "filter": { "$or" : [{ "a": { "$eq": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "bn", "strength" : 1, "caseLevel": false, "caseFirst": "lower", "numericOrdering": true} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "4" }, "a" : "CaT" }
 { "_id" : { "$numberInt" : "5" }, "b" : "Dog" }
 { "_id" : { "$numberInt" : "6" }, "b" : "DoG" }
(5 rows)

-- collation with sort/order by
SELECT documentdb_api.insert_one('db', 'coll_order_tests0', '{"_id": "CaT", "a": "cat", "b": "CaT"}');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_order_tests0', '{"_id": "CAt", "a": "cat", "b": "CAt"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_order_tests0', '{"_id": "CAT", "a": "cat", "b": "CAT"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_order_tests0', '{"_id": "cAT", "a": "cat", "b": "cAT"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests0", "filter": { "a": {"$lte": "cat"} }, "sort": { "b": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 3 } }');
                  document                   
---------------------------------------------------------------------
 { "_id" : "cAT", "a" : "cat", "b" : "cAT" }
 { "_id" : "CaT", "a" : "cat", "b" : "CaT" }
 { "_id" : "CAt", "a" : "cat", "b" : "CAt" }
 { "_id" : "CAT", "a" : "cat", "b" : "CAT" }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests0", "filter": { "a": {"$lte": "cat"} }, "sort": { "b": -1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 3 } }');
                  document                   
---------------------------------------------------------------------
 { "_id" : "CAT", "a" : "cat", "b" : "CAT" }
 { "_id" : "CAt", "a" : "cat", "b" : "CAt" }
 { "_id" : "CaT", "a" : "cat", "b" : "CaT" }
 { "_id" : "cAT", "a" : "cat", "b" : "cAT" }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests0", "filter": { "a": {"$lte": "cat"} }, "sort": { "b": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1, "caseLevel": true, "caseFirst": "upper" } }');
                  document                   
---------------------------------------------------------------------
 { "_id" : "CAT", "a" : "cat", "b" : "CAT" }
 { "_id" : "CAt", "a" : "cat", "b" : "CAt" }
 { "_id" : "CaT", "a" : "cat", "b" : "CaT" }
 { "_id" : "cAT", "a" : "cat", "b" : "cAT" }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests0", "filter": { "a": {"$lte": "cat"} }, "sort": { "b": -1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1, "caseLevel": true, "caseFirst": "upper" } }');
                  document                   
---------------------------------------------------------------------
 { "_id" : "cAT", "a" : "cat", "b" : "cAT" }
 { "_id" : "CaT", "a" : "cat", "b" : "CaT" }
 { "_id" : "CAt", "a" : "cat", "b" : "CAt" }
 { "_id" : "CAT", "a" : "cat", "b" : "CAT" }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests0", "filter": { "a": {"$gte": "cat"} }, "sort": { "b": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1, "caseLevel": true, "caseFirst": "lower" } }');
                  document                   
---------------------------------------------------------------------
 { "_id" : "cAT", "a" : "cat", "b" : "cAT" }
 { "_id" : "CaT", "a" : "cat", "b" : "CaT" }
 { "_id" : "CAt", "a" : "cat", "b" : "CAt" }
 { "_id" : "CAT", "a" : "cat", "b" : "CAT" }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests0", "filter": { "a": {"$gte": "cat"} }, "sort": { "b": -1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1, "caseLevel": true, "caseFirst": "lower" } }');
                  document                   
---------------------------------------------------------------------
 { "_id" : "CAT", "a" : "cat", "b" : "CAT" }
 { "_id" : "CAt", "a" : "cat", "b" : "CAt" }
 { "_id" : "CaT", "a" : "cat", "b" : "CaT" }
 { "_id" : "cAT", "a" : "cat", "b" : "cAT" }
(4 rows)

-- collation with sort/order by with collation-aware _id
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests0", "filter": { "a": {"$lte": "cat"} }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 3 } }');
                  document                   
---------------------------------------------------------------------
 { "_id" : "cAT", "a" : "cat", "b" : "cAT" }
 { "_id" : "CaT", "a" : "cat", "b" : "CaT" }
 { "_id" : "CAt", "a" : "cat", "b" : "CAt" }
 { "_id" : "CAT", "a" : "cat", "b" : "CAT" }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests0", "filter": { "a": {"$lte": "cat"} }, "sort": { "_id": -1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 3 } }');
                  document                   
---------------------------------------------------------------------
 { "_id" : "CAT", "a" : "cat", "b" : "CAT" }
 { "_id" : "CAt", "a" : "cat", "b" : "CAt" }
 { "_id" : "CaT", "a" : "cat", "b" : "CaT" }
 { "_id" : "cAT", "a" : "cat", "b" : "cAT" }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests0", "filter": { "a": {"$lte": "cat"} }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1, "caseLevel": true, "caseFirst": "upper" } }');
                  document                   
---------------------------------------------------------------------
 { "_id" : "CAT", "a" : "cat", "b" : "CAT" }
 { "_id" : "CAt", "a" : "cat", "b" : "CAt" }
 { "_id" : "CaT", "a" : "cat", "b" : "CaT" }
 { "_id" : "cAT", "a" : "cat", "b" : "cAT" }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests0", "filter": { "a": {"$lte": "cat"} }, "sort": { "_id": -1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1, "caseLevel": true, "caseFirst": "upper" } }');
                  document                   
---------------------------------------------------------------------
 { "_id" : "cAT", "a" : "cat", "b" : "cAT" }
 { "_id" : "CaT", "a" : "cat", "b" : "CaT" }
 { "_id" : "CAt", "a" : "cat", "b" : "CAt" }
 { "_id" : "CAT", "a" : "cat", "b" : "CAT" }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests0", "filter": { "a": {"$gte": "cat"} }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1, "caseLevel": true, "caseFirst": "lower" } }');
                  document                   
---------------------------------------------------------------------
 { "_id" : "cAT", "a" : "cat", "b" : "cAT" }
 { "_id" : "CaT", "a" : "cat", "b" : "CaT" }
 { "_id" : "CAt", "a" : "cat", "b" : "CAt" }
 { "_id" : "CAT", "a" : "cat", "b" : "CAT" }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests0", "filter": { "a": {"$gte": "cat"} }, "sort": { "_id": -1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1, "caseLevel": true, "caseFirst": "lower" } }');
                  document                   
---------------------------------------------------------------------
 { "_id" : "CAT", "a" : "cat", "b" : "CAT" }
 { "_id" : "CAt", "a" : "cat", "b" : "CAt" }
 { "_id" : "CaT", "a" : "cat", "b" : "CaT" }
 { "_id" : "cAT", "a" : "cat", "b" : "cAT" }
(4 rows)

-- collation with sort/order by: numericOrdering is respected
SELECT documentdb_api.insert_one('db', 'coll_order_tests1', '{"_id": 1, "a": "cat", "b": "10"}');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_order_tests1', '{"_id": 2, "a": "cat", "b": "2"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_order_tests1', '{"_id": 3, "a": "cat", "b": "3"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests1", "filter": { "a": "cat" }, "sort": { "b": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "numericOrdering" : false } }');
                          document                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "b" : "10" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat", "b" : "2" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat", "b" : "3" }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests1", "filter": { "a": "cat" }, "sort": { "b": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "numericOrdering" : true } }');
                          document                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : "cat", "b" : "2" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat", "b" : "3" }
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "b" : "10" }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests1", "filter": { "a": "cat" }, "sort": { "b": -1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "numericOrdering" : false } }');
                          document                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "cat", "b" : "3" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat", "b" : "2" }
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "b" : "10" }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_order_tests1", "filter": { "a": "cat" }, "sort": { "b": -1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "numericOrdering" : true } }');
                          document                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "b" : "10" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cat", "b" : "3" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat", "b" : "2" }
(3 rows)

-- collation with sort/order by: setWindowFields
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "coll_order_tests1", "pipeline":  [{"$setWindowFields": { "sortBy": {"b": -1}, "output": {"res": { "$push": "$b", "window": {"documents": ["unbounded", "unbounded"]}}}}}], "collation": { "locale": "en", "numericOrdering" : false } }');
ERROR:  collation is not supported in the $setWindowFields stage yet.
SELECT document FROM documentdb_api_catalog.bson_aggregation_pipeline('db',
    '{ "aggregate": "coll_order_tests1", "pipeline":  [{"$setWindowFields": { "sortBy": {"b": -1}, "output": {"res": { "$push": "$b", "window": {"documents": ["unbounded", "unbounded"]}}}}}], "collation": { "locale": "en", "numericOrdering" : true } }');
ERROR:  collation is not supported in the $setWindowFields stage yet.
-- (11) Unsupported scenarios
SELECT documentdb_api.find_and_modify('fam', '{"findAndModify": "ci_search2", "query": {"a": 1}, "update": {"_id": 1, "b": 1}, "collation" : {"locale" : "en", "strength": 1} }');
ERROR:  findAndModify.collation is not implemented yet
SELECT documentdb_api.update('update', '{"update":"ci_search2", "updates":[{"q":{"_id": 134111, "b": [ 5, 2, 4 ] },"u":{"$set" : {"b.$[a]":3} },"upsert":true, "collation" : {"locale" : "en", "strength": 1}, "arrayFilters": [ { "a": 2 } ]}]}');
ERROR:  BSON field 'update.updates.collation' is not yet supported
SELECT documentdb_api_internal.create_indexes_non_concurrently('db', '{"createIndexes": "ci_search2", "indexes": [{"key": {"asparse": 1}, "name": "my_sparse_idx1", "sparse": true, "collation" : {"locale" : "en", "strength": 1}}]}', TRUE);
ERROR:  Error in specification { "key" : { "asparse" : 1 }, "name" : "my_sparse_idx1", "sparse" : true, "collation" : { "locale" : "en", "strength" : 1 } }:createIndex.collation has not been implemented yet
-- (12) Test Id filters respect collation
SELECT documentdb_api.insert_one('db', 'ci_search3', '{ "_id": "Cat" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search3', '{ "_id": "dog" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search3', '{ "_id": "cat" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search3', '{ "_id": "CaT" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search3', '{ "_id": "Dog" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search3', '{ "_id": "DoG" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search3', '{ "_id": { "a" : "cat" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search3',' { "_id": { "a": "CAT"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search3', '{ "a": { "a": "Dog" } } ');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'ci_search3', '{ "_id": [ "cat", "CAT "] }');
                                                                                                               insert_one                                                                                                               
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "0" }, "ok" : { "$numberDouble" : "1.0" }, "writeErrors" : [ { "index" : { "$numberInt" : "0" }, "code" : { "$numberInt" : "16777245" }, "errmsg" : "The '_id' field value must not be a type of array" } ] }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search3", "filter": { "$or" : [{ "_id": { "$eq": "cat" } }, { "_id": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
     document      
---------------------------------------------------------------------
 { "_id" : "Cat" }
 { "_id" : "cat" }
 { "_id" : "CaT" }
 { "_id" : "dog" }
 { "_id" : "Dog" }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search3", "filter": { "$or" : [{ "_id.a": { "$eq": "cat" } }, { "_id.a": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
          document           
---------------------------------------------------------------------
 { "_id" : { "a" : "cat" } }
 { "_id" : { "a" : "CAT" } }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF)SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search3", "filter": { "$or" : [{ "_id.a": { "$eq": "cat" } }, { "_id.a": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                        QUERY PLAN                                                                                                                                                                                                                                                         
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_7994_7990072 collection WHERE (documentdb_api_catalog.bson_dollar_in(document, '{ "_id.a" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '7994'::bigint)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Bitmap Heap Scan on documentdb_data.documents_7994_7990072 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Recheck Cond: (collection.shard_key_value = '7994'::bigint)
                           Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "_id.a" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection.shard_key_value = '7994'::bigint)
(18 rows)

SELECT documentdb_api.shard_collection('db', 'ci_search', '{ "_id": "hashed" }', false);
NOTICE:  Skipping Sharding for collection db.ci_search as the same options were passed in.
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search3", "filter": { "$or" : [{ "_id": { "$eq": "cat" } }, { "_id": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
     document      
---------------------------------------------------------------------
 { "_id" : "Cat" }
 { "_id" : "cat" }
 { "_id" : "CaT" }
 { "_id" : "dog" }
 { "_id" : "Dog" }
(5 rows)

EXPLAIN (VERBOSE ON, COSTS OFF)SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search3", "filter": { "$or" : [{ "_id": { "$eq": "cat" } }, { "_id": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_7994_7990072 collection WHERE (documentdb_api_catalog.bson_dollar_in(document, '{ "_id" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '7994'::bigint)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Bitmap Heap Scan on documentdb_data.documents_7994_7990072 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Recheck Cond: (collection.shard_key_value = '7994'::bigint)
                           Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "_id" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection.shard_key_value = '7994'::bigint)
(18 rows)

END;
BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search3", "filter": { "$or" : [{ "_id.a": { "$eq": "cat" } }, { "_id.a": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
          document           
---------------------------------------------------------------------
 { "_id" : { "a" : "cat" } }
 { "_id" : { "a" : "CAT" } }
(2 rows)

END;
EXPLAIN(VERBOSE ON, COSTS OFF)SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search3", "filter": { "$or" : [{ "_id.a": { "$eq": "cat" } }, { "_id.a": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                        QUERY PLAN                                                                                                                                                                                                                                                         
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_7994_7990072 collection WHERE (documentdb_api_catalog.bson_dollar_in(document, '{ "_id.a" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '7994'::bigint)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Bitmap Heap Scan on documentdb_data.documents_7994_7990072 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Recheck Cond: (collection.shard_key_value = '7994'::bigint)
                           Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "_id.a" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection.shard_key_value = '7994'::bigint)
(18 rows)

-- (12) Check index with partial filter expression with collation
SELECT documentdb_api.insert_one('db','ci_search4', '{"_id": 1, "a" : { "b" : "DOG" }}', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search4', '{"_id": 2, "a" : { "b" : "dog" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search4', '{"_id": 3, "a" : { "b" : "Cat" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search4', '{"_id": 4, "a" : { "b" : "Dog" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search4', '{"_id": 5, "a" : { "b" : "cAT" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search4', '{"_id": 6, "a" : { "b" : "DoG" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search4', '{"_id": 7, "a" : { "b" : "DOG" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "ci_search4",
     "indexes": [
       {
         "key": {"a.b": 1}, "name": "my_idx_1",
         "partialFilterExpression":
         {
           "a.b": {"$eq": "dog" }
         },
         "collation" : {"locale" : "en", "strength" : 2}
       }
     ]
   }',
   TRUE
);
ERROR:  Error in specification { "key" : { "a.b" : 1 }, "name" : "my_idx_1", "partialFilterExpression" : { "a.b" : { "$eq" : "dog" } }, "collation" : { "locale" : "en", "strength" : 2 } }:createIndex.collation has not been implemented yet
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "ci_search4",
     "indexes": [
       {
         "key": {"a.b": 1}, "name": "my_idx_1",
         "partialFilterExpression":
         {
           "a.b": {"$eq": "dog" }
         }
       }
     ]
   }',
   TRUE
);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

BEGIN;
SET LOCAL seq_page_cost TO 100;
SET LOCAL documentdb.forceUseIndexIfAvailable to true;
-- query pushed to the index when no collattion
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search4", "filter": { "a.b": { "$eq": "dog" }, "a": { "$ne" :  null } } }');
                         document                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : "dog" } }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search4", "filter": { "a.b": { "$eq": "dog" }, "a": { "$ne" :  null } } }');
                                                                                                                                                                     QUERY PLAN                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_7995_7990095 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a.b" : "dog" }'::documentdb_core.bsonquery) AND documentdb_api_catalog.bson_dollar_ne(document, '{ "a" : null }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '7995'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_7995_7990095 collection
               Output: document
               Recheck Cond: (collection.document OPERATOR(documentdb_api_catalog.#=) '{ "a.b" : "dog" }'::documentdb_core.bsonquery)
               Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a.b" : "dog" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@!=) '{ "a" : null }'::documentdb_core.bson))
               ->  Bitmap Index Scan on my_idx_1
(12 rows)

ROLLBACK;
BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
SET LOCAL seq_page_cost TO 100;
SET LOCAL documentdb.forceUseIndexIfAvailable to true;
-- query not pushed to the index when collattion is specified
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search4", "filter": { "a.b": { "$eq": "dog" }, "a": { "$ne" :  null } }, "collation": { "locale": "en", "strength" : 1}  }');
                         document                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : "DOG" } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : "dog" } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : "Dog" } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : "DoG" } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : "DOG" } }
(5 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search4", "filter": { "a.b": { "$eq": "dog" }, "a": { "$ne" :  null } }, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_7995_7990095 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a.b" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_catalog.bson_dollar_ne(document, '{ "a" : null, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '7995'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using _id_ on documentdb_data.documents_7995_7990095 collection
               Output: document
               Index Cond: (collection.shard_key_value = '7995'::bigint)
               Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a.b" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@!=) '{ "a" : null, "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(11 rows)

END;
SELECT documentdb_api.shard_collection('db', 'ci_search4', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search4", "filter": { "$or" : [{ "a.b": { "$eq": "cat" } }, { "a.b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                         document                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : "DOG" } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : "dog" } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : "Cat" } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : "Dog" } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : "cAT" } }
(5 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search4", "filter": { "$or" : [{ "a.b": { "$eq": "cat" } }, { "a.b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_7995_7990104 collection WHERE documentdb_api_catalog.bson_dollar_in(document, '{ "a.b" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_7995_7990104 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "a.b" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(20 rows)

END;
-- (13) Check index behavior with collation (TODO: update when index pushdown of collation is supported)
SELECT documentdb_api.insert_one('db','ci_search5', '{"_id": 1, "a" : { "b" : "DOG" }}', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search5', '{"_id": 2, "a" : { "b" : "dog" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search5', '{"_id": 3, "a" : { "b" : "Cat" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search5', '{"_id": 4, "a" : { "b" : "Dog" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search5', '{"_id": 5, "a" : { "b" : "cAT" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search5', '{"_id": 6, "a" : { "b" : "DoG" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search5', '{"_id": 7, "a" : { "b" : "DOG" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "ci_search5",
     "indexes": [
       {
         "key": {"a.b": 1}, "name": "my_idx_1",
         "collation" : {"locale" : "en", "strength" : 2}
       }
     ]
   }',
   TRUE
);
ERROR:  Error in specification { "key" : { "a.b" : 1 }, "name" : "my_idx_1", "collation" : { "locale" : "en", "strength" : 2 } }:createIndex.collation has not been implemented yet
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "ci_search5",
     "indexes": [
       {
         "key": {"a.b": 1}, "name": "my_idx_1"
       }
     ]
   }',
   TRUE
);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

BEGIN;
SET LOCAL seq_page_cost TO 100;
SET LOCAL documentdb.forceUseIndexIfAvailable to true;
-- query pushed to the index when no collattion
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search5", "filter": { "$or" : [{ "a.b": { "$eq": "cat" } }, { "a.b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5 }');
                         document                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : "DOG" } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : "DOG" } }
(2 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search5", "filter": { "$or" : [{ "a.b": { "$eq": "cat" } }, { "a.b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5 }');
                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_7996_7990114 collection WHERE (documentdb_api_catalog.bson_dollar_in(document, '{ "a.b" : [ "cat", "DOG" ] }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '7996'::bigint)) ORDER BY (documentdb_api_catalog.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) NULLS FIRST LIMIT '5'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_catalog.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               ->  Sort
                     Output: document, (documentdb_api_catalog.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
                     Sort Key: (documentdb_api_catalog.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) NULLS FIRST
                     ->  Index Scan using my_idx_1 on documentdb_data.documents_7996_7990114 collection
                           Output: document, documentdb_api_catalog.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)
                           Index Cond: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "a.b" : [ "cat", "DOG" ] }'::documentdb_core.bson)
(15 rows)

ROLLBACK;
BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
SET LOCAL seq_page_cost TO 100;
SET LOCAL documentdb.forceUseIndexIfAvailable to true;
-- query not pushed to the index when collation is specified
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search5", "filter": { "$or" : [{ "a.b": { "$eq": "cat" } }, { "a.b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                         document                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : "DOG" } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : "dog" } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : "Cat" } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : "Dog" } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : "cAT" } }
(5 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search5", "filter": { "$or" : [{ "a.b": { "$eq": "cat" } }, { "a.b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_7996_7990114 collection WHERE (documentdb_api_catalog.bson_dollar_in(document, '{ "a.b" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '7996'::bigint)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Index Scan using _id_ on documentdb_data.documents_7996_7990114 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Index Cond: (collection.shard_key_value = '7996'::bigint)
                           Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "a.b" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(16 rows)

END;
-- range query with index on path "a.b"
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search5", "filter": { "a.b": { "$gt": "CAT" }, "a.b" : {"$lte" : "DOG"} }, "collation": { "locale": "en", "strength" : 1.93 } }');
                         document                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : "DOG" } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : "dog" } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : "Dog" } }
 { "_id" : { "$numberInt" : "6" }, "a" : { "b" : "DoG" } }
 { "_id" : { "$numberInt" : "7" }, "a" : { "b" : "DOG" } }
(5 rows)

BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
EXPLAIN(VERBOSE ON, COSTS OFF)SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search5", "filter": { "a.b": { "$gt": "CAT" }, "a.b" : {"$lte" : "DOG"} }, "collation": { "locale": "en", "strength" : 1.93 } }');
                                                                                                                                                                                                         QUERY PLAN                                                                                                                                                                                                         
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_7996_7990114 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "a.b" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#<=) '{ "a.b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '7996'::bigint))
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documentdb_data.documents_7996_7990114 collection
               Output: document
               Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>) '{ "a.b" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@<=) '{ "a.b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(10 rows)

END;
SELECT documentdb_api.shard_collection('db', 'ci_search5', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
SET LOCAL seq_page_cost TO 100;
SET LOCAL documentdb.forceUseIndexIfAvailable to true;
SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search5", "filter": { "$or" : [{ "a.b": { "$eq": "cat" } }, { "a.b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                         document                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : { "b" : "DOG" } }
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : "dog" } }
 { "_id" : { "$numberInt" : "3" }, "a" : { "b" : "Cat" } }
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : "Dog" } }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : "cAT" } }
(5 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "ci_search5", "filter": { "$or" : [{ "a.b": { "$eq": "cat" } }, { "a.b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_7996_7990128 collection WHERE documentdb_api_catalog.bson_dollar_in(document, '{ "a.b" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_7996_7990128 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "a.b" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(20 rows)

END;
-- nested pipleline tests
SELECT documentdb_api.insert_one('db','ci_search6', '{"_id": "DOG", "a" : { "b" : "DOG" }}', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search6', '{"_id": "dog", "a" : { "b" : "dog" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search6', '{"_id": "Cat", "a" : { "b" : "Cat" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search6', '{"_id": "Dog", "a" : { "b" : "Dog" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search6', '{"_id": "cAT", "a" : { "b" : "cAT" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search6', '{"_id": "DoG", "a" : { "b" : "DoG" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search6', '{"_id": "dOg", "a" : { "b" : "dOg" }}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- lookup with id join (collation aware)
SELECT document FROM bson_aggregation_pipeline('db', 
    '{ "aggregate": "ci_search6", "pipeline": [ { "$lookup": { "from": "ci_search6", "as": "matched_docs", "localField": "_id", "foreignField": "_id", "pipeline": [ { "$match": { "$or" : [ { "a.b": "cat" }, { "a.b": "dog" } ] } } ] } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                    document                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : "DOG", "a" : { "b" : "DOG" }, "matched_docs" : [ { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "dog", "a" : { "b" : "dog" }, "matched_docs" : [ { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "Cat", "a" : { "b" : "Cat" }, "matched_docs" : [ { "_id" : "Cat", "a" : { "b" : "Cat" } }, { "_id" : "cAT", "a" : { "b" : "cAT" } } ] }
 { "_id" : "Dog", "a" : { "b" : "Dog" }, "matched_docs" : [ { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "cAT", "a" : { "b" : "cAT" }, "matched_docs" : [ { "_id" : "Cat", "a" : { "b" : "Cat" } }, { "_id" : "cAT", "a" : { "b" : "cAT" } } ] }
 { "_id" : "DoG", "a" : { "b" : "DoG" }, "matched_docs" : [ { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "dOg", "a" : { "b" : "dOg" }, "matched_docs" : [ { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
(7 rows)

BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', 
    '{ "aggregate": "ci_search6", "pipeline": [ { "$lookup": { "from": "ci_search6", "as": "matched_docs", "localField": "_id", "foreignField": "_id", "pipeline": [ { "$match": { "$or" : [ { "a.b": "cat" }, { "a.b": "dog" } ] } } ] } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(lookup_stage_1.document, "lookupRight_stage_1".document, true) AS document FROM ((SELECT collection.document, documentdb_api_internal.bson_dollar_lookup_extract_filter_expression(collection.document, '{ "_id" : "_id", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AS lookup_filter FROM documentdb_data.documents_7997_7990140 collection WHERE (collection.shard_key_value OPERATOR(pg_catalog.=) '7997'::bigint)) lookup_stage_1 JOIN LATERAL (SELECT COALESCE(documentdb_api_catalog.bson_array_agg(lookup_right_query_stage_0.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson) AS document FROM (SELECT collection_0_1.document FROM documentdb_data.documents_7997_7990140 collection_0_1 WHERE (documentdb_api_catalog.bson_dollar_in(collection_0_1.document, '{ "a.b" : [ "cat", "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection_0_1.shard_key_value OPERATOR(pg_catalog.=) '7997'::bigint))) lookup_right_query_stage_0 WHERE documentdb_api_internal.bson_dollar_lookup_join_filter(lookup_right_query_stage_0.document, lookup_stage_1.lookup_filter, '_id'::text)) "lookupRight_stage_1" ON (true))
         Node: host=localhost port=58070 dbname=regression
         ->  Nested Loop
               Output: documentdb_api_internal.bson_dollar_merge_documents(collection.document, (COALESCE(documentdb_api_catalog.bson_array_agg(collection_0_1.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson)), true)
               ->  Bitmap Heap Scan on documentdb_data.documents_7997_7990140 collection
                     Output: collection.shard_key_value, collection.object_id, collection.document
                     Recheck Cond: (collection.shard_key_value = '7997'::bigint)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '7997'::bigint)
               ->  Aggregate
                     Output: COALESCE(documentdb_api_catalog.bson_array_agg(collection_0_1.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson)
                     ->  Bitmap Heap Scan on documentdb_data.documents_7997_7990140 collection_0_1
                           Output: collection_0_1.shard_key_value, collection_0_1.object_id, collection_0_1.document
                           Recheck Cond: (collection_0_1.shard_key_value = '7997'::bigint)
                           Filter: ((collection_0_1.document OPERATOR(documentdb_api_catalog.@*=) '{ "a.b" : [ "cat", "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_1.document, documentdb_api_internal.bson_dollar_lookup_extract_filter_expression(collection.document, '{ "_id" : "_id", "collation" : "en-u-ks-level1" }'::documentdb_core.bson), '_id'::text))
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection_0_1.shard_key_value = '7997'::bigint)
(22 rows)

END;
-- lookup with id join optimized (explicitly asked to make _id join collation agnostic)
BEGIN;
SET LOCAL documentdb.enableLookupIdJoinOptimizationOnCollation to true;
SET LOCAL documentdb_core.enablecollation TO on;
SELECT document FROM bson_aggregation_pipeline('db', 
    '{ "aggregate": "ci_search6", "pipeline": [ { "$lookup": { "from": "ci_search6", "as": "matched_docs", "localField": "_id", "foreignField": "_id", "pipeline": [ { "$match": { "$or" : [ { "a.b": "cat" }, { "a.b": "dog" } ] } } ] } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                document                                                 
---------------------------------------------------------------------
 { "_id" : "DOG", "a" : { "b" : "DOG" }, "matched_docs" : [ { "_id" : "DOG", "a" : { "b" : "DOG" } } ] }
 { "_id" : "dog", "a" : { "b" : "dog" }, "matched_docs" : [ { "_id" : "dog", "a" : { "b" : "dog" } } ] }
 { "_id" : "Cat", "a" : { "b" : "Cat" }, "matched_docs" : [ { "_id" : "Cat", "a" : { "b" : "Cat" } } ] }
 { "_id" : "Dog", "a" : { "b" : "Dog" }, "matched_docs" : [ { "_id" : "Dog", "a" : { "b" : "Dog" } } ] }
 { "_id" : "cAT", "a" : { "b" : "cAT" }, "matched_docs" : [ { "_id" : "cAT", "a" : { "b" : "cAT" } } ] }
 { "_id" : "DoG", "a" : { "b" : "DoG" }, "matched_docs" : [ { "_id" : "DoG", "a" : { "b" : "DoG" } } ] }
 { "_id" : "dOg", "a" : { "b" : "dOg" }, "matched_docs" : [ { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
(7 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', 
    '{ "aggregate": "ci_search6", "pipeline": [ { "$lookup": { "from": "ci_search6", "as": "matched_docs", "localField": "_id", "foreignField": "_id", "pipeline": [ { "$match": { "$or" : [ { "a.b": "cat" }, { "a.b": "dog" } ] } } ] } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents("left", (SELECT COALESCE(documentdb_api_catalog.bson_array_agg(lookup_subpipeline_substage_0.lookup_unwind, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson) AS "funcName" FROM documentdb_api_catalog.bson_lookup_unwind(lookup_non_inlined_stage_1."right", 'matched_docs'::text) lookup_subpipeline_substage_0(lookup_unwind) WHERE documentdb_api_catalog.bson_dollar_in(lookup_subpipeline_substage_0.lookup_unwind, '{ "a.b" : [ "cat", "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)), true) AS document FROM (SELECT lookup_stage_1.document AS "left", "lookupRight_stage_1".document AS "right" FROM ((SELECT collection.document, collection.object_id AS lookup_filter FROM documentdb_data.documents_7997_7990140 collection WHERE (collection.shard_key_value OPERATOR(pg_catalog.=) '7997'::bigint)) lookup_stage_1 JOIN LATERAL (SELECT COALESCE(documentdb_api_catalog.bson_array_agg(lookup_right_query_stage_0.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson) AS document FROM (SELECT collection_0_1.document, collection_0_1.object_id AS "objectId" FROM documentdb_data.documents_7997_7990140 collection_0_1 WHERE (collection_0_1.shard_key_value OPERATOR(pg_catalog.=) '7997'::bigint)) lookup_right_query_stage_0 WHERE (lookup_right_query_stage_0."objectId" OPERATOR(documentdb_core.=) lookup_stage_1.lookup_filter)) "lookupRight_stage_1" ON (true))) lookup_non_inlined_stage_1
         Node: host=localhost port=58070 dbname=regression
         ->  Nested Loop
               Output: documentdb_api_internal.bson_dollar_merge_documents(collection.document, (SubPlan 1), true)
               ->  Bitmap Heap Scan on documentdb_data.documents_7997_7990140 collection
                     Output: collection.shard_key_value, collection.object_id, collection.document
                     Recheck Cond: (collection.shard_key_value = '7997'::bigint)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '7997'::bigint)
               ->  Aggregate
                     Output: COALESCE(documentdb_api_catalog.bson_array_agg(collection_0_1.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson)
                     ->  Index Scan using _id_ on documentdb_data.documents_7997_7990140 collection_0_1
                           Output: collection_0_1.shard_key_value, collection_0_1.object_id, collection_0_1.document
                           Index Cond: ((collection_0_1.shard_key_value = '7997'::bigint) AND (collection_0_1.object_id OPERATOR(documentdb_core.=) collection.object_id))
               SubPlan 1
                 ->  Aggregate
                       Output: COALESCE(documentdb_api_catalog.bson_array_agg(lookup_subpipeline_substage_0.lookup_unwind, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson)
                       ->  Function Scan on documentdb_api_catalog.bson_lookup_unwind lookup_subpipeline_substage_0
                             Output: lookup_subpipeline_substage_0.lookup_unwind
                             Function Call: documentdb_api_catalog.bson_lookup_unwind((COALESCE(documentdb_api_catalog.bson_array_agg(collection_0_1.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson)), 'matched_docs'::text)
                             Filter: documentdb_api_catalog.bson_dollar_in(lookup_subpipeline_substage_0.lookup_unwind, '{ "a.b" : [ "cat", "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(26 rows)

END;
-- lookup with non-id join (collation aware)
SELECT document FROM bson_aggregation_pipeline('db', 
    '{ "aggregate": "ci_search6", "pipeline": [ { "$lookup": { "from": "ci_search6", "as": "matched_docs", "localField": "a.b", "foreignField": "a.b", "pipeline": [ { "$match": { "$or" : [ { "a.b": "cat" }, { "a.b": "dog" } ] } } ] } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                    document                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : "DOG", "a" : { "b" : "DOG" }, "matched_docs" : [ { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "dog", "a" : { "b" : "dog" }, "matched_docs" : [ { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "Cat", "a" : { "b" : "Cat" }, "matched_docs" : [ { "_id" : "Cat", "a" : { "b" : "Cat" } }, { "_id" : "cAT", "a" : { "b" : "cAT" } } ] }
 { "_id" : "Dog", "a" : { "b" : "Dog" }, "matched_docs" : [ { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "cAT", "a" : { "b" : "cAT" }, "matched_docs" : [ { "_id" : "Cat", "a" : { "b" : "Cat" } }, { "_id" : "cAT", "a" : { "b" : "cAT" } } ] }
 { "_id" : "DoG", "a" : { "b" : "DoG" }, "matched_docs" : [ { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "dOg", "a" : { "b" : "dOg" }, "matched_docs" : [ { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
(7 rows)

-- lookup with non-id join (collation aware - explain)
BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', 
    '{ "aggregate": "ci_search6", "pipeline": [ { "$lookup": { "from": "ci_search6", "as": "matched_docs", "localField": "a.b", "foreignField": "a.b", "pipeline": [ { "$match": { "$or" : [ { "a.b": "cat" }, { "a.b": "dog" } ] } } ] } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(lookup_stage_1.document, "lookupRight_stage_1".document, true) AS document FROM ((SELECT collection.document, documentdb_api_internal.bson_dollar_lookup_extract_filter_expression(collection.document, '{ "a.b" : "a.b", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AS lookup_filter FROM documentdb_data.documents_7997_7990140 collection WHERE (collection.shard_key_value OPERATOR(pg_catalog.=) '7997'::bigint)) lookup_stage_1 JOIN LATERAL (SELECT COALESCE(documentdb_api_catalog.bson_array_agg(lookup_right_query_stage_0.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson) AS document FROM (SELECT collection_0_1.document FROM documentdb_data.documents_7997_7990140 collection_0_1 WHERE (documentdb_api_catalog.bson_dollar_in(collection_0_1.document, '{ "a.b" : [ "cat", "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection_0_1.shard_key_value OPERATOR(pg_catalog.=) '7997'::bigint))) lookup_right_query_stage_0 WHERE documentdb_api_internal.bson_dollar_lookup_join_filter(lookup_right_query_stage_0.document, lookup_stage_1.lookup_filter, 'a.b'::text)) "lookupRight_stage_1" ON (true))
         Node: host=localhost port=58070 dbname=regression
         ->  Nested Loop
               Output: documentdb_api_internal.bson_dollar_merge_documents(collection.document, (COALESCE(documentdb_api_catalog.bson_array_agg(collection_0_1.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson)), true)
               ->  Bitmap Heap Scan on documentdb_data.documents_7997_7990140 collection
                     Output: collection.shard_key_value, collection.object_id, collection.document
                     Recheck Cond: (collection.shard_key_value = '7997'::bigint)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '7997'::bigint)
               ->  Aggregate
                     Output: COALESCE(documentdb_api_catalog.bson_array_agg(collection_0_1.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson)
                     ->  Bitmap Heap Scan on documentdb_data.documents_7997_7990140 collection_0_1
                           Output: collection_0_1.shard_key_value, collection_0_1.object_id, collection_0_1.document
                           Recheck Cond: (collection_0_1.shard_key_value = '7997'::bigint)
                           Filter: ((collection_0_1.document OPERATOR(documentdb_api_catalog.@*=) '{ "a.b" : [ "cat", "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_1.document, documentdb_api_internal.bson_dollar_lookup_extract_filter_expression(collection.document, '{ "a.b" : "a.b", "collation" : "en-u-ks-level1" }'::documentdb_core.bson), 'a.b'::text))
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection_0_1.shard_key_value = '7997'::bigint)
(22 rows)

END;
-- $facet and $unionwith
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search6", "pipeline": [ { "$facet": { "a" : [ { "$match": { "a.b": "cat" } }, { "$count": "catCount" } ], "b" : [ { "$match": { "a.b": "dog" } }, { "$count": "dogCount" } ]  } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}}');
                                                 document                                                 
---------------------------------------------------------------------
 { "a" : [ { "catCount" : { "$numberInt" : "2" } } ], "b" : [ { "dogCount" : { "$numberInt" : "5" } } ] }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search6", "pipeline": [ { "$unionWith": { "coll": "ci_search6", "pipeline" : [ { "$match": { "a.b": "cat" }}] } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                 document                 
---------------------------------------------------------------------
 { "_id" : "DOG", "a" : { "b" : "DOG" } }
 { "_id" : "dog", "a" : { "b" : "dog" } }
 { "_id" : "Cat", "a" : { "b" : "Cat" } }
 { "_id" : "Dog", "a" : { "b" : "Dog" } }
 { "_id" : "cAT", "a" : { "b" : "cAT" } }
 { "_id" : "DoG", "a" : { "b" : "DoG" } }
 { "_id" : "dOg", "a" : { "b" : "dOg" } }
 { "_id" : "Cat", "a" : { "b" : "Cat" } }
 { "_id" : "cAT", "a" : { "b" : "cAT" } }
(9 rows)

-- $graphLookup 
SELECT documentdb_api.insert_one('db','ci_search7', '{"_id": "alice", "pet" : "dog" }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search7', '{"_id": "bob", "pet" : "cat" }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search8', '{"_id": "DOG", "name" : "DOG" }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search8', '{"_id": "dog", "name" : "dog" }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search8', '{"_id": "CAT", "name" : "CAT" }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','ci_search8', '{"_id": "cAT", "name" : "cAT" }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "ci_search7", "pipeline": [ { "$graphLookup": { "from": "ci_search8", "startWith": "$pet", "connectFromField": "name", "connectToField": "_id", "as": "destinations", "depthField": "depth" } } ],  "collation": { "locale": "en", "strength" : 3} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(document, "addFields", true) AS document FROM (SELECT "graphLookupBase_stage_1".document, COALESCE((SELECT COALESCE(documentdb_api_catalog.bson_array_agg(agg_stage_sub_1_0.document, 'destinations'::text), '{ "destinations" : [  ] }'::documentdb_core.bson) AS document FROM (WITH RECURSIVE "graphLookupRecurseStage" AS (SELECT "*TLOCRN*".document, "*TLOCRN*".depth, "*TLOCRN*"."baseDocId", false AS is_cycle, ARRAY[ROW("*TLOCRN*"."baseDocId")] AS path FROM (SELECT collection_0_2.document, '{ "depth" : { "$numberInt" : "0" } }'::documentdb_core.bson AS depth, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson) AS "baseDocId" FROM documentdb_data.documents_7999_7990175 collection_0_2 WHERE ((collection_0_2.shard_key_value OPERATOR(pg_catalog.=) '7999'::bigint) AND documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, "graphLookupBase_stage_1"."inputExpr", '_id'::text))) "*TLOCRN*"(document, depth, "baseDocId") UNION ALL SELECT "*TROCRN*".document, "*TROCRN*".depth, "*TROCRN*"."baseDocId", CASE WHEN (ROW("*TROCRN*"."baseDocId") OPERATOR(pg_catalog.=) ANY ("*TROCRN*".path)) THEN true ELSE false END AS is_cycle, array_cat("*TROCRN*".path, ARRAY[ROW("*TROCRN*"."baseDocId")]) AS path FROM (SELECT collection_0_2.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "depth" : { "$add" : [ "$depth", { "$numberInt" : "1" } ] } }'::documentdb_core.bson) AS depth, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson) AS "baseDocId", "lookupRecursive_stage_1".is_cycle, "lookupRecursive_stage_1".path FROM documentdb_data.documents_7999_7990175 collection_0_2, "graphLookupRecurseStage" "lookupRecursive_stage_1" WHERE ((collection_0_2.shard_key_value OPERATOR(pg_catalog.=) '7999'::bigint) AND documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "_id" : { "$makeArray" : "$name" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level3'::text), '_id'::text))) "*TROCRN*"(document, depth, "baseDocId", is_cycle, path) WHERE ("*TROCRN*".is_cycle OPERATOR(pg_catalog.<>) true)) SELECT DISTINCT ON ("graphLookup_stage_2"."baseDocId") documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth, true) AS document FROM "graphLookupRecurseStage" "graphLookup_stage_2" ORDER BY "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth) agg_stage_sub_1_0), '{ "destinations" : [  ] }'::documentdb_core.bson) AS "addFields" FROM (SELECT collection.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "_id" : { "$makeArray" : "$pet" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level3'::text) AS "inputExpr" FROM documentdb_data.documents_7998_7990152 collection WHERE (collection.shard_key_value OPERATOR(pg_catalog.=) '7998'::bigint)) "graphLookupBase_stage_1") "graphLookup_stage_1"
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_7998_7990152 collection
               Output: documentdb_api_internal.bson_dollar_merge_documents(collection.document, COALESCE((SubPlan 2), '{ "destinations" : [  ] }'::documentdb_core.bson), true)
               Recheck Cond: (collection.shard_key_value = '7998'::bigint)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '7998'::bigint)
               SubPlan 2
                 ->  Aggregate
                       Output: COALESCE(documentdb_api_catalog.bson_array_agg((documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth, true)), 'destinations'::text), '{ "destinations" : [  ] }'::documentdb_core.bson)
                       ->  Unique
                             Output: (documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth, true)), "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                             CTE graphLookupRecurseStage
                               ->  Recursive Union
                                     ->  Bitmap Heap Scan on documentdb_data.documents_7999_7990175 collection_0_2
                                           Output: collection_0_2.document, '{ "depth" : { "$numberInt" : "0" } }'::documentdb_core.bson, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false), false, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false))]
                                           Recheck Cond: (collection_0_2.shard_key_value = '7999'::bigint)
                                           Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "_id" : { "$makeArray" : "$pet" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level3'::text), '_id'::text)
                                           ->  Bitmap Index Scan on _id_
                                                 Index Cond: (collection_0_2.shard_key_value = '7999'::bigint)
                                     ->  Nested Loop
                                           Output: collection_0_2_1.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "depth" : { "$add" : [ "$depth", { "$numberInt" : "1" } ] } }'::documentdb_core.bson), documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false), CASE WHEN (ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false)) = ANY ("lookupRecursive_stage_1".path)) THEN true ELSE false END, array_cat("lookupRecursive_stage_1".path, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false))])
                                           Join Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2_1.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "_id" : { "$makeArray" : "$name" } }'::documentdb_core.bson, false, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level3'::text), '_id'::text)
                                           ->  WorkTable Scan on "graphLookupRecurseStage" "lookupRecursive_stage_1"
                                                 Output: "lookupRecursive_stage_1".document, "lookupRecursive_stage_1".depth, "lookupRecursive_stage_1"."baseDocId", "lookupRecursive_stage_1".is_cycle, "lookupRecursive_stage_1".path
                                                 Filter: (NOT "lookupRecursive_stage_1".is_cycle)
                                           ->  Materialize
                                                 Output: collection_0_2_1.document
                                                 ->  Bitmap Heap Scan on documentdb_data.documents_7999_7990175 collection_0_2_1
                                                       Output: collection_0_2_1.document
                                                       Recheck Cond: (collection_0_2_1.shard_key_value = '7999'::bigint)
                                                       ->  Bitmap Index Scan on _id_
                                                             Index Cond: (collection_0_2_1.shard_key_value = '7999'::bigint)
                             ->  Sort
                                   Output: (documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth, true)), "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                                   Sort Key: "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                                   ->  CTE Scan on "graphLookupRecurseStage" "graphLookup_stage_2"
                                         Output: documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth, true), "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
(43 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "ci_search7", "pipeline": [ { "$graphLookup": { "from": "ci_search8", "startWith": "$pet", "connectFromField": "name", "connectToField": "_id", "as": "destinations", "depthField": "depth" } } ],  "collation": { "locale": "en", "strength" : 3} }');
                                                           document                                                           
---------------------------------------------------------------------
 { "_id" : "alice", "pet" : "dog", "destinations" : [ { "_id" : "dog", "name" : "dog", "depth" : { "$numberInt" : "0" } } ] }
 { "_id" : "bob", "pet" : "cat", "destinations" : [  ] }
(2 rows)

END;
SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "ci_search6", "pipeline": [ { "$graphLookup": { "from": "ci_search6", "startWith": "$a.b", "connectFromField": "a.b", "connectToField": "a.b", "as": "destinations", "depthField": "depth" } } ],  "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                         document                                                                                                                                                                                                                          
---------------------------------------------------------------------
 { "_id" : "DOG", "a" : { "b" : "DOG" }, "destinations" : [ { "_id" : "DOG", "a" : { "b" : "DOG" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "DoG", "a" : { "b" : "DoG" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "Dog", "a" : { "b" : "Dog" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "dOg", "a" : { "b" : "dOg" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "dog", "a" : { "b" : "dog" }, "depth" : { "$numberInt" : "0" } } ] }
 { "_id" : "dog", "a" : { "b" : "dog" }, "destinations" : [ { "_id" : "DOG", "a" : { "b" : "DOG" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "DoG", "a" : { "b" : "DoG" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "Dog", "a" : { "b" : "Dog" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "dOg", "a" : { "b" : "dOg" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "dog", "a" : { "b" : "dog" }, "depth" : { "$numberInt" : "0" } } ] }
 { "_id" : "Cat", "a" : { "b" : "Cat" }, "destinations" : [ { "_id" : "Cat", "a" : { "b" : "Cat" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "cAT", "a" : { "b" : "cAT" }, "depth" : { "$numberInt" : "0" } } ] }
 { "_id" : "Dog", "a" : { "b" : "Dog" }, "destinations" : [ { "_id" : "DOG", "a" : { "b" : "DOG" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "DoG", "a" : { "b" : "DoG" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "Dog", "a" : { "b" : "Dog" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "dOg", "a" : { "b" : "dOg" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "dog", "a" : { "b" : "dog" }, "depth" : { "$numberInt" : "0" } } ] }
 { "_id" : "cAT", "a" : { "b" : "cAT" }, "destinations" : [ { "_id" : "Cat", "a" : { "b" : "Cat" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "cAT", "a" : { "b" : "cAT" }, "depth" : { "$numberInt" : "0" } } ] }
 { "_id" : "DoG", "a" : { "b" : "DoG" }, "destinations" : [ { "_id" : "DOG", "a" : { "b" : "DOG" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "DoG", "a" : { "b" : "DoG" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "Dog", "a" : { "b" : "Dog" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "dOg", "a" : { "b" : "dOg" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "dog", "a" : { "b" : "dog" }, "depth" : { "$numberInt" : "0" } } ] }
 { "_id" : "dOg", "a" : { "b" : "dOg" }, "destinations" : [ { "_id" : "DOG", "a" : { "b" : "DOG" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "DoG", "a" : { "b" : "DoG" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "Dog", "a" : { "b" : "Dog" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "dOg", "a" : { "b" : "dOg" }, "depth" : { "$numberInt" : "0" } }, { "_id" : "dog", "a" : { "b" : "dog" }, "depth" : { "$numberInt" : "0" } } ] }
(7 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "ci_search7", "pipeline": [ { "$graphLookup": { "from": "ci_search8", "startWith": "$pet", "connectFromField": "name", "connectToField": "_id", "as": "destinations", "depthField": "depth" } } ],  "collation": { "locale": "en", "strength" : 1} }');
                                                                                             document                                                                                              
---------------------------------------------------------------------
 { "_id" : "alice", "pet" : "dog", "destinations" : [ { "_id" : "DOG", "name" : "DOG", "depth" : { "$numberInt" : "0" } }, { "_id" : "dog", "name" : "dog", "depth" : { "$numberInt" : "0" } } ] }
 { "_id" : "bob", "pet" : "cat", "destinations" : [ { "_id" : "CAT", "name" : "CAT", "depth" : { "$numberInt" : "0" } }, { "_id" : "cAT", "name" : "cAT", "depth" : { "$numberInt" : "0" } } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "ci_search7", "pipeline": [ { "$graphLookup": { "from": "ci_search8", "startWith": "$pet", "connectFromField": "name", "connectToField": "_id", "as": "destinations", "depthField": "depth" } } ],  "collation": { "locale": "en", "strength" : 2} }');
                                                                                             document                                                                                              
---------------------------------------------------------------------
 { "_id" : "alice", "pet" : "dog", "destinations" : [ { "_id" : "DOG", "name" : "DOG", "depth" : { "$numberInt" : "0" } }, { "_id" : "dog", "name" : "dog", "depth" : { "$numberInt" : "0" } } ] }
 { "_id" : "bob", "pet" : "cat", "destinations" : [ { "_id" : "CAT", "name" : "CAT", "depth" : { "$numberInt" : "0" } }, { "_id" : "cAT", "name" : "cAT", "depth" : { "$numberInt" : "0" } } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "ci_search7", "pipeline": [ { "$graphLookup": { "from": "ci_search8", "startWith": "$pet", "connectFromField": "name", "connectToField": "_id", "as": "destinations", "depthField": "depth" } } ],  "collation": { "locale": "fr", "strength" : 1, "alternate": "shifted" } }');
                                                                                             document                                                                                              
---------------------------------------------------------------------
 { "_id" : "alice", "pet" : "dog", "destinations" : [ { "_id" : "DOG", "name" : "DOG", "depth" : { "$numberInt" : "0" } }, { "_id" : "dog", "name" : "dog", "depth" : { "$numberInt" : "0" } } ] }
 { "_id" : "bob", "pet" : "cat", "destinations" : [ { "_id" : "CAT", "name" : "CAT", "depth" : { "$numberInt" : "0" } }, { "_id" : "cAT", "name" : "cAT", "depth" : { "$numberInt" : "0" } } ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "ci_search7", "pipeline": [ { "$graphLookup": { "from": "ci_search8", "startWith": "$pet", "connectFromField": "name", "connectToField": "_id", "as": "destinations", "depthField": "depth" } } ],  "collation": { "locale": "hi", "strength" : 2, "caseFirst": "lower" } }');
                                                                                             document                                                                                              
---------------------------------------------------------------------
 { "_id" : "alice", "pet" : "dog", "destinations" : [ { "_id" : "DOG", "name" : "DOG", "depth" : { "$numberInt" : "0" } }, { "_id" : "dog", "name" : "dog", "depth" : { "$numberInt" : "0" } } ] }
 { "_id" : "bob", "pet" : "cat", "destinations" : [ { "_id" : "CAT", "name" : "CAT", "depth" : { "$numberInt" : "0" } }, { "_id" : "cAT", "name" : "cAT", "depth" : { "$numberInt" : "0" } } ] }
(2 rows)

-- test $graphlookup without auto variables ($$NOW) generation 
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "ci_search7", "pipeline": [ { "$graphLookup": { "from": "ci_search8", "startWith": "$pet", "connectFromField": "name", "connectToField": "_id", "as": "destinations", "depthField": "depth" } } ],  "collation": { "locale": "en", "strength" : 3} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(document, "addFields", true) AS document FROM (SELECT "graphLookupBase_stage_1".document, COALESCE((SELECT COALESCE(documentdb_api_catalog.bson_array_agg(agg_stage_sub_1_0.document, 'destinations'::text), '{ "destinations" : [  ] }'::documentdb_core.bson) AS document FROM (WITH RECURSIVE "graphLookupRecurseStage" AS (SELECT "*TLOCRN*".document, "*TLOCRN*".depth, "*TLOCRN*"."baseDocId", false AS is_cycle, ARRAY[ROW("*TLOCRN*"."baseDocId")] AS path FROM (SELECT collection_0_2.document, '{ "depth" : { "$numberInt" : "0" } }'::documentdb_core.bson AS depth, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson) AS "baseDocId" FROM documentdb_data.documents_7999_7990175 collection_0_2 WHERE ((collection_0_2.shard_key_value OPERATOR(pg_catalog.=) '7999'::bigint) AND documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, "graphLookupBase_stage_1"."inputExpr", '_id'::text))) "*TLOCRN*"(document, depth, "baseDocId") UNION ALL SELECT "*TROCRN*".document, "*TROCRN*".depth, "*TROCRN*"."baseDocId", CASE WHEN (ROW("*TROCRN*"."baseDocId") OPERATOR(pg_catalog.=) ANY ("*TROCRN*".path)) THEN true ELSE false END AS is_cycle, array_cat("*TROCRN*".path, ARRAY[ROW("*TROCRN*"."baseDocId")]) AS path FROM (SELECT collection_0_2.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "depth" : { "$add" : [ "$depth", { "$numberInt" : "1" } ] } }'::documentdb_core.bson) AS depth, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson) AS "baseDocId", "lookupRecursive_stage_1".is_cycle, "lookupRecursive_stage_1".path FROM documentdb_data.documents_7999_7990175 collection_0_2, "graphLookupRecurseStage" "lookupRecursive_stage_1" WHERE ((collection_0_2.shard_key_value OPERATOR(pg_catalog.=) '7999'::bigint) AND documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "_id" : { "$makeArray" : "$name" } }'::documentdb_core.bson, false, '{ }'::documentdb_core.bson, 'en-u-ks-level3'::text), '_id'::text))) "*TROCRN*"(document, depth, "baseDocId", is_cycle, path) WHERE ("*TROCRN*".is_cycle OPERATOR(pg_catalog.<>) true)) SELECT DISTINCT ON ("graphLookup_stage_2"."baseDocId") documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth, true) AS document FROM "graphLookupRecurseStage" "graphLookup_stage_2" ORDER BY "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth) agg_stage_sub_1_0), '{ "destinations" : [  ] }'::documentdb_core.bson) AS "addFields" FROM (SELECT collection.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "_id" : { "$makeArray" : "$pet" } }'::documentdb_core.bson, false, '{ }'::documentdb_core.bson, 'en-u-ks-level3'::text) AS "inputExpr" FROM documentdb_data.documents_7998_7990152 collection WHERE (collection.shard_key_value OPERATOR(pg_catalog.=) '7998'::bigint)) "graphLookupBase_stage_1") "graphLookup_stage_1"
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_7998_7990152 collection
               Output: documentdb_api_internal.bson_dollar_merge_documents(collection.document, COALESCE((SubPlan 2), '{ "destinations" : [  ] }'::documentdb_core.bson), true)
               Recheck Cond: (collection.shard_key_value = '7998'::bigint)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '7998'::bigint)
               SubPlan 2
                 ->  Aggregate
                       Output: COALESCE(documentdb_api_catalog.bson_array_agg((documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth, true)), 'destinations'::text), '{ "destinations" : [  ] }'::documentdb_core.bson)
                       ->  Unique
                             Output: (documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth, true)), "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                             CTE graphLookupRecurseStage
                               ->  Recursive Union
                                     ->  Bitmap Heap Scan on documentdb_data.documents_7999_7990175 collection_0_2
                                           Output: collection_0_2.document, '{ "depth" : { "$numberInt" : "0" } }'::documentdb_core.bson, documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false), false, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false))]
                                           Recheck Cond: (collection_0_2.shard_key_value = '7999'::bigint)
                                           Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2.document, documentdb_api_internal.bson_expression_get(collection.document, '{ "_id" : { "$makeArray" : "$pet" } }'::documentdb_core.bson, false, '{ }'::documentdb_core.bson, 'en-u-ks-level3'::text), '_id'::text)
                                           ->  Bitmap Index Scan on _id_
                                                 Index Cond: (collection_0_2.shard_key_value = '7999'::bigint)
                                     ->  Nested Loop
                                           Output: collection_0_2_1.document, documentdb_api_catalog.bson_dollar_add_fields("lookupRecursive_stage_1".depth, '{ "depth" : { "$add" : [ "$depth", { "$numberInt" : "1" } ] } }'::documentdb_core.bson), documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false), CASE WHEN (ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false)) = ANY ("lookupRecursive_stage_1".path)) THEN true ELSE false END, array_cat("lookupRecursive_stage_1".path, ARRAY[ROW(documentdb_api_catalog.bson_expression_get(collection_0_2_1.document, '{ "_id" : "$_id" }'::documentdb_core.bson, false))])
                                           Join Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(collection_0_2_1.document, documentdb_api_internal.bson_expression_get("lookupRecursive_stage_1".document, '{ "_id" : { "$makeArray" : "$name" } }'::documentdb_core.bson, false, '{ }'::documentdb_core.bson, 'en-u-ks-level3'::text), '_id'::text)
                                           ->  WorkTable Scan on "graphLookupRecurseStage" "lookupRecursive_stage_1"
                                                 Output: "lookupRecursive_stage_1".document, "lookupRecursive_stage_1".depth, "lookupRecursive_stage_1"."baseDocId", "lookupRecursive_stage_1".is_cycle, "lookupRecursive_stage_1".path
                                                 Filter: (NOT "lookupRecursive_stage_1".is_cycle)
                                           ->  Materialize
                                                 Output: collection_0_2_1.document
                                                 ->  Bitmap Heap Scan on documentdb_data.documents_7999_7990175 collection_0_2_1
                                                       Output: collection_0_2_1.document
                                                       Recheck Cond: (collection_0_2_1.shard_key_value = '7999'::bigint)
                                                       ->  Bitmap Index Scan on _id_
                                                             Index Cond: (collection_0_2_1.shard_key_value = '7999'::bigint)
                             ->  Sort
                                   Output: (documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth, true)), "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                                   Sort Key: "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
                                   ->  CTE Scan on "graphLookupRecurseStage" "graphLookup_stage_2"
                                         Output: documentdb_api_internal.bson_dollar_merge_documents("graphLookup_stage_2".document, "graphLookup_stage_2".depth, true), "graphLookup_stage_2"."baseDocId", "graphLookup_stage_2".depth
(43 rows)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "ci_search7", "pipeline": [ { "$graphLookup": { "from": "ci_search8", "startWith": "$pet", "connectFromField": "name", "connectToField": "_id", "as": "destinations", "depthField": "depth" } } ],  "collation": { "locale": "en", "strength" : 3} }');
                                                           document                                                           
---------------------------------------------------------------------
 { "_id" : "alice", "pet" : "dog", "destinations" : [ { "_id" : "dog", "name" : "dog", "depth" : { "$numberInt" : "0" } } ] }
 { "_id" : "bob", "pet" : "cat", "destinations" : [  ] }
(2 rows)

END;
--- $graphLookup on sharded collection: unsupported
SELECT documentdb_api.shard_collection('db', 'ci_search7', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT documentdb_api.shard_collection('db', 'ci_search8', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT document FROM bson_aggregation_pipeline('db',
    '{ "aggregate": "ci_search7", "pipeline": [ { "$graphLookup": { "from": "ci_search8", "startWith": "$pet", "connectFromField": "name", "connectToField": "_id", "as": "destinations", "depthField": "depth" } } ],  "collation": { "locale": "fr", "strength" : 1, "alternate": "shifted" } }');
ERROR:  $graphLookup using 'from' on a sharded collection is currently unsupported
-- unsupported $merge 
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search6", "pipeline": [{"$merge" : { "into": "ci_search9", "whenMatched" : "replace" }} ], "collation": { "locale": "en", "strength" : 1} }');
ERROR:  collation is not supported with $merge yet
SELECT documentdb_api.shard_collection('db', 'ci_search6', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- lookup with id join (collation aware)
SELECT document FROM bson_aggregation_pipeline('db', 
    '{ "aggregate": "ci_search6", "pipeline": [ { "$lookup": { "from": "ci_search6", "as": "matched_docs", "localField": "_id", "foreignField": "_id", "pipeline": [ { "$match": { "$or" : [ { "a.b": "cat" }, { "a.b": "dog" } ] } } ] } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                    document                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : "Dog", "a" : { "b" : "Dog" }, "matched_docs" : [ { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "DOG", "a" : { "b" : "DOG" }, "matched_docs" : [ { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "dog", "a" : { "b" : "dog" }, "matched_docs" : [ { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "DoG", "a" : { "b" : "DoG" }, "matched_docs" : [ { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "dOg", "a" : { "b" : "dOg" }, "matched_docs" : [ { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "Cat", "a" : { "b" : "Cat" }, "matched_docs" : [ { "_id" : "Cat", "a" : { "b" : "Cat" } }, { "_id" : "cAT", "a" : { "b" : "cAT" } } ] }
 { "_id" : "cAT", "a" : { "b" : "cAT" }, "matched_docs" : [ { "_id" : "Cat", "a" : { "b" : "Cat" } }, { "_id" : "cAT", "a" : { "b" : "cAT" } } ] }
(7 rows)

BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', 
    '{ "aggregate": "ci_search6", "pipeline": [ { "$lookup": { "from": "ci_search6", "as": "matched_docs", "localField": "_id", "foreignField": "_id", "pipeline": [ { "$match": { "$or" : [ { "a.b": "cat" }, { "a.b": "dog" } ] } } ] } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   ->  Distributed Subplan 382_1
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan.lookup_filter
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_dollar_lookup_extract_filter_expression(document, '{ "_id" : "_id", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AS lookup_filter FROM documentdb_data.documents_7997_7990200 collection WHERE true
                     Node: host=localhost port=58070 dbname=regression
                     ->  Seq Scan on documentdb_data.documents_7997_7990200 collection
                           Output: document, documentdb_api_internal.bson_dollar_lookup_extract_filter_expression(document, '{ "_id" : "_id", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
   ->  Distributed Subplan 382_2
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document FROM documentdb_data.documents_7997_7990200 collection_0_1 WHERE documentdb_api_catalog.bson_dollar_in(document, '{ "a.b" : [ "cat", "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     Node: host=localhost port=58070 dbname=regression
                     ->  Seq Scan on documentdb_data.documents_7997_7990200 collection_0_1
                           Output: document
                           Filter: (collection_0_1.document OPERATOR(documentdb_api_catalog.@*=) '{ "a.b" : [ "cat", "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(lookup_stage_1.document, "lookupRight_stage_1".document, true) AS document FROM ((SELECT intermediate_result.document, intermediate_result.lookup_filter FROM read_intermediate_result('382_1'::text, 'binary'::citus_copy_format) intermediate_result(document documentdb_core.bson, lookup_filter documentdb_core.bson)) lookup_stage_1 JOIN LATERAL (SELECT COALESCE(documentdb_api_catalog.bson_array_agg(lookup_right_query_stage_0.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson) AS document FROM (SELECT intermediate_result.document FROM read_intermediate_result('382_2'::text, 'binary'::citus_copy_format) intermediate_result(document documentdb_core.bson)) lookup_right_query_stage_0 WHERE documentdb_api_internal.bson_dollar_lookup_join_filter(lookup_right_query_stage_0.document, lookup_stage_1.lookup_filter, '_id'::text)) "lookupRight_stage_1" ON (true))
         Node: host=localhost port=58070 dbname=regression
         ->  Nested Loop
               Output: documentdb_api_internal.bson_dollar_merge_documents(intermediate_result.document, (COALESCE(documentdb_api_catalog.bson_array_agg(intermediate_result_1.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson)), true)
               ->  Function Scan on pg_catalog.read_intermediate_result intermediate_result
                     Output: intermediate_result.document, intermediate_result.lookup_filter
                     Function Call: read_intermediate_result('382_1'::text, 'binary'::citus_copy_format)
               ->  Aggregate
                     Output: COALESCE(documentdb_api_catalog.bson_array_agg(intermediate_result_1.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson)
                     ->  Function Scan on pg_catalog.read_intermediate_result intermediate_result_1
                           Output: intermediate_result_1.document
                           Function Call: read_intermediate_result('382_2'::text, 'binary'::citus_copy_format)
                           Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(intermediate_result_1.document, intermediate_result.lookup_filter, '_id'::text)
(39 rows)

END;
-- lookup with non-id join (collation aware)
SELECT document FROM bson_aggregation_pipeline('db', 
    '{ "aggregate": "ci_search6", "pipeline": [ { "$lookup": { "from": "ci_search6", "as": "matched_docs", "localField": "a.b", "foreignField": "a.b", "pipeline": [ { "$match": { "$or" : [ { "a.b": "cat" }, { "a.b": "dog" } ] } } ] } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                    document                                                                                                                                     
---------------------------------------------------------------------
 { "_id" : "Dog", "a" : { "b" : "Dog" }, "matched_docs" : [ { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "DOG", "a" : { "b" : "DOG" }, "matched_docs" : [ { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "dog", "a" : { "b" : "dog" }, "matched_docs" : [ { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "DoG", "a" : { "b" : "DoG" }, "matched_docs" : [ { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "dOg", "a" : { "b" : "dOg" }, "matched_docs" : [ { "_id" : "Dog", "a" : { "b" : "Dog" } }, { "_id" : "DOG", "a" : { "b" : "DOG" } }, { "_id" : "dog", "a" : { "b" : "dog" } }, { "_id" : "DoG", "a" : { "b" : "DoG" } }, { "_id" : "dOg", "a" : { "b" : "dOg" } } ] }
 { "_id" : "Cat", "a" : { "b" : "Cat" }, "matched_docs" : [ { "_id" : "Cat", "a" : { "b" : "Cat" } }, { "_id" : "cAT", "a" : { "b" : "cAT" } } ] }
 { "_id" : "cAT", "a" : { "b" : "cAT" }, "matched_docs" : [ { "_id" : "Cat", "a" : { "b" : "Cat" } }, { "_id" : "cAT", "a" : { "b" : "cAT" } } ] }
(7 rows)

BEGIN;
SET LOCAL documentdb_core.enablecollation TO on;
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', 
    '{ "aggregate": "ci_search6", "pipeline": [ { "$lookup": { "from": "ci_search6", "as": "matched_docs", "localField": "a.b", "foreignField": "a.b", "pipeline": [ { "$match": { "$or" : [ { "a.b": "cat" }, { "a.b": "dog" } ] } } ] } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   ->  Distributed Subplan 390_1
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan.lookup_filter
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_dollar_lookup_extract_filter_expression(document, '{ "a.b" : "a.b", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AS lookup_filter FROM documentdb_data.documents_7997_7990200 collection WHERE true
                     Node: host=localhost port=58070 dbname=regression
                     ->  Seq Scan on documentdb_data.documents_7997_7990200 collection
                           Output: document, documentdb_api_internal.bson_dollar_lookup_extract_filter_expression(document, '{ "a.b" : "a.b", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
   ->  Distributed Subplan 390_2
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document FROM documentdb_data.documents_7997_7990200 collection_0_1 WHERE documentdb_api_catalog.bson_dollar_in(document, '{ "a.b" : [ "cat", "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     Node: host=localhost port=58070 dbname=regression
                     ->  Seq Scan on documentdb_data.documents_7997_7990200 collection_0_1
                           Output: document
                           Filter: (collection_0_1.document OPERATOR(documentdb_api_catalog.@*=) '{ "a.b" : [ "cat", "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_merge_documents(lookup_stage_1.document, "lookupRight_stage_1".document, true) AS document FROM ((SELECT intermediate_result.document, intermediate_result.lookup_filter FROM read_intermediate_result('390_1'::text, 'binary'::citus_copy_format) intermediate_result(document documentdb_core.bson, lookup_filter documentdb_core.bson)) lookup_stage_1 JOIN LATERAL (SELECT COALESCE(documentdb_api_catalog.bson_array_agg(lookup_right_query_stage_0.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson) AS document FROM (SELECT intermediate_result.document FROM read_intermediate_result('390_2'::text, 'binary'::citus_copy_format) intermediate_result(document documentdb_core.bson)) lookup_right_query_stage_0 WHERE documentdb_api_internal.bson_dollar_lookup_join_filter(lookup_right_query_stage_0.document, lookup_stage_1.lookup_filter, 'a.b'::text)) "lookupRight_stage_1" ON (true))
         Node: host=localhost port=58070 dbname=regression
         ->  Nested Loop
               Output: documentdb_api_internal.bson_dollar_merge_documents(intermediate_result.document, (COALESCE(documentdb_api_catalog.bson_array_agg(intermediate_result_1.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson)), true)
               ->  Function Scan on pg_catalog.read_intermediate_result intermediate_result
                     Output: intermediate_result.document, intermediate_result.lookup_filter
                     Function Call: read_intermediate_result('390_1'::text, 'binary'::citus_copy_format)
               ->  Aggregate
                     Output: COALESCE(documentdb_api_catalog.bson_array_agg(intermediate_result_1.document, 'matched_docs'::text), '{ "matched_docs" : [  ] }'::documentdb_core.bson)
                     ->  Function Scan on pg_catalog.read_intermediate_result intermediate_result_1
                           Output: intermediate_result_1.document
                           Function Call: read_intermediate_result('390_2'::text, 'binary'::citus_copy_format)
                           Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(intermediate_result_1.document, intermediate_result.lookup_filter, 'a.b'::text)
(39 rows)

END;
-- $facet and $unionwith
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search6", "pipeline": [ { "$facet": { "a" : [ { "$match": { "a.b": "cat" } }, { "$count": "catCount" } ], "b" : [ { "$match": { "a.b": "dog" } }, { "$count": "dogCount" } ]  } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}}');
                                                 document                                                 
---------------------------------------------------------------------
 { "a" : [ { "catCount" : { "$numberInt" : "2" } } ], "b" : [ { "dogCount" : { "$numberInt" : "5" } } ] }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search6", "pipeline": [ { "$unionWith": { "coll": "ci_search6", "pipeline" : [ { "$match": { "a.b": "cat" }}] } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                 document                 
---------------------------------------------------------------------
 { "_id" : "Dog", "a" : { "b" : "Dog" } }
 { "_id" : "DOG", "a" : { "b" : "DOG" } }
 { "_id" : "dog", "a" : { "b" : "dog" } }
 { "_id" : "DoG", "a" : { "b" : "DoG" } }
 { "_id" : "dOg", "a" : { "b" : "dOg" } }
 { "_id" : "Cat", "a" : { "b" : "Cat" } }
 { "_id" : "cAT", "a" : { "b" : "cAT" } }
 { "_id" : "Cat", "a" : { "b" : "Cat" } }
 { "_id" : "cAT", "a" : { "b" : "cAT" } }
(9 rows)

-- unsupported $merge
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "ci_search6", "pipeline": [{"$merge" : { "into": "ci_search7", "whenMatched" : "replace" }} ], "collation": { "locale": "en", "strength" : 1} }');
ERROR:  collation is not supported with $merge yet
-- $expr
SELECT documentdb_api.insert_one('db', 'coll_agg_proj', '{ "_id": 1, "a": "cat" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_agg_proj', '{ "_id": 2, "a": "dog" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_agg_proj', '{ "_id": 3, "a": "cAt" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_agg_proj', '{ "_id": 4, "a": "dOg" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_agg_proj', '{ "_id": "hen", "a": "hen" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_agg_proj', '{ "_id": "bat", "a": "bat" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": ["$a", "CAT"]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": ["$a", "CAT"]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "hi", "strength" : 2 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$ne": ["$a", "CAT"]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "fi", "strength" : 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg" }
 { "_id" : "bat", "a" : "bat" }
 { "_id" : "hen", "a" : "hen" }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$lte": ["$a", "CAT"]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
 { "_id" : "bat", "a" : "bat" }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$gte": ["$a", "CAT"]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "fr", "strength" : 3 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg" }
 { "_id" : "hen", "a" : "hen" }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$gte": ["$a", "CAT"]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "fr_CA", "strength" : 3 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg" }
 { "_id" : "hen", "a" : "hen" }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$gte": ["$a", "CAT"]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "es@collation=search", "strength" : 3 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg" }
 { "_id" : "hen", "a" : "hen" }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$gt": ["$a", "CAT"]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "fr", "strength" : 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg" }
 { "_id" : "hen", "a" : "hen" }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": { "$or": [{"$gte": [ "$a", "DOG" ]}, {"$gte": [ "$a", "CAT" ]}] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "fr", "strength" : 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg" }
 { "_id" : "hen", "a" : "hen" }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": { "$and": [{"$lte": [ "$a", "DOG" ]}, {"$lte": [ "$a", "CAT" ]}] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "fr", "strength" : 2 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
 { "_id" : "bat", "a" : "bat" }
(3 rows)

-- test $expr without auto variables ($$NOW) generation
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": ["$a", "CAT"]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_8000_7990215 collection WHERE (documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$eq" : [ "$a", "CAT" ] }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson, '{ }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '8000'::bigint)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_8000_7990215 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '8000'::bigint)
                     Filter: documentdb_api_internal.bson_dollar_expr(collection.document, '{ "" : { "$eq" : [ "$a", "CAT" ] }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson, '{ }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '8000'::bigint)
(16 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": ["$a", "CAT"]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1 } }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
-- en_US_POSIX uses a c-style comparison. POSIX locale ignores case insensitivity. This is the ICU semantics.
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": ["$a", "cat"]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en_US_POSIX", "strength" : 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": ["$a", "CAT"]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en_US_POSIX", "strength" : 1 } }');
 document 
---------------------------------------------------------------------
(0 rows)

-- simple collation
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj",  "filter": { "$expr": {"$eq": ["$a", "CAT"]} }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "simple"} }');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj",  "filter": { "$expr": {"$eq": ["$a", "cat"]} }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "simple"} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
(1 row)

-- simple locale ignores other options
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj",  "filter": { "$expr": {"$eq": ["$a", "cat"]} }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "simple", "strength": 1} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj",  "filter": { "$expr": {"$eq": ["$a", "cat"]} }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "simple", "strength": 3} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj",  "filter": { "$expr": {"$eq": ["$a", "cat"]} }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "simple", "caseFirst": "upper"} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj",  "filter": { "$expr": {"$eq": ["$a", "cat"]} }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "simple", "caseFirst": "lower"} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
(1 row)

-- support for $filter
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": { "$eq": [["$a"], { "$filter": { "input": ["$a"], "as": "item", "cond": { "$eq": [ "$$item", "CAT" ] } } } ] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": { "$eq": [["$a"], { "$filter": { "input": ["$a"], "as": "item", "cond": { "$eq": [ "$$item", "CAT" ] } } } ] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 3 } }');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": { "$eq": [["$a"], { "$filter": { "input": ["$a"], "as": "item", "cond": { "$ne": [ "$$item", "CAT" ] } } } ] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 2 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg" }
 { "_id" : "bat", "a" : "bat" }
 { "_id" : "hen", "a" : "hen" }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": { "$eq": [["$a"], { "$filter": { "input": ["$a"], "as": "item", "cond": { "$or": [{"$gte": [ "$$item", "DOG" ]}, {"$gte": [ "$$item", "CAT" ]}] } } } ] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg" }
 { "_id" : "hen", "a" : "hen" }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": { "$eq": [["$a"], { "$filter": { "input": ["$a"], "as": "item", "cond": { "$and": [{"$gte": [ "$$item", "DOG" ]}, {"$gte": [ "$$item", "CAT" ]}] } } } ] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg" }
 { "_id" : "hen", "a" : "hen" }
(3 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": { "$eq": [["$_id"], { "$filter": { "input": ["$_id"], "as": "item", "cond": { "$and": [{"$gte": [ "$$item", "HEN" ]}, {"$gte": [ "$$item", "BAT" ]}] } } } ] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1 } }');
            document            
---------------------------------------------------------------------
 { "_id" : "hen", "a" : "hen" }
(1 row)

-- support for $in
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$in": ["$a", ["CAT", "DOG"]]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "fr", "strength" : 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg" }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$in": ["$a", ["CAT", "DOG"]]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 2 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg" }
(4 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$in": ["$a", ["CAT", "DOG"]]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 3 } }');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$in": ["$_id", ["HEN", "BAT"]]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1 } }');
            document            
---------------------------------------------------------------------
 { "_id" : "bat", "a" : "bat" }
 { "_id" : "hen", "a" : "hen" }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$in": ["$_id", ["HEN", "BAT"]]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 3 } }');
 document 
---------------------------------------------------------------------
(0 rows)

-- support for $indexOfArray
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": [{ "$indexOfArray": [ ["CAT", "DOG"], "$a" ] }, 0]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": [{ "$indexOfArray": [ ["CAT", "DOG"], "$a" ] }, 0]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 3 } }');
 document 
---------------------------------------------------------------------
(0 rows)

-- support for $indexOfBytes (doesn't respect collation)
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": [{ "$indexOfBytes": [ "cAtALoNa", "$a" ] }, 0]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": [{ "$indexOfBytes": [ "cAtALoNa", "$a" ] }, 0]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 3 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": [{ "$indexOfBytes": [ "$a", "aT" ] }, 1]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 2 } }');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": [{ "$indexOfBytes": [ "$a", "AT" ] }, -1]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 2 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg" }
 { "_id" : "bat", "a" : "bat" }
 { "_id" : "hen", "a" : "hen" }
(6 rows)

-- support for $indexOfCP (doesn't respect collation)
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": [{ "$indexOfCP": [ "cAtALoNa", "$a" ] }, 0]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": [{ "$indexOfCP": [ "cAtALoNa", "$a" ] }, 0]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 3 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": [{ "$indexOfCP": [ "$a", "at" ] }, 1]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 2 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : "bat", "a" : "bat" }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": [{ "$indexOfCP": [ "$a", "AT" ] }, 1]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 2 } }');
 document 
---------------------------------------------------------------------
(0 rows)

-- support for $strcasecmp (doesn't respect collation)
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": [{ "$strcasecmp": ["$a", "CAT"] }, 0]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": [{ "$strcasecmp": ["$a", "CAT"] }, 0]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 3 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": [{ "$strcasecmp": ["$a", "CAT"] }, 0]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 2 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "filter": { "$expr": {"$eq": [{ "$strcasecmp": ["$a", "CAT"] }, 0]} }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 3 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt" }
(2 rows)

-- $addFields
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$addFields": { "newField": { "$ne": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : true }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$addFields": { "newField": { "$lte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : false }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : false }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : true }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$addFields": { "newField": { "$gte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 3} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$addFields": { "newField": { "$gte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

-- test $addFields auto $$NOW generation
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$addFields": { "newField": { "$gte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$addFields": { "newField": { "$gte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                                                                                                                                                                 QUERY PLAN                                                                                                                                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_add_fields(document, '{ "newField" : { "$gte" : [ "$a", "CAT" ] } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'fr-u-ks-level1'::text) AS document FROM documentdb_data.documents_8000_7990215 collection WHERE (shard_key_value OPERATOR(pg_catalog.=) '8000'::bigint)
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_8000_7990215 collection
               Output: documentdb_api_internal.bson_dollar_add_fields(document, '{ "newField" : { "$gte" : [ "$a", "CAT" ] } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'fr-u-ks-level1'::text)
               Recheck Cond: (collection.shard_key_value = '8000'::bigint)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '8000'::bigint)
(12 rows)

ROLLBACK;
-- $set
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$set": { "newField": { "$ne": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : true }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$set": { "newField": { "$lte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : false }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : false }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : true }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$set": { "newField": { "$gte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 3} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$set": { "newField": { "$gte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

-- test $set auto $$NOW generation
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$set": { "newField": { "$gte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$set": { "newField": { "$gte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                                                                                                                                                                 QUERY PLAN                                                                                                                                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_add_fields(document, '{ "newField" : { "$gte" : [ "$a", "CAT" ] } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'fr-u-ks-level1'::text) AS document FROM documentdb_data.documents_8000_7990215 collection WHERE (shard_key_value OPERATOR(pg_catalog.=) '8000'::bigint)
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_8000_7990215 collection
               Output: documentdb_api_internal.bson_dollar_add_fields(document, '{ "newField" : { "$gte" : [ "$a", "CAT" ] } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'fr-u-ks-level1'::text)
               Recheck Cond: (collection.shard_key_value = '8000'::bigint)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '8000'::bigint)
(12 rows)

ROLLBACK;
-- project
SELECT documentdb_api_internal.bson_dollar_project(document, '{ "newField": { "$eq": ["$a", "CAT"] } }', NULL, 'en-u-ks-level1') FROM documentdb_api.collection('db', 'coll_agg_proj');
                  bson_dollar_project                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "newField" : false }
 { "_id" : { "$numberInt" : "3" }, "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "newField" : false }
 { "_id" : "hen", "newField" : false }
 { "_id" : "bat", "newField" : false }
(6 rows)

SELECT documentdb_api_internal.bson_dollar_project(document, '{ "newField": { "$eq": ["$a", "DOG"] } }', NULL, 'en-u-ks-level1') FROM documentdb_api.collection('db', 'coll_agg_proj');
                  bson_dollar_project                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "newField" : true }
 { "_id" : "hen", "newField" : false }
 { "_id" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": { "$ne": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : true }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": { "$lte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : false }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : false }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : true }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": { "$gte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 3} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": { "$gte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

-- test $project auto $$NOW generation
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": { "$gte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": { "$gte": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
                                                                                                                                                                               QUERY PLAN                                                                                                                                                                               
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "newField" : { "$gte" : [ "$a", "CAT" ] } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'fr-u-ks-level1'::text) AS document FROM documentdb_data.documents_8000_7990215 collection WHERE (shard_key_value OPERATOR(pg_catalog.=) '8000'::bigint)
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_8000_7990215 collection
               Output: documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "newField" : { "$gte" : [ "$a", "CAT" ] } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'fr-u-ks-level1'::text)
               Recheck Cond: (collection.shard_key_value = '8000'::bigint)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '8000'::bigint)
(12 rows)

ROLLBACK;
-- $replaceRoot
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$replaceRoot": { "newRoot": { "a": "$a", "newField": { "$eq": ["$a", "CAT"] } } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
              document               
---------------------------------------------------------------------
 { "a" : "cat", "newField" : true }
 { "a" : "dog", "newField" : false }
 { "a" : "cAt", "newField" : true }
 { "a" : "dOg", "newField" : false }
 { "a" : "hen", "newField" : false }
 { "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$replaceRoot": { "newRoot": { "a": "$a", "newField": { "$ne": ["$a", "CAT"] } } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
              document              
---------------------------------------------------------------------
 { "a" : "cat", "newField" : true }
 { "a" : "dog", "newField" : true }
 { "a" : "cAt", "newField" : true }
 { "a" : "dOg", "newField" : true }
 { "a" : "hen", "newField" : true }
 { "a" : "bat", "newField" : true }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$replaceRoot": { "newRoot": { "a": "$a", "newField": { "$lte": ["$a", "DoG"] } } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
              document               
---------------------------------------------------------------------
 { "a" : "cat", "newField" : true }
 { "a" : "dog", "newField" : true }
 { "a" : "cAt", "newField" : true }
 { "a" : "dOg", "newField" : true }
 { "a" : "hen", "newField" : false }
 { "a" : "bat", "newField" : true }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$replaceRoot": { "newRoot": { "a": "$a", "newField": { "$gte": ["$a", "doG"] } } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
              document               
---------------------------------------------------------------------
 { "a" : "cat", "newField" : false }
 { "a" : "dog", "newField" : false }
 { "a" : "cAt", "newField" : false }
 { "a" : "dOg", "newField" : true }
 { "a" : "hen", "newField" : true }
 { "a" : "bat", "newField" : false }
(6 rows)

-- test $replaceRoot auto $$NOW generation
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$replaceRoot": { "newRoot": { "a": "$a", "newField": { "$gte": ["$a", "doG"] } } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
              document               
---------------------------------------------------------------------
 { "a" : "cat", "newField" : false }
 { "a" : "dog", "newField" : false }
 { "a" : "cAt", "newField" : false }
 { "a" : "dOg", "newField" : true }
 { "a" : "hen", "newField" : true }
 { "a" : "bat", "newField" : false }
(6 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$replaceRoot": { "newRoot": { "a": "$a", "newField": { "$gte": ["$a", "doG"] } } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                 
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_replace_root(document, '{ "newRoot" : { "a" : "$a", "newField" : { "$gte" : [ "$a", "doG" ] } } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'en-u-ks-level3'::text) AS document FROM documentdb_data.documents_8000_7990215 collection WHERE (shard_key_value OPERATOR(pg_catalog.=) '8000'::bigint)
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_8000_7990215 collection
               Output: documentdb_api_internal.bson_dollar_replace_root(document, '{ "newRoot" : { "a" : "$a", "newField" : { "$gte" : [ "$a", "doG" ] } } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'en-u-ks-level3'::text)
               Recheck Cond: (collection.shard_key_value = '8000'::bigint)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '8000'::bigint)
(12 rows)

ROLLBACK;
-- $replaceWith
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$replaceWith": { "a": "$a", "newField": { "$eq": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
              document               
---------------------------------------------------------------------
 { "a" : "cat", "newField" : true }
 { "a" : "dog", "newField" : false }
 { "a" : "cAt", "newField" : true }
 { "a" : "dOg", "newField" : false }
 { "a" : "hen", "newField" : false }
 { "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$replaceWith": { "a": "$a", "newField": { "$ne": ["$a", "CAT"] } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
              document              
---------------------------------------------------------------------
 { "a" : "cat", "newField" : true }
 { "a" : "dog", "newField" : true }
 { "a" : "cAt", "newField" : true }
 { "a" : "dOg", "newField" : true }
 { "a" : "hen", "newField" : true }
 { "a" : "bat", "newField" : true }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$replaceWith": { "a": "$a", "newField": { "$lte": ["$a", "DoG"] } } } ], "cursor": {}, "collation": { "locale": "fr", "strength" : 1} }');
              document               
---------------------------------------------------------------------
 { "a" : "cat", "newField" : true }
 { "a" : "dog", "newField" : true }
 { "a" : "cAt", "newField" : true }
 { "a" : "dOg", "newField" : true }
 { "a" : "hen", "newField" : false }
 { "a" : "bat", "newField" : true }
(6 rows)

-- test $replaceWith auto $$NOW generation
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$replaceWith": { "a": "$a", "newField": { "$gte": ["$a", "doG"] } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
              document               
---------------------------------------------------------------------
 { "a" : "cat", "newField" : false }
 { "a" : "dog", "newField" : false }
 { "a" : "cAt", "newField" : false }
 { "a" : "dOg", "newField" : true }
 { "a" : "hen", "newField" : true }
 { "a" : "bat", "newField" : false }
(6 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$replaceWith": { "a": "$a", "newField": { "$gte": ["$a", "doG"] } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                 
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_replace_root(document, '{ "newRoot" : { "a" : "$a", "newField" : { "$gte" : [ "$a", "doG" ] } } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'en-u-ks-level3'::text) AS document FROM documentdb_data.documents_8000_7990215 collection WHERE (shard_key_value OPERATOR(pg_catalog.=) '8000'::bigint)
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_8000_7990215 collection
               Output: documentdb_api_internal.bson_dollar_replace_root(document, '{ "newRoot" : { "a" : "$a", "newField" : { "$gte" : [ "$a", "doG" ] } } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'en-u-ks-level3'::text)
               Recheck Cond: (collection.shard_key_value = '8000'::bigint)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '8000'::bigint)
(12 rows)

ROLLBACK;
-- $documents
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": 1, "pipeline": [ { "$documents": { "$cond": { "if": { "$eq": [ "CaT", "cAt" ] }, "then": [{"result": "case insensitive"}] , "else": [{"res": "case sensitive"}] }} } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
        documents_aggregate        
---------------------------------------------------------------------
 { "result" : "case insensitive" }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": 1, "pipeline": [ { "$documents": { "$cond": { "if": { "$eq": [ "CaT", "cAt" ] }, "then": [{"result": "case insensitive"}] , "else": [{"res": "case sensitive"}] }} } ], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
     documents_aggregate      
---------------------------------------------------------------------
 { "res" : "case sensitive" }
(1 row)

-- test $documents without auto variables ($$NOW) generation
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": 1, "pipeline": [ { "$documents": { "$cond": { "if": { "$eq": [ "CaT", "cAt" ] }, "then": [{"result": "case insensitive"}] , "else": [{"res": "case sensitive"}] }} } ], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
     documents_aggregate      
---------------------------------------------------------------------
 { "res" : "case sensitive" }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": 1, "pipeline": [ { "$documents": { "$cond": { "if": { "$eq": [ "CaT", "cAt" ] }, "then": [{"result": "case insensitive"}] , "else": [{"res": "case sensitive"}] }} } ], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
                                                      QUERY PLAN                                                      
---------------------------------------------------------------------
 Function Scan on documentdb_api_catalog.bson_lookup_unwind documents
   Output: documents
   Function Call: bson_lookup_unwind('{ "$documents" : [ { "res" : "case sensitive" } ] }'::bson, '$documents'::text)
(3 rows)

ROLLBACK;
-- $sortArray
SELECT documentdb_api.insert_one('db', 'coll_sortArray', '{"_id":1,"a":"one", "b":["10","1"]}', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_sortArray', '{"_id":2,"a":"two", "b":["2","020"]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_sortArray", "pipeline": [ { "$project": { "sortedArray": { "$sortArray": { "input": ["cat", "dog", "DOG"], "sortBy": 1 } } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "sortedArray" : [ "cat", "dog", "DOG" ] }
 { "_id" : { "$numberInt" : "2" }, "sortedArray" : [ "cat", "dog", "DOG" ] }
(2 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_sortArray", "pipeline": [ { "$project": { "sortedArray": { "$sortArray": { "input": ["cat", "dog", "DOG"], "sortBy": 1 } } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "sortedArray" : [ "cat", "dog", "DOG" ] }
 { "_id" : { "$numberInt" : "2" }, "sortedArray" : [ "cat", "dog", "DOG" ] }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{
  "find": "coll_sortArray",
  "filter": { "a": {"$lte": "two"} },
  "projection": {
    "sortedArray": { "$sortArray": { "input": "$b", "sortBy": 1 } }
  },
  "collation": { "locale": "en", "numericOrdering" : false },
  "limit": 5
}');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "sortedArray" : [ "1", "10" ] }
 { "_id" : { "$numberInt" : "2" }, "sortedArray" : [ "020", "2" ] }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{
  "find": "coll_sortArray",
  "filter": { "a": {"$lte": "two"} },
  "projection": {
    "sortedArray": { "$sortArray": { "input": "$b", "sortBy": 1 } }
  },
  "collation": { "locale": "en", "numericOrdering" : true },
  "limit": 5
}');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "sortedArray" : [ "1", "10" ] }
 { "_id" : { "$numberInt" : "2" }, "sortedArray" : [ "2", "020" ] }
(2 rows)

SELECT documentdb_api.drop_collection('db', 'coll_sortArray');
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

-- find
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "projection": { "a": 1, "newField": { "$eq": ["$a", "CAT"] } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : false }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "projection": { "a": 1, "newField": { "$ne": ["$a", "CAT"] } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 2} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : true }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "projection": { "a": 1, "newField": { "$ne": ["$a", "CAT"] } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 3} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : true }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "projection": { "a": 1, "newField": { "$gte": ["$a", "CAT"] } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(5 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "projection": { "a": 1, "newField": { "$gte": ["$a", "CAT"] } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 3} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(5 rows)

-- test $find without auto variables ($$NOW) generation
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "projection": { "a": 1, "newField": { "$gte": ["$a", "CAT"] } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 3} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(5 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "projection": { "a": 1, "newField": { "$gte": ["$a", "CAT"] } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 3} }');
                                                                                                                                                                                                                                                                                                            QUERY PLAN                                                                                                                                                                                                                                                                                                            
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_project_find(document, '{ "a" : { "$numberInt" : "1" }, "newField" : { "$gte" : [ "$a", "CAT" ] } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'en-u-ks-level3'::text) AS document FROM documentdb_data.documents_8000_7990215 collection WHERE (shard_key_value OPERATOR(pg_catalog.=) '8000'::bigint) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: (documentdb_api_internal.bson_dollar_project_find(document, '{ "a" : { "$numberInt" : "1" }, "newField" : { "$gte" : [ "$a", "CAT" ] } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'en-u-ks-level3'::text)), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text))
               ->  Sort
                     Output: (documentdb_api_internal.bson_dollar_project_find(document, '{ "a" : { "$numberInt" : "1" }, "newField" : { "$gte" : [ "$a", "CAT" ] } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'en-u-ks-level3'::text)), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text)) USING <<< NULLS FIRST
                     ->  Bitmap Heap Scan on documentdb_data.documents_8000_7990215 collection
                           Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "a" : { "$numberInt" : "1" }, "newField" : { "$gte" : [ "$a", "CAT" ] } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'en-u-ks-level3'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text)
                           Recheck Cond: (collection.shard_key_value = '8000'::bigint)
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection.shard_key_value = '8000'::bigint)
(17 rows)

ROLLBACK;
-- $redact
SELECT documentdb_api.insert_one('db','coll_redact','{ "_id": 1, "level": "public", "content": "content 1", "details": { "level": "public", "value": "content 1.1", "moreDetails": { "level": "restricted", "info": "content 1.1.1" } } }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','coll_redact','{ "_id": 2, "level": "restricted", "content": "content 2", "details": { "level": "public", "value": "content 2.1", "moreDetails": { "level": "restricted", "info": "content 2.1.1" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','coll_redact','{ "_id": 3, "level": "public", "content": "content 3", "details": { "level": "restricted", "value": "content 3.1", "moreDetails": { "level": "public", "info": "content 3.1.1" } } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','coll_redact','{ "_id": 4, "content": "content 4", "details": { "level": "public", "value": "content 4.1" } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','coll_redact','{ "_id": 5, "level": "public", "content": "content 5", "details": { "level": "public", "value": "content 5.1", "moreDetails": [{ "level": "restricted", "info": "content 5.1.1" }, { "level": "public", "info": "content 5.1.2" }] } }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_redact", "pipeline": [ { "$redact": { "$cond": { "if": { "$eq": ["$level", "PUBLIC"] }, "then": "$$KEEP", "else": "$$PRUNE" } } }  ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                 document                                                                                                                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : "public", "content" : "content 1", "details" : { "level" : "public", "value" : "content 1.1", "moreDetails" : { "level" : "restricted", "info" : "content 1.1.1" } } }
 
 { "_id" : { "$numberInt" : "3" }, "level" : "public", "content" : "content 3", "details" : { "level" : "restricted", "value" : "content 3.1", "moreDetails" : { "level" : "public", "info" : "content 3.1.1" } } }
 
 { "_id" : { "$numberInt" : "5" }, "level" : "public", "content" : "content 5", "details" : { "level" : "public", "value" : "content 5.1", "moreDetails" : [ { "level" : "restricted", "info" : "content 5.1.1" }, { "level" : "public", "info" : "content 5.1.2" } ] } }
(5 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_redact", "pipeline": [ { "$redact": { "$cond": { "if": { "$eq": ["$level", "puBliC"] }, "then": "$$DESCEND", "else": "$$PRUNE" } } }  ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                      document                                                                                                      
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "level" : "public", "content" : "content 1", "details" : { "level" : "public", "value" : "content 1.1" } }
 
 { "_id" : { "$numberInt" : "3" }, "level" : "public", "content" : "content 3" }
 
 { "_id" : { "$numberInt" : "5" }, "level" : "public", "content" : "content 5", "details" : { "level" : "public", "value" : "content 5.1", "moreDetails" : [ { "level" : "public", "info" : "content 5.1.2" } ] } }
(5 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_redact", "pipeline": [ { "$redact": { "$switch": { "branches": [ { "case": { "$eq": ["$level", "PUBLIC"] }, "then": "$$PRUNE" }, { "case": { "$eq": ["$classification", "RESTRICTED"] }, "then": { "$cond": { "if": { "$eq": ["$content", null] }, "then": "$$KEEP", "else": "$$PRUNE" } } }], "default": "$$KEEP" } }  }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                        document                                                                                                        
---------------------------------------------------------------------
 
 { "_id" : { "$numberInt" : "2" }, "level" : "restricted", "content" : "content 2", "details" : { "level" : "public", "value" : "content 2.1", "moreDetails" : { "level" : "restricted", "info" : "content 2.1.1" } } }
 
 { "_id" : { "$numberInt" : "4" }, "content" : "content 4", "details" : { "level" : "public", "value" : "content 4.1" } }
 
(5 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_redact", "pipeline": [ { "$redact": { "$switch": { "branches": [ { "case": { "$eq": ["$level", "PUBLIC"] }, "then": "$$PRUNE" }, { "case": { "$eq": ["$classification", "RESTRICTED"] }, "then": { "$cond": { "if": { "$eq": ["$content", null] }, "then": "$$KEEP", "else": "$$PRUNE" } } }], "default": "$$KEEP" } }  }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                        document                                                                                                        
---------------------------------------------------------------------
 
 { "_id" : { "$numberInt" : "2" }, "level" : "restricted", "content" : "content 2", "details" : { "level" : "public", "value" : "content 2.1", "moreDetails" : { "level" : "restricted", "info" : "content 2.1.1" } } }
 
 { "_id" : { "$numberInt" : "4" }, "content" : "content 4", "details" : { "level" : "public", "value" : "content 4.1" } }
 
(5 rows)

-- test $redact auto $$NOW generation
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_redact", "pipeline": [ { "$redact": { "$switch": { "branches": [ { "case": { "$eq": ["$level", "PUBLIC"] }, "then": "$$PRUNE" }, { "case": { "$eq": ["$classification", "RESTRICTED"] }, "then": { "$cond": { "if": { "$eq": ["$content", null] }, "then": "$$KEEP", "else": "$$PRUNE" } } }], "default": "$$KEEP" } }  }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                        document                                                                                                        
---------------------------------------------------------------------
 
 { "_id" : { "$numberInt" : "2" }, "level" : "restricted", "content" : "content 2", "details" : { "level" : "public", "value" : "content 2.1", "moreDetails" : { "level" : "restricted", "info" : "content 2.1.1" } } }
 
 { "_id" : { "$numberInt" : "4" }, "content" : "content 4", "details" : { "level" : "public", "value" : "content 4.1" } }
 
(5 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_redact", "pipeline": [ { "$redact": { "$switch": { "branches": [ { "case": { "$eq": ["$level", "PUBLIC"] }, "then": "$$PRUNE" }, { "case": { "$eq": ["$classification", "RESTRICTED"] }, "then": { "$cond": { "if": { "$eq": ["$content", null] }, "then": "$$KEEP", "else": "$$PRUNE" } } }], "default": "$$KEEP" } }  }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_redact(document, '{ "$switch" : { "branches" : [ { "case" : { "$eq" : [ "$level", "PUBLIC" ] }, "then" : "$$PRUNE" }, { "case" : { "$eq" : [ "$classification", "RESTRICTED" ] }, "then" : { "$cond" : { "if" : { "$eq" : [ "$content", null ] }, "then" : "$$KEEP", "else" : "$$PRUNE" } } } ], "default" : "$$KEEP" } }'::documentdb_core.bson, ''::text, '{ }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document FROM documentdb_data.documents_8002_7990240 collection WHERE (shard_key_value OPERATOR(pg_catalog.=) '8002'::bigint)
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documentdb_data.documents_8002_7990240 collection
               Output: documentdb_api_internal.bson_dollar_redact(document, '{ "$switch" : { "branches" : [ { "case" : { "$eq" : [ "$level", "PUBLIC" ] }, "then" : "$$PRUNE" }, { "case" : { "$eq" : [ "$classification", "RESTRICTED" ] }, "then" : { "$cond" : { "if" : { "$eq" : [ "$content", null ] }, "then" : "$$KEEP", "else" : "$$PRUNE" } } } ], "default" : "$$KEEP" } }'::documentdb_core.bson, ''::text, '{ }'::documentdb_core.bson, 'en-u-ks-level1'::text)
               Recheck Cond: (collection.shard_key_value = '8002'::bigint)
               ->  Bitmap Index Scan on _id_
                     Index Cond: (collection.shard_key_value = '8002'::bigint)
(12 rows)

ROLLBACK;
-- support for $setEquals
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setEquals": [["$a"], ["CAT"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : false }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : false }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setEquals": [["$a"], ["DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 2} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setEquals": [["$a"], ["DOG", "dOg"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 2} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setEquals": [["$a", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : false }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : false }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setEquals": [["$a", "cAT", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setEquals": [["$a", "cAT", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : false }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : false }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

-- support for $setIntersection
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setIntersection": [["$a"], ["CAT"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                document                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [ "cat" ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [  ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [ "cAt" ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [  ] }
 { "_id" : "hen", "a" : "hen", "newField" : [  ] }
 { "_id" : "bat", "a" : "bat", "newField" : [  ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setIntersection": [["$a"], ["DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 2} }');
                                document                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [  ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [ "dog" ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [  ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [ "dOg" ] }
 { "_id" : "hen", "a" : "hen", "newField" : [  ] }
 { "_id" : "bat", "a" : "bat", "newField" : [  ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setIntersection": [["$a"], ["DOG", "dOg"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 2} }');
                                document                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [  ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [ "dog" ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [  ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [ "dOg" ] }
 { "_id" : "hen", "a" : "hen", "newField" : [  ] }
 { "_id" : "bat", "a" : "bat", "newField" : [  ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setIntersection": [["$a", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                    document                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [ "cat", "dog" ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [ "dog" ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [ "cAt", "dog" ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [ "dOg" ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ "dog" ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ "dog" ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setIntersection": [["$a", "cAT", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                    document                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [ "cat", "dog" ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [ "cAT", "dog" ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [ "cAt", "dog" ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [ "cAT", "dOg" ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ "cAT", "dog" ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ "cAT", "dog" ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setIntersection": [["$a", "cAT", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [  ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [  ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [  ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [  ] }
 { "_id" : "hen", "a" : "hen", "newField" : [  ] }
 { "_id" : "bat", "a" : "bat", "newField" : [  ] }
(6 rows)

-- support for $setUnion
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setUnion": [["$a"], ["CAT"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                    document                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [ "cat" ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [ "CAT", "dog" ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [ "cAt" ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [ "CAT", "dOg" ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ "CAT", "hen" ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ "CAT", "bat" ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setUnion": [["$a"], ["DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 2} }');
                                    document                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [ "cat", "DOG" ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [ "dog" ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [ "cAt", "DOG" ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [ "dOg" ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ "hen", "DOG" ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ "DOG", "bat" ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setUnion": [["$a"], ["DOG", "dOg"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 2} }');
                                    document                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [ "cat", "DOG" ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [ "dog" ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [ "cAt", "DOG" ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [ "dOg" ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ "hen", "DOG" ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ "DOG", "bat" ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setUnion": [["$a", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                    document                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [ "cat", "dog" ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [ "CAT", "dog" ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [ "cAt", "dog" ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [ "CAT", "dOg" ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ "CAT", "dog", "hen" ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ "CAT", "bat", "dog" ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setUnion": [["$a", "cAT", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                    document                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [ "cat", "dog" ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [ "cAT", "dog" ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [ "cAt", "dog" ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [ "cAT", "dOg" ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ "cAT", "dog", "hen" ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ "cAT", "bat", "dog" ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setUnion": [["$a", "cAT", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
                                              document                                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [ "CAT", "DOG", "dog", "cat", "cAT" ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [ "CAT", "DOG", "dog", "cAT" ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [ "CAT", "DOG", "dog", "cAT", "cAt" ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [ "CAT", "DOG", "dog", "dOg", "cAT" ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ "CAT", "DOG", "dog", "hen", "cAT" ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ "CAT", "DOG", "bat", "dog", "cAT" ] }
(6 rows)

-- support for $setDifference
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setDifference": [["$a"], ["CAT"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                document                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [  ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [ "dog" ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [  ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [ "dOg" ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ "hen" ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ "bat" ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setDifference": [["$a"], ["DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 2} }');
                                document                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [ "cat" ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [  ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [ "cAt" ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [  ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ "hen" ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ "bat" ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setDifference": [["$a"], ["DOG", "dOg"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 2} }');
                                document                                 
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [ "cat" ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [  ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [ "cAt" ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [  ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ "hen" ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ "bat" ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setDifference": [["$a", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [  ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [  ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [  ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [  ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ "hen" ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ "bat" ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setDifference": [["$a", "cAT", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [  ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [  ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [  ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [  ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ "hen" ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ "bat" ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setDifference": [["$a", "cAT", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
                                       document                                        
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [ "cat", "cAT", "dog" ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [ "dog", "cAT" ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [ "cAt", "cAT", "dog" ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [ "dOg", "cAT", "dog" ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ "hen", "cAT", "dog" ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ "bat", "cAT", "dog" ] }
(6 rows)

-- support for $setIsSubset
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setIsSubset": [["$a"], ["CAT"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : false }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : false }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setIsSubset": [["$a"], ["DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 2} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setIsSubset": [["$a"], ["DOG", "dOg"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 2} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setIsSubset": [["$a", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setIsSubset": [["$a", "cAT", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                              document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : true }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : true }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": {"$setIsSubset": [["$a", "cAT", "dog"], ["CAT", "DOG"]]} } }], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : false }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : false }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : false }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : false }
 { "_id" : "hen", "a" : "hen", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(6 rows)

-- support in $let
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": { "$let": { "vars": { "var1": "$a" }, "in": { "$cond": { "if": { "$eq": ["$$var1", "CAT"] }, "then": 1, "else": 0 } } } } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : { "$numberInt" : "0" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : { "$numberInt" : "1" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : { "$numberInt" : "0" } }
 { "_id" : "hen", "a" : "hen", "newField" : { "$numberInt" : "0" } }
 { "_id" : "bat", "a" : "bat", "newField" : { "$numberInt" : "0" } }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": { "$let": { "vars": { "var1": "$a" }, "in": { "$cond": { "if": { "$eq": ["$$var1", "CAT"] }, "then": 1, "else": 0 } } } } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : { "$numberInt" : "0" } }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : { "$numberInt" : "0" } }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : { "$numberInt" : "0" } }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : { "$numberInt" : "0" } }
 { "_id" : "hen", "a" : "hen", "newField" : { "$numberInt" : "0" } }
 { "_id" : "bat", "a" : "bat", "newField" : { "$numberInt" : "0" } }
(6 rows)

-- support for $zip
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": { "$zip": { "inputs": [ {"$cond": [{"$eq": ["CAT", "$a"]}, ["$a"], ["null"]]}, ["$a"]] } } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                      document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [ [ "cat", "cat" ] ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [ [ "null", "dog" ] ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [ [ "cAt", "cAt" ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [ [ "null", "dOg" ] ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ [ "null", "hen" ] ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ [ "null", "bat" ] ] }
(6 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_agg_proj", "pipeline": [ { "$project": { "a": 1, "newField": { "$zip": { "inputs": [ {"$cond": [{"$eq": ["CAT", "$a"]}, ["$a"], ["null"]]}, ["$a"]] } } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 3} }');
                                      document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : [ [ "null", "cat" ] ] }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : [ [ "null", "dog" ] ] }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : [ [ "null", "cAt" ] ] }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : [ [ "null", "dOg" ] ] }
 { "_id" : "hen", "a" : "hen", "newField" : [ [ "null", "hen" ] ] }
 { "_id" : "bat", "a" : "bat", "newField" : [ [ "null", "bat" ] ] }
(6 rows)

-- test without auto variables ($$NOW) generation 
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "projection": { "a": 1, "newField": { "$eq": ["$a", "CAT"] } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "cat", "newField" : true }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "newField" : false }
 { "_id" : { "$numberInt" : "3" }, "a" : "cAt", "newField" : true }
 { "_id" : { "$numberInt" : "4" }, "a" : "dOg", "newField" : false }
 { "_id" : "bat", "a" : "bat", "newField" : false }
(5 rows)

EXPLAIN (VERBOSE ON, COSTS OFF)  SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_agg_proj", "projection": { "a": 1, "newField": { "$eq": ["$a", "CAT"] } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                           QUERY PLAN                                                                                                                                                                                                                                                                                                            
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_project_find(document, '{ "a" : { "$numberInt" : "1" }, "newField" : { "$eq" : [ "$a", "CAT" ] } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document FROM documentdb_data.documents_8000_7990215 collection WHERE (shard_key_value OPERATOR(pg_catalog.=) '8000'::bigint) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: (documentdb_api_internal.bson_dollar_project_find(document, '{ "a" : { "$numberInt" : "1" }, "newField" : { "$eq" : [ "$a", "CAT" ] } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'en-u-ks-level1'::text)), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: (documentdb_api_internal.bson_dollar_project_find(document, '{ "a" : { "$numberInt" : "1" }, "newField" : { "$eq" : [ "$a", "CAT" ] } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'en-u-ks-level1'::text)), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Bitmap Heap Scan on documentdb_data.documents_8000_7990215 collection
                           Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "a" : { "$numberInt" : "1" }, "newField" : { "$eq" : [ "$a", "CAT" ] } }'::documentdb_core.bson, '{ }'::documentdb_core.bson, '{ }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Recheck Cond: (collection.shard_key_value = '8000'::bigint)
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection.shard_key_value = '8000'::bigint)
(17 rows)

ROLLBACK;
-- query match
-- ignore collation (make sure all 3 GUCs are off)
SET documentdb.enableLetAndCollationForQueryMatch TO off;
SET documentdb.enableVariablesSupportForWriteCommands TO off;
SET documentdb_core.enableCollation TO off;
SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{"a": "CAT"}', NULL, 'en-u-ks-level1');
NOTICE:  using bson_query_match implementation
 bson_query_match 
---------------------------------------------------------------------
 f
(1 row)

-- enforce collation
SET documentdb_core.enableCollation TO on;
SET documentdb.enableLetAndCollationForQueryMatch TO on;
-- query match: _id tests
SELECT documentdb_api_internal.bson_query_match('{"_id": "cat"}', '{"_id": "CAT"}', NULL, 'en-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"_id": "cat"}', '{"_id": "CAT"}', NULL, 'en-u-ks-level2');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"_id": "cat"}', '{"_id": "CAT"}', NULL, 'en-US-u-ks-level2');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

-- query match: $eq
SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{"a": "CAT"}', NULL, 'en-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{ "a": {"$eq" : "CAT"} }', NULL, 'de-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{ "a": {"$eq" : "ct"} }', NULL, 'fr-u-ks-level3');
 bson_query_match 
---------------------------------------------------------------------
 f
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"a": "cat", "b": "dog"}', '{"a": "CAT", "b": "DOG"}', NULL, 'en-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"a": "cat", "b": "dog"}', '{"a": "CAT", "b": "DOG"}', NULL, 'sv-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

-- query match: $ne
SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{ "a": {"$ne" : "CAT"} }', NULL, 'de-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 f
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{ "a": {"$ne" : "ct"} }', NULL, 'fr-u-ks-level3');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"a": "cat", "b": "dog"}', '{"a": "CAT", "b": "DOG"}', NULL, 'en-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"a": "cat", "b": "dog"}', '{"a": "CAT", "b": "DOG"}', NULL, 'sv-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

-- query match: $gt/$gte
SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{ "a": {"$gt" : "CAT"} }', NULL, 'de-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 f
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{ "a": {"$gte" : "CAT"} }', NULL, 'en-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

-- query match: $lt/$lte
SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{ "a": {"$lte" : "CAT"} }', NULL, 'de-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{ "a": {"$lte" : "ct"} }', NULL, 'fr-u-ks-level3');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{ "a": {"$lte" : "ct"} }', NULL, 'fr-CA-u-ks-level3');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

-- query match: $in
SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{ "a": {"$in" : ["CAT", "DOG"]} }', NULL, 'de-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{ "a": {"$in" : ["ct", "dg"]} }', NULL, 'fr-u-ks-level3');
 bson_query_match 
---------------------------------------------------------------------
 f
(1 row)

-- query match: $nin
SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{ "a": {"$nin" : ["CAT", "DOG"]} }', NULL, 'en-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 f
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"a": "cat"}', '{ "a": {"$nin" : ["ct", "dg"]} }', NULL, 'fr-u-ks-level3');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

-- query match: sharded collection
ALTER SYSTEM SET documentdb_core.enablecollation='on';
SELECT pg_reload_conf();
 pg_reload_conf 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_qm_sharded', '{ "_id": "cat", "a": "cat" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_qm_sharded', '{ "_id": "dog", "a": "dog" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_qm_sharded', '{ "_id": 3, "a": "peacock" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- query match: single shard key
SELECT documentdb_api.shard_collection('db', 'coll_qm_sharded', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- we expect the query to be distributed: shard key value is collation-aware
BEGIN;
SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{ "_id": "CAT" }', NULL, 'en-u-ks-level1');
            document            
---------------------------------------------------------------------
 { "_id" : "cat", "a" : "cat" }
(1 row)

EXPLAIN (COSTS OFF) SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{ "_id": "CAT" }', NULL, 'en-u-ks-level1');
                                                                   QUERY PLAN                                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_8003_7990272 documents_8003
               Filter: (document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(7 rows)

ROLLBACK;
-- we do not expect the query to be distributed: shard key value is not collation-aware
BEGIN;
SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{ "_id": 3 }', NULL, 'en-u-ks-level1');
                      document                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "peacock" }
(1 row)

EXPLAIN (COSTS OFF) SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{ "_id": 3 }', NULL, 'en-u-ks-level1');
                                                                                     QUERY PLAN                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using _id_ on documents_8003_7990273 collection
               Index Cond: ((shard_key_value = '-4918719581749358852'::bigint) AND (object_id OPERATOR(documentdb_core.=) '{ "" : { "$numberInt" : "3" } }'::documentdb_core.bson))
               Filter: (document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : { "$numberInt" : "3" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(8 rows)

ROLLBACK;
-- query match: compound shard key
SELECT documentdb_api.drop_collection('db', 'coll_qm_sharded');
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_qm_sharded', '{ "_id": "cAt", "a": "cAt" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_qm_sharded', '{ "_id": "doG", "a": "DOg" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_qm_sharded', '{ "_id": 3, "a": "doG" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.shard_collection('db', 'coll_qm_sharded', '{ "_id": "hashed", "a": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- we expect the query to be distributed: shard key filter values is collation-aware
BEGIN;
SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{ "_id": "CAT", "a": "CAT" }', NULL, 'en-u-ks-level1');
            document            
---------------------------------------------------------------------
 { "_id" : "cAt", "a" : "cAt" }
(1 row)

EXPLAIN (COSTS OFF) SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{ "_id": "CAT", "a": "CAT" }', NULL, 'en-u-ks-level1');
                                                                                                                                 QUERY PLAN                                                                                                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_8004_7990296 documents_8004
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(7 rows)

ROLLBACK;
BEGIN;
SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{"$and": [{"_id": "cat", "a": "1"}, {"_id": 3, "a": 3}] }', NULL, 'en-u-ks-level1');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (COSTS OFF) SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{"$and": [{"_id": "cat", "a": "1"}, {"_id": 3, "a": 3}] }', NULL, 'en-u-ks-level1');
                                                                                                                                                                                                                                                                             QUERY PLAN                                                                                                                                                                                                                                                                              
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Bitmap Heap Scan on documents_8004_7990300 collection
               Recheck Cond: (shard_key_value = '-5490684746852247962'::bigint)
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "1", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : { "$numberInt" : "3" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "3" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
               ->  Bitmap Index Scan on _id_
                     Index Cond: (shard_key_value = '-5490684746852247962'::bigint)
(10 rows)

ROLLBACK;
BEGIN;
SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{"$or": [{"_id": "CAT", "a": "CAT"}, {"_id": 3, "a": "dog"}] }', NULL, 'en-u-ks-level1');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "doG" }
 { "_id" : "cAt", "a" : "cAt" }
(2 rows)

EXPLAIN (COSTS OFF) SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{"$or": [{"_id": "cat", "a": "CAT"}, {"_id": 3, "a": "dog"}] }', NULL, 'en-u-ks-level1');
                                                                                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_8004_7990296 documents_8004
               Filter: (((document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)) OR ((document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : { "$numberInt" : "3" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)))
(7 rows)

ROLLBACK;
-- we do not expect the query to be distributed
BEGIN;
SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{ "_id": 1, "a": "CAT" }', NULL, 'en-u-ks-level1');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (COSTS OFF) SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{ "_id": 1, "a": "CAT" }', NULL, 'en-u-ks-level1');
                                                                                                                                          QUERY PLAN                                                                                                                                          
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_8004_7990296 documents_8004
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : { "$numberInt" : "1" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(7 rows)

ROLLBACK;
BEGIN;
SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{ "_id": 3, "a": 4 }', NULL, 'en-u-ks-level1');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (COSTS OFF) SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{ "_id": 3, "a": 4 }', NULL, 'en-u-ks-level1');
                                                                                                                                                  QUERY PLAN                                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using _id_ on documents_8004_7990300 collection
               Index Cond: ((shard_key_value = '-6813820020108376455'::bigint) AND (object_id OPERATOR(documentdb_core.=) '{ "" : { "$numberInt" : "3" } }'::documentdb_core.bson))
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : { "$numberInt" : "3" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "4" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(8 rows)

ROLLBACK;
BEGIN;
SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{"$or": [{"_id": 3, "a": "dog"}, {"_id": 3, "a": 3}] }', NULL, 'en-u-ks-level1');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "doG" }
(1 row)

EXPLAIN (COSTS OFF) SELECT document from documentdb_api.collection('db', 'coll_qm_sharded') WHERE documentdb_api_internal.bson_query_match(document, '{"$or": [{"_id": 3, "a": "dog"}, {"_id": 3, "a": 3}] }', NULL, 'en-u-ks-level1');
                                                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                                                 
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_8004_7990296 documents_8004
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : { "$numberInt" : "3" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND ((document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) OR (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "3" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson)))
(7 rows)

ROLLBACK;
-- collation on sharded collections: aggregation
SELECT documentdb_api.insert_one('db', 'coll_sharded_agg', '{ "_id": "cat", "a": "cat" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_sharded_agg', '{ "_id": "cAt", "a": "cAt" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_sharded_agg', '{ "_id": "dog", "a": "dog" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_sharded_agg', '{ "_id": "dOg", "a": "dOg" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- simple shard key
SELECT documentdb_api.shard_collection('db', 'coll_sharded_agg', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- query is distributed to all shards
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_sharded_agg", "filter": { "_id": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
            document            
---------------------------------------------------------------------
 { "_id" : "cat", "a" : "cat" }
 { "_id" : "cAt", "a" : "cAt" }
(2 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_sharded_agg", "filter": { "_id": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                                                                                                                   
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_8005_7990320 collection WHERE (document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_8005_7990320 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(20 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_sharded_agg", "pipeline": [ { "$match": { "_id": { "$eq": "CAT" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
            document            
---------------------------------------------------------------------
 { "_id" : "cat", "a" : "cat" }
 { "_id" : "cAt", "a" : "cAt" }
(2 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_sharded_agg", "pipeline": [ { "$match": { "_id": { "$eq": "CAT" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 2} }');
                                                                                                        QUERY PLAN                                                                                                         
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_8005_7990320 collection WHERE (document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : "CAT", "collation" : "en-u-ks-level2" }'::documentdb_core.bsonquery)
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documentdb_data.documents_8005_7990320 collection
               Output: document
               Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : "CAT", "collation" : "en-u-ks-level2" }'::documentdb_core.bson)
(10 rows)

-- query is not distributed to all shards (shard key value is not collation-aware)
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_sharded_agg", "filter": { "_id": { "$eq": 2 } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_sharded_agg", "filter": { "_id": { "$eq": 2 } }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_8005_7990321 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : { "$numberInt" : "2" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '-1389566185330078543'::bigint) AND (object_id OPERATOR(documentdb_core.=) '{ "" : { "$numberInt" : "2" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Index Scan using _id_ on documentdb_data.documents_8005_7990321 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Index Cond: ((collection.shard_key_value = '-1389566185330078543'::bigint) AND (collection.object_id OPERATOR(documentdb_core.=) '{ "" : { "$numberInt" : "2" } }'::documentdb_core.bson))
                           Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : { "$numberInt" : "2" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(16 rows)

SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_sharded_agg", "pipeline": [ { "$match": { "_id": { "$eq": 1 } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_sharded_agg", "pipeline": [ { "$match": { "_id": { "$eq": 1 } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 2} }');
                                                                                                                                                                                                         QUERY PLAN                                                                                                                                                                                                          
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_8005_7990327 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : { "$numberInt" : "1" }, "collation" : "en-u-ks-level2" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '4322365043291501017'::bigint) AND (object_id OPERATOR(documentdb_core.=) '{ "" : { "$numberInt" : "1" } }'::documentdb_core.bson))
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using _id_ on documentdb_data.documents_8005_7990327 collection
               Output: document
               Index Cond: ((collection.shard_key_value = '4322365043291501017'::bigint) AND (collection.object_id OPERATOR(documentdb_core.=) '{ "" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : { "$numberInt" : "1" }, "collation" : "en-u-ks-level2" }'::documentdb_core.bson)
(11 rows)

-- compound shard key
SELECT documentdb_api.drop_collection('db', 'coll_sharded_agg');
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_sharded_agg', '{ "_id": "cAt", "a": "cAt" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_sharded_agg', '{ "_id": "doG", "a": "Dog" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.shard_collection('db', 'coll_sharded_agg', '{ "_id": "hashed", "a": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- query is distributed to all shards (filter by shard_key_value is omitted)
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_sharded_agg", "filter": { "a": { "$eq": "Cat" }, "_id": "caT" }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
            document            
---------------------------------------------------------------------
 { "_id" : "cAt", "a" : "cAt" }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_sharded_agg", "filter": { "a": { "$eq": "Cat" }, "_id": "caT" }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                                                                                   QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                    
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_8006_7990344 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "Cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : "caT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_8006_7990344 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "Cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : "caT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(20 rows)

BEGIN;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_sharded_agg", "pipeline": [ { "$match":{"_id": "CAT", "a": "CAT"} } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
            document            
---------------------------------------------------------------------
 { "_id" : "cAt", "a" : "cAt" }
(1 row)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_sharded_agg", "pipeline": [ { "$match":{"_id": "CAT", "a": "CAT"} } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                 QUERY PLAN                                                                                                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_8006_7990344 collection
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(7 rows)

ROLLBACK;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_sharded_agg", "filter": { "$or": [{"_id": "CAT", "a": "CAT"}, {"_id": 3, "a": "dog"}] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
            document            
---------------------------------------------------------------------
 { "_id" : "cAt", "a" : "cAt" }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_sharded_agg", "filter": { "$or": [{"_id": "CAT", "a": "CAT"}, {"_id": 3, "a": "dog"}] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_8006_7990344 collection WHERE (((document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) OR ((document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : { "$numberInt" : "3" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_8006_7990344 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: (((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)) OR ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : { "$numberInt" : "3" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)))
(20 rows)

BEGIN;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_sharded_agg", "pipeline": [ { "$match":{"$or": [{"_id": "1", "a": "CaT"}, {"_id": "DOG"}]} } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
            document            
---------------------------------------------------------------------
 { "_id" : "doG", "a" : "Dog" }
(1 row)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_sharded_agg", "pipeline": [ { "$match":{"$or": [{"_id": "1", "a": "CaT"}, {"_id": "DOG"}]} } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_8006_7990344 collection
               Filter: (((document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : "1", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CaT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)) OR (document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(7 rows)

ROLLBACK;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_sharded_agg", "filter": { "$and": [{"_id": "CAT", "a": "CAT"}, {"_id": 3, "a": "dog"}] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_sharded_agg", "filter": { "$and": [{"_id": "CAT", "a": "CAT"}, {"_id": 3, "a": "dog"}] }, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_8006_7990344 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : { "$numberInt" : "3" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_8006_7990344 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : { "$numberInt" : "3" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(20 rows)

BEGIN;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_sharded_agg", "pipeline": [ { "$match":{"$or": [{"_id": "cat", "a": 2 }, {"_id": 1, "a": 1 }]} } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_sharded_agg", "pipeline": [ { "$match":{"$or": [{"_id": "cat", "a": 2 }, {"_id": 1, "a": 1 }]} } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                        QUERY PLAN                                                                                                                                                                                                                                                                                         
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 8
   Tasks Shown: One of 8
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Seq Scan on documents_8006_7990344 collection
               Filter: (((document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "2" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson)) OR ((document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : { "$numberInt" : "1" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "1" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson)))
(7 rows)

ROLLBACK;
-- query is not distributed to all shards
BEGIN;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_sharded_agg", "pipeline": [ { "$match":{"_id": 1, "a": 1 } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_sharded_agg", "pipeline": [ { "$match":{"_id": 1, "a": 1 } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                  QUERY PLAN                                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Node: host=localhost port=58070 dbname=regression
         ->  Index Scan using _id_ on documents_8006_7990349 collection
               Index Cond: ((shard_key_value = '-1082522962276288030'::bigint) AND (object_id OPERATOR(documentdb_core.=) '{ "" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Filter: ((document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : { "$numberInt" : "1" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.@=) '{ "a" : { "$numberInt" : "1" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(8 rows)

ROLLBACK;
-- nested arrays
SELECT documentdb_api_internal.bson_query_match('{"a": ["cat"]}', '{ "a": {"$in" : [["CAT"], "DOG"]} }', NULL, 'de-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"a": ["cat"]}', '{ "a": {"$in" : [["CAT"], ["DOG"]] } }', NULL, 'de-u-ks-level3');
 bson_query_match 
---------------------------------------------------------------------
 f
(1 row)

SELECT documentdb_api.insert_one('db', 'nested_arrays', '{ "_id": 1, "a": ["dog"] }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'nested_arrays', '{ "_id": 2, "a": ["cat", "dog"] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'nested_arrays', '{ "_id": 3, "a": [[["cat"]]] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "nested_arrays", "filter": { "a" : {"$in" : [ ["dOG"] ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                      document                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ "dog" ] }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "nested_arrays", "filter": { "a" : {"$in" : [ [["CAT"]] ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                          document                           
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : [ [ [ "cat" ] ] ] }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "nested_arrays", "filter": { "a" : {"$in" : [["CAT"], ["DOG"]] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                      document                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : [ "dog" ] }
(1 row)

-- nested documents
SELECT documentdb_api_internal.bson_query_match('{"a": {"b": "cat"}}', '{ "a": {"b": "CAT"} }', NULL, 'en-u-ks-level1');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api_internal.bson_query_match('{"a": {"b": {"c": "cat"}}}', '{ "a": {"b": {"c": "CAT"}} }', NULL, 'en-u-ks-level2');
 bson_query_match 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.insert_one('db', 'nested_docs', '{ "_id": 1, "a": { "b": "cat" } }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'nested_docs', '{ "_id": 2, "a": { "b": "dog" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'nested_docs', '{ "_id": 3, "a": { "b": { "c": "cat" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'nested_docs', '{ "_id": 4, "a": { "b": { "c": "dog" } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'nested_docs', '{ "_id": 5, "a": { "b": { "c": { "d": "cat" } } } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "nested_docs", "filter": { "a" : {"$in" : [ {"b": "dOG"} ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                         document                          
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : "dog" } }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "nested_docs", "filter": { "a" : {"$in" : [ {"b": { "c": "dOg" }} ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                              document                               
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : { "c" : "dog" } } }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "nested_docs", "filter": { "a" : {"$in" : [ {"b": { "c": { "d": "dOg" }}} ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

-- nested documents: keys are collation-agnostic
SELECT document FROM bson_aggregation_find('db', '{ "find": "nested_docs", "filter": { "a" : {"$in" : [ {"B": "dOG"} ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

-- nested arrays and documents
SELECT documentdb_api.insert_one('db', 'nested_arrays_docs', '{ "_id": 1, "a": { "b": ["cat"] } }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'nested_arrays_docs', '{ "_id": 2, "a": { "b": ["dog"] } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'nested_arrays_docs', '{ "_id": 3, "a": { "b": ["cat", "dog"] } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'nested_arrays_docs', '{ "_id": 4, "a": {"b": [["dog"]] } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'nested_arrays_docs', '{ "_id": 5, "a": { "b": [[["cat"]]] } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'nested_arrays_docs', '{ "_id": 6, "a": "cat" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{ "find": "nested_arrays_docs", "filter": { "a" : {"$in" : [ {"b": ["dOG"]}, "CAT" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                           document                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ "dog" ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : "cat" }
(2 rows)

SELECT document FROM bson_aggregation_find('db', '{ "find": "nested_arrays_docs", "filter": { "a" : {"$in" : [ {"b": [["dOg"]] } ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "4" }, "a" : { "b" : [ [ "dog" ] ] } }
(1 row)

-- test without auto variables ($$NOW) generation
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
SELECT document FROM bson_aggregation_find('db', '{ "find": "nested_arrays_docs", "filter": { "a" : {"$in" : [ {"b": ["dOG"]}, "CAT" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                           document                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : { "b" : [ "dog" ] } }
 { "_id" : { "$numberInt" : "6" }, "a" : "cat" }
(2 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "nested_arrays_docs", "filter": { "a" : {"$in" : [ {"b": ["dOG"]}, "CAT" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 5, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_8009_7990389 collection WHERE ((documentdb_api_catalog.bson_dollar_in(document, '{ "a" : [ { "b" : [ "dOG" ] }, "CAT" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_internal.##=) ANY (ARRAY['{ "a" : { "b" : [ "dOG" ] }, "collation" : "en-u-ks-level1" }'::documentdb_api_internal.bsonindexbounds, '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_api_internal.bsonindexbounds]))) AND (shard_key_value OPERATOR(pg_catalog.=) '8009'::bigint)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Bitmap Heap Scan on documentdb_data.documents_8009_7990389 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Recheck Cond: (collection.shard_key_value = '8009'::bigint)
                           Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "a" : [ { "b" : [ "dOG" ] }, "CAT" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection.shard_key_value = '8009'::bigint)
(18 rows)

ROLLBACK;
SET documentdb.enableLetAndCollationForQueryMatch to off;
-- delete
SELECT documentdb_api.insert_one('db', 'coll_delete', '{"_id": "dog", "a":"dog"}');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_delete', '{"_id": "DOG", "a":"DOG"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_delete', '{"_id": "cat", "a":"cat"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_delete', '{"_id": "CAT", "a":"CAT"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- GUC off: collation ignored
SET documentdb_core.enableCollation TO off;
BEGIN;
SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ {"q": {"_id": "DoG" }, "limit": 0, "collation": { "locale": "fr", "strength" : 2}} ]}');
ERROR:  BSON field 'delete.deletes.collation' is not yet supported
CONTEXT:  SQL statement "SELECT documentdb_api_internal.delete_worker($1, $2, $3, $4::documentdb_core.bson, $5::documentdb_core.bsonsequence, $6) FROM documentdb_data.documents_8010 WHERE shard_key_value = 8010"
ROLLBACK;
-- enable GUC
SET documentdb_core.enableCollation TO on;
BEGIN;
-- query on _id
SET citus.log_remote_commands TO ON;
-- _id is not collation-aware
SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ {"q": {"_id": 1 }, "limit": 0, "collation": { "locale": "fr", "strength" : 2}} ]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.delete_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS delete_worker FROM documentdb_data.documents_8010_7990407 documents_8010 WHERE (shard_key_value OPERATOR(pg_catalog.=) 8010)
NOTICE:  executing the command locally: DELETE FROM documentdb_data.documents_8010_7990407 documents_8010 WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : { "$numberInt" : "1" }, "collation" : "fr-u-ks-level2" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '8010'::bigint) AND (object_id OPERATOR(documentdb_core.=) '{ "" : { "$numberInt" : "1" } }'::documentdb_core.bson))
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ {"q": {"_id": "DoG" }, "limit": 0, "collation": { "locale": "fr", "strength" : 2}} ]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.delete_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS delete_worker FROM documentdb_data.documents_8010_7990407 documents_8010 WHERE (shard_key_value OPERATOR(pg_catalog.=) 8010)
NOTICE:  executing the command locally: DELETE FROM documentdb_data.documents_8010_7990407 documents_8010 WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : "DoG", "collation" : "fr-u-ks-level2" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '8010'::bigint))
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""2"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ {"q": {"_id": "cAT" }, "limit": 0, "collation": { "locale": "fr", "strength" : 3}} ]}');
NOTICE:  executing the command locally: SELECT documentdb_api_internal.delete_worker($1, $2, $3, ($4)::documentdb_core.bson, ($5)::documentdb_core.bsonsequence, $6) AS delete_worker FROM documentdb_data.documents_8010_7990407 documents_8010 WHERE (shard_key_value OPERATOR(pg_catalog.=) 8010)
NOTICE:  executing the command locally: DELETE FROM documentdb_data.documents_8010_7990407 documents_8010 WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : "cAT", "collation" : "fr-u-ks-level3" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '8010'::bigint))
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

ROLLBACK;
BEGIN;
--- deleteMany
SELECT document from documentdb_api.collection('db', 'coll_delete');
            document            
---------------------------------------------------------------------
 { "_id" : "dog", "a" : "dog" }
 { "_id" : "DOG", "a" : "DOG" }
 { "_id" : "cat", "a" : "cat" }
 { "_id" : "CAT", "a" : "CAT" }
(4 rows)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "CaT" }, "limit": 0, "collation": { "locale": "en", "strength" : 3}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "CaT" }, "limit": 0, "collation": { "locale": "en", "strength" : 1}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""2"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "DoG" }, "limit": 0, "collation": { "locale": "en", "strength" : 3}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "DoG" }, "limit": 0, "collation": { "locale": "en", "strength" : 1}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""2"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document from documentdb_api.collection('db', 'coll_delete');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
BEGIN;
--- deleteOne
SELECT document from documentdb_api.collection('db', 'coll_delete');
            document            
---------------------------------------------------------------------
 { "_id" : "dog", "a" : "dog" }
 { "_id" : "DOG", "a" : "DOG" }
 { "_id" : "cat", "a" : "cat" }
 { "_id" : "CAT", "a" : "CAT" }
(4 rows)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "CaT" }, "limit": 1, "collation": { "locale": "en", "strength" : 1}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "CaT" }, "limit": 1, "collation": { "locale": "en", "strength" : 3}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "DoG" }, "limit": 1, "collation": { "locale": "en", "strength" : 1}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "DoG" }, "limit": 1, "collation": { "locale": "en", "strength" : 3}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document from documentdb_api.collection('db', 'coll_delete');
            document            
---------------------------------------------------------------------
 { "_id" : "DOG", "a" : "DOG" }
 { "_id" : "CAT", "a" : "CAT" }
(2 rows)

ROLLBACK;
BEGIN;
-- more operators in query
SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ {"q": {"a": {"$lt": "DeG"} },"limit": 1, "collation": { "locale": "fr", "strength" : 1} }] }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ {"q": {"a": {"$lt": "DoG"}, "a": {"$lt": "Goat"} },"limit": 1, "collation": { "locale": "fr", "strength" : 2} }] }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ {"q": {"a": { "$exists": true }, "a": {"$gt": "DoG"}, "a": {"$lt": "goat"} },"limit": 1, "collation": { "locale": "fr", "strength" : 1 } }] }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document from documentdb_api.collection('db', 'coll_delete');
            document            
---------------------------------------------------------------------
 { "_id" : "dog", "a" : "dog" }
 { "_id" : "DOG", "a" : "DOG" }
(2 rows)

ROLLBACK;
-- test without auto variables ($$NOW) generation
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "CaT" }, "limit": 0, "collation": { "locale": "en", "strength" : 3}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "CaT" }, "limit": 0, "collation": { "locale": "en", "strength" : 3}}]}');
                                                                                                                       QUERY PLAN                                                                                                                        
---------------------------------------------------------------------
 Result
   Output: delete('db'::text, '{ "delete" : "coll_delete", "deletes" : [ { "q" : { "a" : "CaT" }, "limit" : { "$numberInt" : "0" }, "collation" : { "locale" : "en", "strength" : { "$numberInt" : "3" } } } ] }'::bson, NULL::bsonsequence, NULL::text)
(2 rows)

ROLLBACK;
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "CaT" }, "limit": 1, "collation": { "locale": "en", "strength" : 3}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "CaT" }, "limit": 1, "collation": { "locale": "en", "strength" : 3}}]}');
                                                                                                                       QUERY PLAN                                                                                                                        
---------------------------------------------------------------------
 Result
   Output: delete('db'::text, '{ "delete" : "coll_delete", "deletes" : [ { "q" : { "a" : "CaT" }, "limit" : { "$numberInt" : "1" }, "collation" : { "locale" : "en", "strength" : { "$numberInt" : "3" } } } ] }'::bson, NULL::bsonsequence, NULL::text)
(2 rows)

ROLLBACK;
-- delete with sort obeys collation
SELECT documentdb_api.insert_one('db', 'coll_delete_sort', '{"_id": "dog", "a": "dog"}');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_delete_sort', '{"_id": "DOG", "a": "dog"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

BEGIN;
-- sort respects collation: ASC
SELECT document from documentdb_api.collection('db', 'coll_delete_sort');
            document            
---------------------------------------------------------------------
 { "_id" : "dog", "a" : "dog" }
 { "_id" : "DOG", "a" : "dog" }
(2 rows)

SELECT collection_id AS coll_delete_sort FROM documentdb_api_catalog.collections WHERE database_name = 'db' AND collection_name = 'coll_delete_sort' \gset
SELECT documentdb_api_internal.delete_worker(
    p_collection_id=>:coll_delete_sort,
    p_shard_key_value=>:coll_delete_sort,
    p_shard_oid => 0,
    p_update_internal_spec => '{ "deleteOne": { "query": { "a": "dog" }, "collation": "en-u-ks-level3",  "sort": { "_id": 1 }, "returnDocument": 1, "returnFields": { "a": 0} } }'::bson,
    p_update_internal_docs=>null::bsonsequence,
    p_transaction_id=>null::text
) FROM documentdb_api.collection('db', 'coll_delete_sort');
                     delete_worker                      
---------------------------------------------------------------------
 { "isRowDeleted" : true, "objectId" : { "" : "dog" } }
(1 row)

    
SELECT document from documentdb_api.collection('db', 'coll_delete_sort');
            document            
---------------------------------------------------------------------
 { "_id" : "DOG", "a" : "dog" }
(1 row)

ROLLBACK;
BEGIN;
-- sort respects collation: DESC
SELECT document from documentdb_api.collection('db', 'coll_delete_sort');
            document            
---------------------------------------------------------------------
 { "_id" : "dog", "a" : "dog" }
 { "_id" : "DOG", "a" : "dog" }
(2 rows)

SELECT collection_id AS coll_delete_sort FROM documentdb_api_catalog.collections WHERE database_name = 'db' AND collection_name = 'coll_delete_sort' \gset
SELECT documentdb_api_internal.delete_worker(
    p_collection_id=>:coll_delete_sort,
    p_shard_key_value=>:coll_delete_sort,
    p_shard_oid => 0,
    p_update_internal_spec => '{ "deleteOne": { "query": { "a": "dog" }, "collation": "en-u-ks-level3",  "sort": { "_id": -1 }, "returnDocument": 1, "returnFields": { "a": 0} } }'::bson,
    p_update_internal_docs=>null::bsonsequence,
    p_transaction_id=>null::text
) FROM documentdb_api.collection('db', 'coll_delete_sort');
                     delete_worker                      
---------------------------------------------------------------------
 { "isRowDeleted" : true, "objectId" : { "" : "DOG" } }
(1 row)

    
SELECT document from documentdb_api.collection('db', 'coll_delete_sort');
            document            
---------------------------------------------------------------------
 { "_id" : "dog", "a" : "dog" }
(1 row)

ROLLBACK;
-- delete on sharded collection
SELECT documentdb_api.shard_collection('db', 'coll_delete', '{ "a": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

BEGIN;
--- deleteMany
SELECT document from documentdb_api.collection('db', 'coll_delete');
            document            
---------------------------------------------------------------------
 { "_id" : "cat", "a" : "cat" }
 { "_id" : "CAT", "a" : "CAT" }
 { "_id" : "dog", "a" : "dog" }
 { "_id" : "DOG", "a" : "DOG" }
(4 rows)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "CaT" }, "limit": 0, "collation": { "locale": "en", "strength" : 3}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "CaT" }, "limit": 0, "collation": { "locale": "en", "strength" : 1}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""2"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "DoG" }, "limit": 0, "collation": { "locale": "en", "strength" : 3}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "DoG" }, "limit": 0, "collation": { "locale": "en", "strength" : 1}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""2"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document from documentdb_api.collection('db', 'coll_delete');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
-- deleteOne: error: no _id filter and no shard key value filter
SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"b": "CaT" }, "limit": 1, "collation": { "locale": "en", "strength" : 1}}]}');
                                                                                                                                           delete                                                                                                                                           
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""1088"" }, ""errmsg"" : ""delete query with limit 1 must include either _id or shard key filter"" } ] }",f)
(1 row)

-- deleteOne: error: no _id filter and collation-aware shard key value filter
SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "CaT" }, "limit": 1, "collation": { "locale": "en", "strength" : 3}}]}');
                                                                                                                                                      delete                                                                                                                                                      
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" }, ""writeErrors"" : [ { ""index"" : { ""$numberInt"" : ""0"" }, ""code"" : { ""$numberInt"" : ""1088"" }, ""errmsg"" : ""delete query with limit 1 must include either _id or collation-insensitive shard key filter"" } ] }",f)
(1 row)

BEGIN;
--- deleteOne
SELECT document from documentdb_api.collection('db', 'coll_delete');
            document            
---------------------------------------------------------------------
 { "_id" : "cat", "a" : "cat" }
 { "_id" : "CAT", "a" : "CAT" }
 { "_id" : "dog", "a" : "dog" }
 { "_id" : "DOG", "a" : "DOG" }
(4 rows)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"_id": "CaT", "a": "CaT" }, "limit": 1, "collation": { "locale": "en", "strength" : 1}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"_id": "dog", "a": "DoG" }, "limit": 1, "collation": { "locale": "en", "strength" : 1}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document from documentdb_api.collection('db', 'coll_delete');
            document            
---------------------------------------------------------------------
 { "_id" : "CAT", "a" : "CAT" }
 { "_id" : "DOG", "a" : "DOG" }
(2 rows)

ROLLBACK;
BEGIN;
--- deleteOne
SELECT document from documentdb_api.collection('db', 'coll_delete');
            document            
---------------------------------------------------------------------
 { "_id" : "cat", "a" : "cat" }
 { "_id" : "CAT", "a" : "CAT" }
 { "_id" : "dog", "a" : "dog" }
 { "_id" : "DOG", "a" : "DOG" }
(4 rows)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"_id": "CaT" }, "limit": 1, "collation": { "locale": "en", "strength" : 1}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"_id": "CaT" }, "limit": 1, "collation": { "locale": "en", "strength" : 3}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"_id": "DoG" }, "limit": 1, "collation": { "locale": "en", "strength" : 1}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"_id": "DoG" }, "limit": 1, "collation": { "locale": "en", "strength" : 3}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document from documentdb_api.collection('db', 'coll_delete');
            document            
---------------------------------------------------------------------
 { "_id" : "CAT", "a" : "CAT" }
 { "_id" : "DOG", "a" : "DOG" }
(2 rows)

ROLLBACK;
SELECT documentdb_api.shard_collection('db', 'coll_delete_sort', '{ "a": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

BEGIN;
-- sort respects collation: ASC
SELECT document from documentdb_api.collection('db', 'coll_delete_sort');
            document            
---------------------------------------------------------------------
 { "_id" : "dog", "a" : "dog" }
 { "_id" : "DOG", "a" : "dog" }
(2 rows)

SELECT collection_id AS coll_delete_sort FROM documentdb_api_catalog.collections WHERE database_name = 'db' AND collection_name = 'coll_delete_sort' \gset
SELECT documentdb_api_internal.delete_worker(
    p_collection_id=>:coll_delete_sort,
    p_shard_key_value=>:coll_delete_sort,
    p_shard_oid => 0,
    p_update_internal_spec => '{ "deleteOne": { "query": { "_id": "dog" }, "collation": "en-u-ks-level3",  "sort": { "_id": 1 }, "returnDocument": 1, "returnFields": { "a": 0} } }'::bson,
    p_update_internal_docs=>null::bsonsequence,
    p_transaction_id=>null::text
) FROM documentdb_api.collection('db', 'coll_delete_sort');
                     delete_worker                      
---------------------------------------------------------------------
 { "isRowDeleted" : false }
 { "isRowDeleted" : false }
 { "isRowDeleted" : false }
 { "isRowDeleted" : true, "objectId" : { "" : "dog" } }
 { "isRowDeleted" : false }
 { "isRowDeleted" : false }
 { "isRowDeleted" : false }
 { "isRowDeleted" : false }
(8 rows)

    
SELECT document from documentdb_api.collection('db', 'coll_delete_sort');
            document            
---------------------------------------------------------------------
 { "_id" : "DOG", "a" : "dog" }
(1 row)

ROLLBACK;
BEGIN;
-- sort respects collation: DESC
SELECT document from documentdb_api.collection('db', 'coll_delete_sort');
            document            
---------------------------------------------------------------------
 { "_id" : "dog", "a" : "dog" }
 { "_id" : "DOG", "a" : "dog" }
(2 rows)

SELECT collection_id AS coll_delete_sort FROM documentdb_api_catalog.collections WHERE database_name = 'db' AND collection_name = 'coll_delete_sort' \gset
SELECT documentdb_api_internal.delete_worker(
    p_collection_id=>:coll_delete_sort,
    p_shard_key_value=>:coll_delete_sort,
    p_shard_oid => 0,
    p_update_internal_spec => '{ "deleteOne": { "query": { "a": "dog" }, "collation": "en-u-ks-level3",  "sort": { "_id": -1 }, "returnDocument": 1, "returnFields": { "a": 0} } }'::bson,
    p_update_internal_docs=>null::bsonsequence,
    p_transaction_id=>null::text
) FROM documentdb_api.collection('db', 'coll_delete_sort');
                     delete_worker                      
---------------------------------------------------------------------
 { "isRowDeleted" : false }
 { "isRowDeleted" : false }
 { "isRowDeleted" : false }
 { "isRowDeleted" : true, "objectId" : { "" : "DOG" } }
 { "isRowDeleted" : false }
 { "isRowDeleted" : false }
 { "isRowDeleted" : false }
 { "isRowDeleted" : false }
(8 rows)

    
SELECT document from documentdb_api.collection('db', 'coll_delete_sort');
            document            
---------------------------------------------------------------------
 { "_id" : "dog", "a" : "dog" }
(1 row)

ROLLBACK;
-- test without auto variables ($$NOW) generation
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "CaT" }, "limit": 0, "collation": { "locale": "en", "strength" : 3}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"a": "CaT" }, "limit": 0, "collation": { "locale": "en", "strength" : 3}}]}');
                                                                                                                       QUERY PLAN                                                                                                                        
---------------------------------------------------------------------
 Result
   Output: delete('db'::text, '{ "delete" : "coll_delete", "deletes" : [ { "q" : { "a" : "CaT" }, "limit" : { "$numberInt" : "0" }, "collation" : { "locale" : "en", "strength" : { "$numberInt" : "3" } } } ] }'::bson, NULL::bsonsequence, NULL::text)
(2 rows)

ROLLBACK;
BEGIN;
SET LOCAL documentdb.enableNowSystemVariable='off';
SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"_id": "DoG" }, "limit": 1, "collation": { "locale": "en", "strength" : 3}}]}');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT documentdb_api.delete('db', '{ "delete": "coll_delete", "deletes": [ { "q": {"_id": "DoG" }, "limit": 1, "collation": { "locale": "en", "strength" : 3}}]}');
                                                                                                                        QUERY PLAN                                                                                                                         
---------------------------------------------------------------------
 Result
   Output: delete('db'::text, '{ "delete" : "coll_delete", "deletes" : [ { "q" : { "_id" : "DoG" }, "limit" : { "$numberInt" : "1" }, "collation" : { "locale" : "en", "strength" : { "$numberInt" : "3" } } } ] }'::bson, NULL::bsonsequence, NULL::text)
(2 rows)

ROLLBACK;
SELECT documentdb_api.drop_collection('db', 'coll_delete');
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.drop_collection('db', 'coll_delete_sort');
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

-- find with positional queries
SELECT documentdb_api.insert_one('db', 'coll_find_positional', '{"_id":1, "a":"cat", "b":[{"a":"cat"},{"a":"caT"}], "c": ["cat"]}', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_find_positional', '{"_id":2, "a":"dog", "b":[{"a":"dog"},{"a":"doG"}], "c": ["dog"]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_find_positional', '{"_id":3, "a":"caT", "b":[{"a":"caT"},{"a":"cat"}], "c": ["caT"]}', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT document FROM bson_aggregation_find('db', '{
  "find": "coll_find_positional",
  "filter": { "a": "CAT", "b": { "$elemMatch": { "a": "CAT" } } },
  "projection": { "_id": 1, "b.$": 1 },
  "sort": { "_id": 1 },
  "skip": 0,
  "limit": 5,
  "collation": { "locale": "en", "strength" : 3}
}');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM bson_aggregation_find('db', '{
  "find": "coll_find_positional",
  "filter": { "a": "CAT", "b": { "$elemMatch": { "a": "CAT" } } },
  "projection": { "_id": 1, "b.$": 1 },
  "sort": { "_id": 1 },
  "skip": 0,
  "limit": 5,
  "collation": { "locale": "en", "strength" : 1 }
}');
                           document                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : [ { "a" : "cat" } ] }
 { "_id" : { "$numberInt" : "3" }, "b" : [ { "a" : "caT" } ] }
(2 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{
  "find": "coll_find_positional",
  "filter": { "a": "CAT", "b": { "$elemMatch": { "a": "CAT" } } },
  "projection": { "_id": 1, "b.$": 1 },
  "sort": { "_id": 1 },
  "skip": 0,
  "limit": 5,
  "collation": { "locale": "en", "strength" : 1 }
}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" }, "b.$" : { "$numberInt" : "1" } }'::documentdb_core.bson, '{ "a" : "CAT", "b" : { "$elemMatch" : { "a" : "CAT" } } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document FROM documentdb_data.documents_8012_7990452 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_catalog.bson_dollar_elemmatch(document, '{ "b" : { "a" : "CAT" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '8012'::bigint)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: (documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" }, "b.$" : { "$numberInt" : "1" } }'::documentdb_core.bson, '{ "a" : "CAT", "b" : { "$elemMatch" : { "a" : "CAT" } } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text)), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: (documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" }, "b.$" : { "$numberInt" : "1" } }'::documentdb_core.bson, '{ "a" : "CAT", "b" : { "$elemMatch" : { "a" : "CAT" } } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text)), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Bitmap Heap Scan on documentdb_data.documents_8012_7990452 collection
                           Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" }, "b.$" : { "$numberInt" : "1" } }'::documentdb_core.bson, '{ "a" : "CAT", "b" : { "$elemMatch" : { "a" : "CAT" } } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Recheck Cond: (collection.shard_key_value = '8012'::bigint)
                           Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@#?) '{ "b" : { "a" : "CAT" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection.shard_key_value = '8012'::bigint)
(18 rows)

-- sharded: find with positional queries
SELECT documentdb_api.shard_collection('db', 'coll_find_positional', '{ "a": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

SELECT document FROM bson_aggregation_find('db', '{
  "find": "coll_find_positional",
  "filter": { "a": "CAT", "b": { "$elemMatch": { "a": "CAT" } } },
  "projection": { "_id": 1, "b.$": 1 },
  "sort": { "_id": 1 },
  "skip": 0,
  "limit": 5,
  "collation": { "locale": "en", "strength" : 3}
}');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT document FROM bson_aggregation_find('db', '{
  "find": "coll_find_positional",
  "filter": { "a": "CAT", "b": { "$elemMatch": { "a": "CAT" } } },
  "projection": { "_id": 1, "b.$": 1 },
  "sort": { "_id": 1 },
  "skip": 0,
  "limit": 5,
  "collation": { "locale": "en", "strength" : 1 }
}');
                           document                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "b" : [ { "a" : "cat" } ] }
 { "_id" : { "$numberInt" : "3" }, "b" : [ { "a" : "caT" } ] }
(2 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{
  "find": "coll_find_positional",
  "filter": { "a": "CAT", "b": { "$elemMatch": { "a": "CAT" } } },
  "projection": { "_id": 1, "b.$": 1 },
  "sort": { "_id": 1 },
  "skip": 0,
  "limit": 5,
  "collation": { "locale": "en", "strength" : 1 }
}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" }, "b.$" : { "$numberInt" : "1" } }'::documentdb_core.bson, '{ "a" : "CAT", "b" : { "$elemMatch" : { "a" : "CAT" } } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_8012_7990464 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_catalog.bson_dollar_elemmatch(document, '{ "b" : { "a" : "CAT" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '5'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: (documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" }, "b.$" : { "$numberInt" : "1" } }'::documentdb_core.bson, '{ "a" : "CAT", "b" : { "$elemMatch" : { "a" : "CAT" } } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text)), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: (documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" }, "b.$" : { "$numberInt" : "1" } }'::documentdb_core.bson, '{ "a" : "CAT", "b" : { "$elemMatch" : { "a" : "CAT" } } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text)), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_8012_7990464 collection
                                       Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" }, "b.$" : { "$numberInt" : "1" } }'::documentdb_core.bson, '{ "a" : "CAT", "b" : { "$elemMatch" : { "a" : "CAT" } } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@#?) '{ "b" : { "a" : "CAT" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(20 rows)

SELECT documentdb_api.drop_collection('db', 'coll_find_positional');
 drop_collection 
---------------------------------------------------------------------
 t
(1 row)

ALTER SYSTEM SET documentdb_core.enablecollation='off';
SELECT pg_reload_conf();
 pg_reload_conf 
---------------------------------------------------------------------
 t
(1 row)

