SET search_path TO documentdb_api_catalog, documentdb_api, documentdb_core, public;
SET documentdb.next_collection_id TO 400;
SET documentdb.next_collection_index_id TO 400;
SET citus.next_shard_id TO 40000;
set documentdb.enablePrimaryKeyCursorScan to on;
-- insert 10 documents - but insert the _id as reverse order of insertion order (so that TID and insert order do not match)
DO $$
DECLARE i int;
BEGIN
FOR i IN 1..10 LOOP
PERFORM documentdb_api.insert_one('pkcursordb', 'aggregation_cursor_pk', FORMAT('{ "_id": %s, "sk": %s, "a": "%s", "c": [ %s "d" ] }',  10-i , mod(i, 2), repeat('Sample', 10), repeat('"' || repeat('a', 10) || '", ', 5))::documentdb_core.bson);
END LOOP;
END;
$$;
NOTICE:  creating collection
PREPARE drain_find_query(bson, bson) AS
    (WITH RECURSIVE cte AS (
        SELECT cursorPage, continuation FROM find_cursor_first_page(database => 'pkcursordb', commandSpec => $1, cursorId => 534)
        UNION ALL
        SELECT gm.cursorPage, gm.continuation FROM cte, cursor_get_more(database => 'pkcursordb', getMoreSpec => $2, continuationSpec => cte.continuation) gm
            WHERE cte.continuation IS NOT NULL
    )
    SELECT * FROM cte);
-- create an index to force non HOT path
SELECT documentdb_api_internal.create_indexes_non_concurrently('pkcursordb', '{"createIndexes": "aggregation_cursor_pk", "indexes": [{"key": {"a": 1}, "name": "a_1" }]}', TRUE);
                                                                                                   create_indexes_non_concurrently                                                                                                    
---------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- create a streaming cursor (that doesn't drain)
CREATE TEMP TABLE firstPageResponse AS
SELECT bson_dollar_project(cursorpage, '{ "cursor.firstBatch._id": 1, "cursor.id": 1 }'), continuation, persistconnection, cursorid FROM
    find_cursor_first_page(database => 'pkcursordb', commandSpec => '{ "find": "aggregation_cursor_pk", "batchSize": 5 }', cursorId => 4294967294);
SELECT * FROM firstPageResponse;
                                                                                                                        bson_dollar_project                                                                                                                        |                                                                                                                                                                                                                                      continuation                                                                                                                                                                                                                                       | persistconnection |  cursorid  
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "4294967294" }, "firstBatch" : [ { "_id" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "2" } }, { "_id" : { "$numberInt" : "3" } }, { "_id" : { "$numberInt" : "4" } } ] } } | { "qi" : { "$numberLong" : "4294967294" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "batchSize" : { "$numberInt" : "5" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAYA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "4" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE } | f                 | 4294967294
(1 row)

-- now drain it
SELECT continuation AS r1_continuation FROM firstPageResponse \gset
SELECT bson_dollar_project(cursorpage, '{ "cursor.nextBatch._id": 1, "cursor.id": 1 }'), continuation FROM
    cursor_get_more(database => 'pkcursordb', getMoreSpec => '{ "collection": "aggregation_cursor_pk", "getMore": 4294967294, "batchSize": 6 }', continuationSpec => :'r1_continuation');
                                                                                                                   bson_dollar_project                                                                                                                   | continuation 
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "nextBatch" : [ { "_id" : { "$numberInt" : "5" } }, { "_id" : { "$numberInt" : "6" } }, { "_id" : { "$numberInt" : "7" } }, { "_id" : { "$numberInt" : "8" } }, { "_id" : { "$numberInt" : "9" } } ] } } | 
(1 row)

-- drain with batchsize of 1 - continuation _ids should increase until it drains: uses pk scan continuation tokens
EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "batchSize": 2 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 1 }');
                                                                                                          cursorpage                                                                                                           |                                                                                                                                                                                                                                                            continuation                                                                                                                                                                                                                                                             
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "1" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAkA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "1" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "2" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAgA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "2" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "3" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAcA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "3" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "4" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAYA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "4" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "5" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "6" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "6" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "7" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "8" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "8" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "9" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                        | 
(9 rows)

-- drain with batchsize of 1 - with the GUC disabled, it should be returned in reverse (TID) order
set documentdb.enablePrimaryKeyCursorScan to off;
EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "batchSize": 2 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 1 }');
                                                                                                          cursorpage                                                                                                           |                                                                                                                                                                                                                         continuation                                                                                                                                                                                                                         
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "9" } }, { "_id" : { "$numberInt" : "8" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "6" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "4" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAYA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "3" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAcA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "2" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAgA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "1" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                      | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAkA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "0" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                        | 
(9 rows)

set documentdb.enablePrimaryKeyCursorScan to on;
-- the query honors filters in continuations.
EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": 3, "$lt": 8 }}, "batchSize": 1 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 1 }');
                                                                                        cursorpage                                                                                         |                                                                                                                                                                                                                                                                                                          continuation                                                                                                                                                                                                                                                                                                          
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "4" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "1" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAYA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "4" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "1" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "5" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "6" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "1" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "6" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }    | 
(4 rows)

-- if a query picks a pk index scan on the first page, the second page is guaranteed to pick it:
DROP TABLE firstPageResponse;
CREATE TEMP TABLE firstPageResponse AS
SELECT bson_dollar_project(cursorpage, '{ "cursor.firstBatch._id": 1, "cursor.id": 1 }'), continuation, persistconnection, cursorid FROM
    find_cursor_first_page(database => 'pkcursordb', commandSpec => '{ "find": "aggregation_cursor_pk",  "projection": { "_id": 1 }, "filter": { "_id": { "$gt": 3, "$lt": 8 }}, "batchSize": 2 }', cursorId => 4294967294);
SELECT * FROM firstPageResponse;
                                                                  bson_dollar_project                                                                  |                                                                                                                                                                                                                                                                                                             continuation                                                                                                                                                                                                                                                                                                              | persistconnection |  cursorid  
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "4294967294" }, "firstBatch" : [ { "_id" : { "$numberInt" : "4" } }, { "_id" : { "$numberInt" : "5" } } ] } } | { "qi" : { "$numberLong" : "4294967294" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "5" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE } | f                 | 4294967294
(1 row)

-- disable these to ensure we pick seqscan as the default path.
set enable_indexscan to off;
set enable_bitmapscan to off;
-- now drain it partially
SELECT continuation AS r1_continuation FROM firstPageResponse \gset
SELECT bson_dollar_project(cursorpage, '{ "cursor.nextBatch._id": 1, "cursor.id": 1 }'), continuation FROM
    cursor_get_more(database => 'pkcursordb', getMoreSpec => '{ "collection": "aggregation_cursor_pk", "getMore": 4294967294, "batchSize": 1 }', continuationSpec => :'r1_continuation');
                                               bson_dollar_project                                                |                                                                                                                                                                                                                                                                                                             continuation                                                                                                                                                                                                                                                                                                              
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "4294967294" }, "nextBatch" : [ { "_id" : { "$numberInt" : "6" } } ] } } | { "qi" : { "$numberLong" : "4294967294" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "6" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
(1 row)

-- drain it fully
SELECT bson_dollar_project(cursorpage, '{ "cursor.nextBatch._id": 1, "cursor.id": 1 }'), continuation FROM
    cursor_get_more(database => 'pkcursordb', getMoreSpec => '{ "collection": "aggregation_cursor_pk", "getMore": 4294967294, "batchSize": 5 }', continuationSpec => :'r1_continuation');
                                                             bson_dollar_project                                                             | continuation 
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "0" }, "nextBatch" : [ { "_id" : { "$numberInt" : "6" } }, { "_id" : { "$numberInt" : "7" } } ] } } | 
(1 row)

-- explain the first query (should be an index scan on the pk index)
set documentdb.enableCursorsOnAggregationQueryRewrite to on;
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": 3, "$lt": 8 }}, "batchSize": 1 }');
                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (DocumentDBApiScan)
   Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" } }'::bson, '{ "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson), documentdb_api_internal.current_cursor_state(document)
   ->  Index Scan using _id_ on documentdb_data.documents_401_40002 collection
         Output: shard_key_value, object_id, document
         Filter: ((collection.document @> '{ "_id" : { "$numberInt" : "3" } }'::bson) AND (collection.document @< '{ "_id" : { "$numberInt" : "8" } }'::bson) AND (collection.object_id > '{ "" : { "$numberInt" : "3" } }'::bson) AND (collection.object_id <= '{ "" : { "$numberDouble" : "Infinity" } }'::bson) AND (collection.object_id < '{ "" : { "$numberInt" : "8" } }'::bson) AND (collection.object_id >= '{ "" : { "$numberDouble" : "-Infinity" } }'::bson) AND documentdb_api_internal.cursor_state(collection.document, '{ }'::bson))
(5 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "batchSize": 1 }');
                                                                                                                          QUERY PLAN                                                                                                                          
---------------------------------------------------------------------
 Custom Scan (DocumentDBApiScan)
   Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" } }'::bson, '{ }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson), documentdb_api_internal.current_cursor_state(document)
   ->  Index Scan using _id_ on documentdb_data.documents_401_40002 collection
         Output: shard_key_value, object_id, document
         Filter: documentdb_api_internal.cursor_state(collection.document, '{ }'::bson)
(5 rows)

-- the getmore should still work and use the _id index
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_getmore('pkcursordb',
    '{ "getMore": { "$numberLong": "4294967294" }, "collection": "aggregation_cursor_pk", "batchSize": 1 }', :'r1_continuation');
                                                                                                                                                                                                                          QUERY PLAN                                                                                                                                                                                                                          
---------------------------------------------------------------------
 Custom Scan (DocumentDBApiScan)
   Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" } }'::bson, '{ "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson), documentdb_api_internal.current_cursor_state(document)
   Page Row Count: 2 rows
   Page Size Hint: 16777216 bytes
   Continuation: { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } }, "pk" : [ 401, { "" : 5 } ] }
   ->  Index Scan using _id_ on documentdb_data.documents_401_40002 collection
         Output: shard_key_value, object_id, document
         Index Cond: ((ROW(collection.shard_key_value, collection.object_id) > ROW('401'::bigint, '{ "" : { "$numberInt" : "5" } }'::bson)) AND (collection.object_id > '{ "" : { "$numberInt" : "3" } }'::bson) AND (collection.object_id <= '{ "" : { "$numberDouble" : "Infinity" } }'::bson) AND (collection.object_id < '{ "" : { "$numberInt" : "8" } }'::bson) AND (collection.object_id >= '{ "" : { "$numberDouble" : "-Infinity" } }'::bson))
         Filter: documentdb_api_internal.cursor_state(collection.document, '{ "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "5" } } ] } ], "getpage_batchCount" : { "$numberInt" : "2" }, "getpage_batchSizeHint" : { "$numberInt" : "16777216" }, "getpage_batchSizeAttr" : { "$numberInt" : "1" } }'::bson)
(9 rows)

set enable_indexscan to on;
set enable_bitmapscan to on;
set enable_seqscan to off;
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": 3, "$lt": 8 }}, "batchSize": 1 }');
                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                   
---------------------------------------------------------------------
 Custom Scan (DocumentDBApiScan)
   Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" } }'::bson, '{ "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson), documentdb_api_internal.current_cursor_state(document)
   ->  Index Scan using _id_ on documentdb_data.documents_401_40002 collection
         Output: shard_key_value, object_id, document
         Index Cond: ((collection.shard_key_value = '401'::bigint) AND (collection.object_id > '{ "" : { "$numberInt" : "3" } }'::bson) AND (collection.object_id <= '{ "" : { "$numberDouble" : "Infinity" } }'::bson) AND (collection.object_id < '{ "" : { "$numberInt" : "8" } }'::bson) AND (collection.object_id >= '{ "" : { "$numberDouble" : "-Infinity" } }'::bson))
         Filter: documentdb_api_internal.cursor_state(collection.document, '{ }'::bson)
(6 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('pkcursordb', '{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "batchSize": 1 }');
                                                                                                                          QUERY PLAN                                                                                                                          
---------------------------------------------------------------------
 Custom Scan (DocumentDBApiScan)
   Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" } }'::bson, '{ }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson), documentdb_api_internal.current_cursor_state(document)
   ->  Index Scan using _id_ on documentdb_data.documents_401_40002 collection
         Output: shard_key_value, object_id, document
         Index Cond: (collection.shard_key_value = '401'::bigint)
         Filter: documentdb_api_internal.cursor_state(collection.document, '{ }'::bson)
(6 rows)

-- the getmore should still work and use the _id index
EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_getmore('pkcursordb',
    '{ "getMore": { "$numberLong": "4294967294" }, "collection": "aggregation_cursor_pk", "batchSize": 1 }', :'r1_continuation');
                                                                                                                                                                                                                          QUERY PLAN                                                                                                                                                                                                                          
---------------------------------------------------------------------
 Custom Scan (DocumentDBApiScan)
   Output: documentdb_api_internal.bson_dollar_project_find(document, '{ "_id" : { "$numberInt" : "1" } }'::bson, '{ "_id" : { "$gt" : { "$numberInt" : "3" }, "$lt" : { "$numberInt" : "8" } } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson), documentdb_api_internal.current_cursor_state(document)
   Page Row Count: 2 rows
   Page Size Hint: 16777216 bytes
   Continuation: { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } }, "pk" : [ 401, { "" : 5 } ] }
   ->  Index Scan using _id_ on documentdb_data.documents_401_40002 collection
         Output: shard_key_value, object_id, document
         Index Cond: ((ROW(collection.shard_key_value, collection.object_id) > ROW('401'::bigint, '{ "" : { "$numberInt" : "5" } }'::bson)) AND (collection.object_id > '{ "" : { "$numberInt" : "3" } }'::bson) AND (collection.object_id <= '{ "" : { "$numberDouble" : "Infinity" } }'::bson) AND (collection.object_id < '{ "" : { "$numberInt" : "8" } }'::bson) AND (collection.object_id >= '{ "" : { "$numberDouble" : "-Infinity" } }'::bson))
         Filter: documentdb_api_internal.cursor_state(collection.document, '{ "continuation" : [ { "table_name" : "documents_401_40002", "value" : { "$binary" : { "base64" : "AAAAAAUA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "401" }, { "" : { "$numberInt" : "5" } } ] } ], "getpage_batchCount" : { "$numberInt" : "2" }, "getpage_batchSizeHint" : { "$numberInt" : "16777216" }, "getpage_batchSizeAttr" : { "$numberInt" : "1" } }'::bson)
(9 rows)

-- shard the collection
SELECT documentdb_api.shard_collection('{ "shardCollection": "pkcursordb.aggregation_cursor_pk", "key": { "_id": "hashed" }, "numInitialChunks": 3 }');
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- now this walks in order of shard-key THEN _id.
BEGIN;
set local enable_seqscan to on;
set local enable_indexscan to off;
set local enable_bitmapscan to off;
set local documentdb.enablePrimaryKeyCursorScan to on;
set local citus.max_adaptive_executor_pool_size to 1;
EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "batchSize": 2 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 2 }');
                                                                                                          cursorpage                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                            continuation                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "8" } }, { "_id" : { "$numberInt" : "3" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-4918719581749358852" }, { "" : { "$numberInt" : "3" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "2" } }, { "_id" : { "$numberInt" : "6" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-26336680357580367" }, { "" : { "$numberInt" : "6" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "4" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "4004935074940511305" }, { "" : { "$numberInt" : "4" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "9" } }, { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40006", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "1786987034919379147" }, { "" : { "$numberInt" : "5" } } ] }, { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "4004935074940511305" }, { "" : { "$numberInt" : "4" } } ] }, { "table_name" : "documents_401_40005", "value" : { "$binary" : { "base64" : "AAAAAAEA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "6185573426042503808" }, { "" : { "$numberInt" : "9" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }    | 
(5 rows)

-- continues to work with filters
EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": 2, "$lt": 8 } }, "batchSize": 2 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 2 }');
                                                                                                          cursorpage                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                      continuation                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "3" } }, { "_id" : { "$numberInt" : "6" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "2" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-26336680357580367" }, { "" : { "$numberInt" : "6" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "4" } }, { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "2" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40006", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "1786987034919379147" }, { "" : { "$numberInt" : "5" } } ] }, { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "4004935074940511305" }, { "" : { "$numberInt" : "4" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                        | 
(3 rows)

ROLLBACK;
BEGIN;
set local documentdb.enablePrimaryKeyCursorScan to on;
set local citus.max_adaptive_executor_pool_size to 1;
EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "batchSize": 2 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 2 }');
                                                                                                          cursorpage                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                            continuation                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "8" } }, { "_id" : { "$numberInt" : "3" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-4918719581749358852" }, { "" : { "$numberInt" : "3" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "2" } }, { "_id" : { "$numberInt" : "6" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "-26336680357580367" }, { "" : { "$numberInt" : "6" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "0" } }, { "_id" : { "$numberInt" : "4" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "4004935074940511305" }, { "" : { "$numberInt" : "4" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "9" } }, { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40006", "value" : { "$binary" : { "base64" : "AAAAAAIA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "1786987034919379147" }, { "" : { "$numberInt" : "5" } } ] }, { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "4004935074940511305" }, { "" : { "$numberInt" : "4" } } ] }, { "table_name" : "documents_401_40005", "value" : { "$binary" : { "base64" : "AAAAAAEA", "subType" : "00" } }, "pk" : [ { "$numberLong" : "6185573426042503808" }, { "" : { "$numberInt" : "9" } } ] } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "1" } }, { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }    | 
(5 rows)

-- continues to work with filters
EXECUTE drain_find_query('{ "find": "aggregation_cursor_pk", "projection": { "_id": 1 }, "filter": { "_id": { "$gt": 2, "$lt": 8 } }, "batchSize": 2 }', '{ "getMore": { "$numberLong": "534" }, "collection": "aggregation_cursor_pk", "batchSize": 2 }');
                                                                                                          cursorpage                                                                                                           |                                                                                                                                                                                                                                                                                                                               continuation                                                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "firstBatch" : [ { "_id" : { "$numberInt" : "6" } }, { "_id" : { "$numberInt" : "4" } } ] }, "ok" : { "$numberDouble" : "1.0" } } | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "2" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAMA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "534" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "3" } }, { "_id" : { "$numberInt" : "7" } } ] }, "ok" : { "$numberDouble" : "1.0" } }  | { "qi" : { "$numberLong" : "534" }, "qp" : false, "qk" : { "$numberInt" : "1" }, "qc" : { "find" : "aggregation_cursor_pk", "projection" : { "_id" : { "$numberInt" : "1" } }, "filter" : { "_id" : { "$gt" : { "$numberInt" : "2" }, "$lt" : { "$numberInt" : "8" } } }, "batchSize" : { "$numberInt" : "2" } }, "continuation" : [ { "table_name" : "documents_401_40006", "value" : { "$binary" : { "base64" : "AAAAAAEA", "subType" : "00" } } }, { "table_name" : "documents_401_40004", "value" : { "$binary" : { "base64" : "AAAAAAQA", "subType" : "00" } } } ], "numIters" : { "$numberInt" : "1" }, "sn" : NOW_SYS_VARIABLE }
 { "cursor" : { "id" : { "$numberLong" : "0" }, "ns" : "pkcursordb.aggregation_cursor_pk", "nextBatch" : [ { "_id" : { "$numberInt" : "5" } } ] }, "ok" : { "$numberDouble" : "1.0" } }                                        | 
(3 rows)

ROLLBACK;
