# Define a build argument to choose architecture
ARG BASE_ARCH=AMD64
ARG BASE_VERSION=0.104.0

# Define the base image dynamically
FROM ghcr.io/microsoft/documentdb/documentdb-oss:ubuntu22.04-PG17-${BASE_ARCH}-${BASE_VERSION} AS stage

# Install dependencies
RUN sudo apt-get update && \
    sudo apt-get install -y --no-install-recommends \
    jq curl sudo git make build-essential openssl pkg-config libssl-dev software-properties-common \
    && sudo rm -rf /var/lib/apt/lists/*

USER documentdb
WORKDIR /home/documentdb/code

COPY . /home/documentdb/code

RUN /home/documentdb/code/scripts/install_llvm.sh

# Install rustup (which includes rustc and cargo) in user directory
ENV RUSTUP_HOME=/home/documentdb/code/.rustup
ENV CARGO_HOME=/home/documentdb/code/.cargo
RUN mkdir -p $RUSTUP_HOME && mkdir -p $CARGO_HOME
ENV PATH=$PATH:$CARGO_HOME/bin

RUN /home/documentdb/code/scripts/install_rustup.sh --install-toolchain

RUN sudo chown -R documentdb:documentdb /home/documentdb/code

WORKDIR /home/documentdb/code/pg_documentdb_gw

RUN CARGO_MANIFEST_DIR=/home/documentdb/code/pg_documentdb_gw cargo build --profile=release-with-symbols

#------------------------------------------------------------------------------------------------

# Same logic for the final image
ARG BASE_ARCH=AMD64
ARG BASE_VERSION=0.104.0
FROM ghcr.io/microsoft/documentdb/documentdb-oss:ubuntu22.04-PG17-${BASE_ARCH}-${BASE_VERSION} AS final

# Set postgres user and group to desired UID/GID
RUN sudo groupmod -g 103 postgres && sudo usermod -u 105 -g 103 postgres

RUN sudo apt-get update && \
    sudo apt-get install -y --no-install-recommends \
    jq openssl lsof wget gnupg netcat-openbsd && \
    sudo apt-get upgrade -y && \
    sudo rm -rf /var/lib/apt/lists/*

RUN wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | sudo apt-key add - && \
    echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list && \
    sudo apt-get update && \
    sudo apt-get install -y mongodb-mongosh && \
    sudo apt-get clean && \
    sudo rm -rf /var/lib/apt/lists/*

ENV LANGUAGE=en_US.UTF-8 \
    TERM=xterm-256color

ENV CERT_PATH="" \
    KEY_FILE="" \
    DATA_PATH="/data" \
    DOCUMENTDB_PORT="10260" \
    ENABLE_TELEMETRY="false" \
    LOG_LEVEL="info" \
    USERNAME="default_user" \
    CREATE_USER="true" \
    START_POSTGRESQL="true" \
    POSTGRESQL_PORT="9712" \
    OWNER="documentdb" \
    ALLOW_EXTERNAL_CONNECTIONS="false" \
    INIT_DATA="true" \
    INIT_DATA_PATH="/init_doc_db.d" \
    PATH=/usr/lib/postgresql/16/bin:$PATH

RUN sudo mkdir /home/documentdb/gateway

# Create /var/run/postgresql directory with proper permissions
RUN sudo mkdir -p /var/run/postgresql && \
    sudo chown -R documentdb:documentdb /var/run/postgresql && \
    sudo chmod 755 /var/run/postgresql
    
COPY --from=stage /home/documentdb/code/pg_documentdb_gw/target/release-with-symbols/documentdb_gateway \
                  /home/documentdb/gateway/pg_documentdb_gw/target/release-with-symbols/documentdb_gateway
COPY --from=stage /home/documentdb/code/pg_documentdb_gw/SetupConfiguration.json /home/documentdb/gateway/pg_documentdb_gw/SetupConfiguration.json
COPY --from=stage /home/documentdb/code/scripts/start_oss_server.sh /home/documentdb/gateway/scripts/start_oss_server.sh
COPY --from=stage /home/documentdb/code/scripts/build_and_start_gateway.sh /home/documentdb/gateway/scripts/build_and_start_gateway.sh
COPY --from=stage /home/documentdb/code/scripts/emulator_entrypoint.sh /home/documentdb/gateway/scripts/emulator_entrypoint.sh
COPY --from=stage /home/documentdb/code/scripts/utils.sh /home/documentdb/gateway/scripts/utils.sh
COPY --from=stage /home/documentdb/code/scripts/setup_psqlrc.sh /home/documentdb/gateway/scripts/setup_psqlrc.sh

# Copy initialization scripts
COPY --from=stage /home/documentdb/code/scripts/init_documentdb_data.sh /home/documentdb/gateway/scripts/init_documentdb_data.sh

# Copy sample data for built-in initialization
COPY --from=stage /home/documentdb/code/sample-data /home/documentdb/gateway/sample-data

# Create default initialization directory for user-provided scripts
RUN sudo mkdir -p /init_doc_db.d

RUN sudo chown -R documentdb:documentdb /home/documentdb/gateway

# Make initialization script executable
RUN sudo chmod +x /home/documentdb/gateway/scripts/init_documentdb_data.sh

WORKDIR /home/documentdb/gateway/scripts
ENTRYPOINT ["/bin/bash", "-c", "/home/documentdb/gateway/scripts/emulator_entrypoint.sh \"$@\"", "--"]
